// ===== タイトル画面と初期化 =====
window.addEventListener("DOMContentLoaded", () => {
  const app = document.getElementById("app");
  const titleScreen = document.getElementById("titleScreen");
  const btnStart = document.getElementById("btnStart");
  const btnContinue = document.getElementById("btnContinue");
  const btnAbout = document.getElementById("btnAbout");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const modal = document.getElementById("researchModal");
  const langSelect = document.getElementById("langSelect");

  // セーブデータ確認
  const hasSave = localStorage.getItem("meai_history");
  if (!hasSave) btnContinue.disabled = true;

  // 言語設定
  langSelect.value = localStorage.getItem("meai_lang") || "ja";
  setLanguage(langSelect.value);
  langSelect.onchange = () => {
    setLanguage(langSelect.value);
    localStorage.setItem("meai_lang", langSelect.value);
  };

  // はじめから
  btnStart.onclick = () => {
    titleScreen.hidden = true;
    app.hidden = false;
    startGame(true);
  };

  // つづきから
  btnContinue.onclick = () => {
    titleScreen.hidden = true;
    app.hidden = false;
    startGame(false);
  };

  // 研究について
  btnAbout.onclick = () => modal.showModal();
  btnCloseModal.onclick = () => modal.close();
});

// ====== ゲーム開始 ======
function startGame(reset = false) {
  const reqText = document.getElementById("reqText");
  const reqPeriod = document.getElementById("reqPeriod");
  const affectionCount = document.getElementById("affectionCount");
  const historyList = document.getElementById("historyList");

  // セーブデータ初期化
  if (reset) {
    localStorage.removeItem("meai_history");
    affectionCount.textContent = "0";
    historyList.innerHTML = "";
  }

  // おねがいを生成
  const request = makeRequest();
  reqText.textContent = request.text;
  reqPeriod.textContent = request.period;
  renderCharacter();

  // 送信処理
  document.getElementById("btnSend").onclick = () => {
    addAffection();
    addHistory(request.text, document.getElementById("replyInput").value);
    reqText.textContent = "次のお願いを考えています...";
    document.getElementById("replyInput").value = "";
    setTimeout(() => {
      const nextReq = makeRequest();
      reqText.textContent = nextReq.text;
      reqPeriod.textContent = nextReq.period;
    }, 1200);
  };

  // CSV出力
  document.getElementById("btnExport").onclick = exportCSV;
}
