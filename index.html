<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI Prototype (start â†’ continue/reset)</title>
<link rel="icon" href="data:,">
<style>
  html, body { height:100%; }
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
    color:#fff;
  }
  .hidden{display:none!important;}
  .glass{ background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.16); border-radius:20px; backdrop-filter:blur(8px); }
  .btn{ display:inline-flex; align-items:center; gap:.5em; border:none; border-radius:999px; padding:12px 18px; cursor:pointer; color:#fff; background:rgba(255,255,255,.18); }
  .btn.primary{ background:linear-gradient(180deg,#ff8bd2,#ff6db3 60%,#ff55a1); color:#231227; }
  .btn:disabled{ opacity:.45; cursor:not-allowed; filter:saturate(.5); }
  .screen{ min-height:100dvh; display:grid; place-items:center; padding:24px; }
  .container{ width:min(92vw, 960px); margin:auto; }
  .cover-card{ text-align:center; padding:28px; border-radius:28px; }
  .cover-illust{ width:180px; height:180px; object-fit:contain; filter:drop-shadow(0 8px 22px rgba(0,0,0,.6)); }
  .cover-title{ font-size:40px; font-weight:800; margin:16px 0 8px; }
  .cover-sub{ opacity:.92; margin:0 0 18px; }
  .grid{ display:flex; flex-wrap:wrap; gap:12px; }
  .char{ width:92px; height:92px; border-radius:50%; border:1px solid rgba(255,255,255,.22); display:grid; place-items:center; background:rgba(255,255,255,.10); cursor:pointer; }
  .char img{ width:70px; height:70px; object-fit:contain; }
  #header{ display:flex; gap:12px; align-items:center; padding:8px 12px; border-radius:999px; margin:10px auto 12px; width:max-content; }
  #chat{ height:min(60vh,460px); overflow:auto; padding:16px; border-radius:16px; }
  .bubble{ max-width:78%; margin:10px 0; padding:12px 16px; border-radius:16px; line-height:1.7; font-size:18px; white-space:pre-wrap; }
  .ai{ background:linear-gradient(145deg, rgba(150,220,255,.28), rgba(150,200,255,.14)); border:1px solid rgba(150,220,255,.34); float:left; clear:both; }
  .user{ background:linear-gradient(145deg, rgba(255,255,255,.26), rgba(255,255,255,.12)); border:1px solid rgba(255,255,255,.28); float:right; clear:both; }
  #composer{ display:flex; gap:8px; margin:10px 0; align-items:center; flex-wrap:wrap; }
  #input{ flex:1; min-width:220px; padding:12px 14px; border:none; border-radius:12px; color:#fff; background:rgba(255,255,255,.14); }
  #footerMenu{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:10px 0 20px; }
  #cooldownNote{ font-size:14px; opacity:.9; min-height:1.2em; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  #rewardsModal, #nameModal, #hubModal, #startModal{
    position:fixed; inset:0; display:none; z-index:1500;
    background: rgba(0,0,0,.45); backdrop-filter: blur(3px);
  }
  .modal-wrap{
    width:min(92vw, 760px); max-height:80vh; overflow:auto;
    background:rgba(15,15,24,.86); border:1px solid rgba(255,255,255,.18);
    border-radius:20px; padding:18px; margin:10vh auto 0; backdrop-filter: blur(10px);
  }

  /* ã”è¤’ç¾UI */
  #rewardToast{ position:fixed; right:16px; bottom:80px; z-index:1300; background:rgba(30,30,40,.85); border:1px solid rgba(255,255,255,.18); padding:12px 14px; border-radius:14px; display:none; max-width:min(80vw,380px); box-shadow:0 10px 30px rgba(0,0,0,.4); backdrop-filter: blur(8px); }
  #rewardToast .ttl{ font-weight:800; margin-bottom:4px; }
  #rewardToast .emo{ font-size:24px; line-height:1; margin-right:6px; }
  .badge{ display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.12); margin:4px; font-size:14px; border:1px solid rgba(255,255,255,.18); }
  .stamps{ display:flex; flex-wrap:wrap; gap:8px; }
  .stamp{ width:44px; height:44px; display:grid; place-items:center; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.18); border-radius:10px; font-size:22px; }
  .list-row{display:flex; gap:10px; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.1);}
  .mono{font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);}

  .langbox{ display:flex; gap:8px; align-items:center; justify-content:center; margin-top:12px; }
  .langbox select{ background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.25); border-radius:10px; padding:6px 10px; font-size:14px; }
</style>
</head>
<body>

<!-- â‘  è¡¨ç´™ -->
<section id="cover" class="screen">
  <div class="container">
    <div class="glass cover-card">
      <img class="cover-illust" src="public/miwacchi_open.png" alt="MeAI cover" onerror="this.src='public/cover.png'">
      <div class="cover-title" id="titleApp">MeAI</div>
      <p class="cover-sub" id="titleLead">å°ã•ãªâ€œã‚„ã£ã¦ã¿ã‚‹â€ã‚’ã€ã‚„ã•ã—ãææ¡ˆã—ã¦ãã‚Œã‚‹ç›¸æ£’ã€‚</p>
      <button id="coverStart" class="btn primary" type="button">â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <div class="langbox">
        <label for="langSelect">ğŸŒ</label>
        <select id="langSelect">
          <option value="ja">æ—¥æœ¬èª</option><option value="en">English</option><option value="zh">ä¸­æ–‡</option><option value="ko">í•œêµ­ì–´</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- â‘¡ åå‰å…¥åŠ›ï¼ˆãƒªã‚»ãƒƒãƒˆæ™‚ã®ã¿ä½¿ç”¨ï¼‰ -->
<section id="askname" class="screen hidden">
  <div class="container glass" style="padding:20px; max-width:720px;">
    <h2 id="lblAskTitle">ã‚ãªãŸã®ãŠåå‰ã‚’æ•™ãˆã¦</h2>
    <p id="lblAskLead" style="opacity:.9">ã‚ã¨ã§å¤‰æ›´ã‚‚ã§ãã¾ã™ã€‚å‘¼ã³ã‹ã‘ã«ä½¿ã„ã¾ã™ã€‚</p>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <input id="userNameInput" class="glass" type="text" placeholder="ãŠãªã¾ãˆâ€¦" style="flex:1; padding:12px 14px; color:#fff;">
      <button id="userNameSave" class="btn primary" type="button">ã¤ãã¸</button>
    </div>
    <div style="margin-top:10px;">
      <button id="userNameSkip" class="btn" type="button">ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚ã¨ã§ï¼‰</button>
    </div>
  </div>
</section>

<!-- â‘¢ ã‚­ãƒ£ãƒ©é¸æŠï¼ˆãƒªã‚»ãƒƒãƒˆæ™‚ã®ã¿ä½¿ç”¨ï¼‰ -->
<section id="choose" class="screen hidden">
  <div class="container glass" style="padding:18px;">
    <h2 style="margin:6px 0 12px;" id="lblChoose">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­</h2>
    <div class="grid" id="charGrid">
      <button class="char" data-char="green" type="button"><img src="public/char/green/calm.png" alt=""></button>
      <button class="char" data-char="blue"  type="button"><img src="public/char/blue/calm.png"  alt=""></button>
      <button class="char" data-char="pink"  type="button"><img src="public/char/pink/calm.png"  alt=""></button>
      <button class="char" data-char="purple"type="button"><img src="public/char/purple/calm.png"alt=""></button>
    </div>
    <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="chooseContinue" class="btn" type="button">å‰ã®ã‚­ãƒ£ãƒ©ã§ã¤ã¥ã</button>
    </div>
  </div>
</section>

<!-- â‘£ ãƒ¡ã‚¤ãƒ³ -->
<section id="main" class="screen hidden">
  <div class="container">
    <div id="header" class="glass">
      <img id="charIcon" src="" alt="" width="30" height="30">
      <div id="heart">â¤ï¸ Ã— <span id="heartCount">0</span></div>
      <div id="charNameBox" style="opacity:.95;"></div>
    </div>

    <div id="chat" class="glass" aria-live="polite"></div>

    <div id="composer">
      <input id="input" class="glass" type="text" placeholder="è¿”ç­”ã‚’å…¥åŠ›â€¦ï¼ˆEnterã§é€ä¿¡ï¼‰" />
      <button id="send" class="btn" type="button">é€ä¿¡</button>
      <button id="done" class="btn" type="button">ã‚„ã£ãŸã‚ˆ</button>
      <div id="cooldownNote"></div>
    </div>

    <div id="footerMenu">
      <button id="toHub" class="btn" type="button">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
      <button id="showLog" class="btn" type="button">ãƒ­ã‚°ã‚’ç¢ºèª</button>
      <button id="rewardsBtn2" class="btn" type="button">ã”è¤’ç¾</button>
      <button id="reset" class="btn" type="button" onclick="localStorage.clear(); location.reload();">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
    </div>
  </div>
</section>

<!-- ã”è¤’ç¾ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç°¡ç•¥ï¼‰ -->
<div id="rewardsModal" aria-modal="true" role="dialog">
  <div class="modal-wrap" tabindex="-1">
    <button class="btn" id="closeRewards" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">Ã—</button>
    <h3 id="lblRewardsTitle">ã”è¤’ç¾ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h3>
    <div id="rewardSummary" class="mono" style="margin:4px 0 10px;opacity:.9;"></div>
    <h4>ã‚¹ã‚¿ãƒ³ãƒ—</h4><div class="stamps" id="stampList"></div>
  </div>
</div>

<!-- ã‚­ãƒ£ãƒ©å‘½åãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="nameModal" aria-modal="true" role="dialog">
  <div class="modal-wrap" tabindex="-1">
    <button class="btn" id="closeName" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">Ã—</button>
    <h3 id="lblNameTitle">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰</h3>
    <p id="lblNameLead">ã”è¤’ç¾ã ã‚ˆã€‚ã‚­ãƒ£ãƒ©ã«åå‰ã‚’ã¤ã‘ã¦ã¿ã‚‹ï¼Ÿï¼ˆã‚ã¨ã§å¤‰æ›´OKï¼‰</p>
    <div style="display:flex; gap:8px; align-items:center; margin:10px 0;">
      <input id="nameInput" class="glass" type="text" placeholder="ãªã¾ãˆâ€¦" style="flex:1; padding:10px 12px; color:#fff;">
      <button id="nameSave" class="btn primary" type="button">ä¿å­˜</button>
    </div>
    <button id="nameSkip" class="btn" type="button">ã‚ã¨ã§</button>
  </div>
</div>

<!-- ãƒãƒ–ï¼ˆå®¹å§¿/è¨˜éŒ²/ç¶šãï¼‰ -->
<div id="hubModal" aria-modal="true" role="dialog">
  <div class="modal-wrap" tabindex="-1" style="max-width:560px;">
    <button class="btn" id="closeHub" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">Ã—</button>
    <h3 id="lblHubTitle">ã©ã“ã‹ã‚‰å†é–‹ã™ã‚‹ï¼Ÿ</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <button id="hubAppearance" class="btn" type="button">å®¹å§¿ï¼ˆã”è¤’ç¾ï¼‰</button>
      <button id="hubRecords" class="btn" type="button">è¨˜éŒ²ï¼ˆãƒ­ã‚°ï¼‰</button>
      <button id="hubContinue" class="btn primary" type="button">ãã®ã¾ã¾ç¶šã</button>
    </div>
  </div>
</div>

<!-- ã‚¹ã‚¿ãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ–°è¦ï¼‰ -->
<div id="startModal" aria-modal="true" role="dialog">
  <div class="modal-wrap" tabindex="-1" style="max-width:560px;">
    <button class="btn" id="closeStart" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">Ã—</button>
    <h3 id="lblStartTitle">ã¯ã˜ã‚ã‚‹</h3>
    <p id="lblStartLead" style="opacity:.9">ç¶šãã‹ã‚‰ or ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <button id="btnContinueStart" class="btn primary" type="button">ç¶šãã‹ã‚‰</button>
      <button id="btnResetStart" class="btn" type="button">ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰</button>
    </div>
    <div id="continueHint" class="mono" style="margin-top:10px; opacity:.8;"></div>
  </div>
</div>

<!-- Toast -->
<div id="rewardToast" role="status" aria-live="polite"></div>

<script>
(function(){
  // ===== i18n =====
  const I18N = {
    ja:{
      app:"MeAI",
      coverLead:"å°ã•ãªâ€œã‚„ã£ã¦ã¿ã‚‹â€ã‚’ã€ã‚„ã•ã—ãææ¡ˆã—ã¦ãã‚Œã‚‹ç›¸æ£’ã€‚",
      askTitle:"ã‚ãªãŸã®ãŠåå‰ã‚’æ•™ãˆã¦",
      askLead:"ã‚ã¨ã§å¤‰æ›´ã‚‚ã§ãã¾ã™ã€‚å‘¼ã³ã‹ã‘ã«ä½¿ã„ã¾ã™ã€‚",
      choose:"ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­",
      chooseContinue:"å‰ã®ã‚­ãƒ£ãƒ©ã§ã¤ã¥ã",
      rewardsTitle:"ã”è¤’ç¾ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³",
      nameTitle:"ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰", nameLead:"ã”è¤’ç¾ã ã‚ˆã€‚ã‚­ãƒ£ãƒ©ã«åå‰ã‚’ã¤ã‘ã¦ã¿ã‚‹ï¼Ÿï¼ˆã‚ã¨ã§å¤‰æ›´OKï¼‰",
      hubTitle:"ã©ã“ã‹ã‚‰å†é–‹ã™ã‚‹ï¼Ÿ",
      startTitle:"ã¯ã˜ã‚ã‚‹",
      startLead:"ç¶šãã‹ã‚‰ or ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
      continueDisabled:"ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
      formatSuggest:(userName, req, charName)=> {
        if(charName){ return `${userName ? userName + "ã•ã‚“ã€" : ""}${req}\nâ€” ${charName}ã‚ˆã‚Š`; }
        return `${userName ? userName + "ã•ã‚“ã€" : ""}${req}`;
      },
      aiAck:"ã†ã‚“ã€ãªã‚‹ã»ã©ã­ã€‚",
      doneLabel:"ã‚„ã£ãŸã‚ˆ",
      laterMsg:(h)=>`ã¾ãŸå¾Œã§ã­ã€‚ç´„${h}æ™‚é–“å¾Œã«æ¬¡ã®ææ¡ˆã‚’é€ã‚‹ã­ã€‚`,
      noteAvail:(s)=>`æ¬¡ã¯${s}å¾Œã«æŠ¼ã›ã‚‹ã‚ˆã€‚`,
      noteReady:"æŠ¼ã›ã‚‹ã‚ˆã†ã«ãªã£ãŸã‚ˆï¼",
      requests:[
        "ãŠã¯ã‚ˆã†ã£ã¦è¨€ã£ã¦ã€‚","ã‚³ãƒƒãƒ—ä¸€æ¯ã®ãŠæ°´ã‚’é£²ã‚“ã§ã¿ã¦ã€‚","5ç§’ã ã‘ã€é™ã‹ã«ç›®ã‚’é–‰ã˜ã¦ã¿ã‚ˆã†ã€‚","ä»Šæ—¥ã®ç©ºã®è‰²ã‚’ã²ã¨ã“ã¨ã§æ•™ãˆã¦ã€‚",
        "çª“ã‚’å°‘ã—é–‹ã‘ã¦ã€ç©ºæ°—ã‚’å…¥ã‚Œæ›¿ãˆã‚ˆã†ã€‚","æ·±å‘¼å¸ã‚’3å›ã—ã¦ã¿ã‚ˆã†ã€‚","å¥½ããªéŸ³ã‚’5ç§’ã ã‘èã‹ã›ã¦ã€‚","èŠ±ã‚„æ¤ç‰©ã‚’ã²ã¨ã¤æ€ã„æµ®ã‹ã¹ã¦ã€åå‰ã‚’æ•™ãˆã¦ã€‚",
        "ä»Šã„ã‚‹éƒ¨å±‹ã§ã€ã‚„ã•ã—ã„è‰²ã‚’æ¢ã—ã¦æ•™ãˆã¦ã€‚","å§¿å‹¢ã‚’ã™ã“ã—ä¼¸ã°ã—ã¦ã€è‚©ã‚’å›ã—ã¦ã¿ã‚ˆã†ã€‚","ã‚«ãƒ¼ãƒ†ãƒ³ã‚’å°‘ã—é–‹ã‘ã¦ã€æ˜ã‚‹ã•ã‚’æ„Ÿã˜ã¦ã¿ã¦ã€‚",
        "ãŠã‚„ã¤ã‹é£²ã¿ç‰©ã‚’ã²ã¨å£ã€å‘³ã‚ã£ã¦ã¿ã‚ˆã†ã€‚","æœºã®ä¸Šã‚’10ç§’ã ã‘æ•´ãˆã¦ã¿ã‚ˆã†ã€‚","ç›®ã®å‰ã®â€œä¸¸ã„å½¢â€ã‚’ã²ã¨ã¤è¦‹ã¤ã‘ã¦æ•™ãˆã¦ã€‚"
      ]
    },
    en:{
      app:"MeAI",
      coverLead:"A gentle buddy that nudges small try-outs.",
      askTitle:"What's your name?",
      askLead:"You can change it later. Used for friendly greetings.",
      choose:"Pick your character",
      chooseContinue:"Continue with previous",
      rewardsTitle:"Rewards Collection",
      nameTitle:"Character name", nameLead:"Reward time! Give your buddy a name? (Change anytime.)",
      hubTitle:"Where to resume?",
      startTitle:"Start",
      startLead:"Choose Continue or Reset.",
      continueDisabled:"No save found. Please use Reset.",
      formatSuggest:(userName, req, charName)=> charName ? `${userName?userName+", ":""}${req}\nâ€” from ${charName}` : `${userName?userName+", ":""}${req}`,
      aiAck:"Got it.", doneLabel:"Done",
      laterMsg:(h)=>`See you later in about ${h} hours.`,
      noteAvail:(s)=>`You can press again in ${s}.`,
      noteReady:"It's available now!",
      requests:["Say good morning to someone.","Drink a glass of water.","Close your eyes for 5 seconds.","Describe todayâ€™s sky color.","Open the window a little.","Take 3 deep breaths."]
    },
    zh:{ app:"MeAI", coverLead:"æ¸©æŸ”çš„å°ä¼™ä¼´ï¼Œè½»è½»æ¨åŠ¨ä½ å°è¯•å°äº‹ã€‚", askTitle:"è¯·å‘Šè¯‰æˆ‘ä½ çš„åå­—", askLead:"ä¹‹åå¯æ›´æ”¹ï¼Œç”¨æ¥å‹å¥½ç§°å‘¼ä½ ã€‚", choose:"è¯·é€‰æ‹©è§’è‰²", chooseContinue:"æ²¿ç”¨ä¸Šæ¬¡çš„è§’è‰²",
      rewardsTitle:"å¥–åŠ±æ”¶è—", nameTitle:"è§’è‰²åå­—", nameLead:"å¥–åŠ±æ—¶é—´ï¼ç»™ä¼™ä¼´èµ·ä¸ªåå­—å§ï¼ˆå¯éšæ—¶ä¿®æ”¹ï¼‰ã€‚",
      hubTitle:"ä»å“ªé‡Œç»§ç»­ï¼Ÿ", startTitle:"å¼€å§‹", startLead:"é€‰æ‹©ç»§ç»­æˆ–é‡ç½®ã€‚", continueDisabled:"æ²¡æœ‰å­˜æ¡£ï¼Œè¯·é€‰æ‹©é‡ç½®ã€‚",
      formatSuggest:(userName, req, charName)=> charName ? `${userName?userName+"ï¼Œ":""}${req}\nâ€” ${charName}` : `${userName?userName+"ï¼Œ":""}${req}`,
      aiAck:"æ˜ç™½äº†ã€‚", doneLabel:"å®Œæˆ", laterMsg:(h)=>`çº¦ ${h} å°æ—¶åå†æé†’ä½ ã€‚`,
      noteAvail:(s)=>`è¿˜éœ€${s}æ‰èƒ½å†æ¬¡æŒ‰ä¸‹ã€‚`, noteReady:"ç°åœ¨å¯ä»¥æŒ‰å•¦ï¼",
      requests:["è·ŸæŸäººè¯´æ—©å®‰ã€‚","å–ä¸€æ¯æ°´ã€‚","é—­çœ¼ 5 ç§’ã€‚","ç”¨ä¸€ä¸ªè¯æè¿°ä»Šå¤©çš„å¤©ç©ºé¢œè‰²ã€‚","çª—æˆ·å¼€ä¸€ç‚¹é€šé£ã€‚","æ·±å‘¼å¸ 3 æ¬¡ã€‚"]
    },
    ko:{ app:"MeAI", coverLead:"ì‘ì€ ì‹œë„ë¥¼ ì‚´ì§ ë°€ì–´ì£¼ëŠ” ë‹¤ì •í•œ ì¹œêµ¬.", askTitle:"ì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”", askLead:"ë‚˜ì¤‘ì— ë°”ê¿€ ìˆ˜ ìˆì–´ìš”. í˜¸ì¹­ì— ì‚¬ìš©í•©ë‹ˆë‹¤.",
      choose:"ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”", chooseContinue:"ì´ì „ ìºë¦­í„°ë¡œ ì´ì–´í•˜ê¸°", rewardsTitle:"ë³´ìƒ ì»¬ë ‰ì…˜",
      nameTitle:"ìºë¦­í„° ì´ë¦„", nameLead:"ë³´ìƒ! íŒŒíŠ¸ë„ˆì—ê²Œ ì´ë¦„ì„ ì§€ì–´ë³¼ê¹Œìš”? (ì–¸ì œë“  ë³€ê²½ ê°€ëŠ¥)",
      hubTitle:"ì–´ë””ì„œ ì¬ê°œí• ê¹Œìš”?", startTitle:"ì‹œì‘", startLead:"ì´ì–´í•˜ê¸° ë˜ëŠ” ì´ˆê¸°í™”ë¥¼ ì„ íƒí•˜ì„¸ìš”.", continueDisabled:"ì„¸ì´ë¸Œê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸°í™”ë¥¼ ì„ íƒí•˜ì„¸ìš”.",
      formatSuggest:(userName, req, charName)=> charName ? `${userName?userName+"ë‹˜, ":""}${req}\nâ€” ${charName} ë“œë¦¼` : `${userName?userName+"ë‹˜, ":""}${req}`,
      aiAck:"ì•Œê² ì–´.", doneLabel:"í–ˆì–´ìš”", laterMsg:(h)=>`${h}ì‹œê°„ í›„ì— ë‹¤ì‹œ ì œì•ˆí• ê²Œìš”.`,
      noteAvail:(s)=>`${s} í›„ì— ë‹¤ì‹œ ëˆ„ë¥¼ ìˆ˜ ìˆì–´ìš”.`, noteReady:"ì´ì œ ëˆŒëŸ¬ë„ ë¼ìš”!",
      requests:["ëˆ„êµ°ê°€ì—ê²Œ â€˜ì¢‹ì€ ì•„ì¹¨â€™.","ë¬¼ í•œ ì”.","ëˆˆ 5ì´ˆ ê°ê¸°.","ì˜¤ëŠ˜ í•˜ëŠ˜ìƒ‰ í•œ ë‹¨ì–´.","ì°½ë¬¸ ì¡°ê¸ˆ ì—´ê¸°.","ì‹¬í˜¸í¡ 3ë²ˆ."]
    }
  };
  const LS_LANG="meai_lang";
  const KEY = {
    char:'meai_character', hearts:'meai_heart', log:'meai_log', next:'meai_next_due',
    rewards:'meai_rewards', milestones:'meai_milestones', charName:'meai_char_name',
    user:'meai_user_name', poolJa:'meai_suggest_pool_ja', poolEn:'meai_suggest_pool_en',
    poolZh:'meai_suggest_pool_zh', poolKo:'meai_suggest_pool_ko'
  };

  // ======= åº§ã£ãŸã¾ã¾ææ¡ˆï¼ˆç•¥ï¼šå…ƒã®ã¾ã¾ï¼‰ =======
  const SUGGEST_GEN = {/* çœç•¥ã›ãšå®šç¾©ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã®ã¾ã¾ï¼‰ */};
  // --- æ—¢å­˜ã® SUGGEST_GEN æœ¬æ–‡ã¯é•·ã„ã®ã§ã€å…ƒã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„ ---
  // â†‘ ã“ã®è¡Œã‹ã‚‰ä¸‹ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…ƒæŠ•ç¨¿ã«ã‚ã‚‹ SUGGEST_GEN / buildSuggestionPool / getPool / nextSuggestion ã‚’ãã®ã¾ã¾æ®‹ã—ã¦ã„ã¾ã™
  const SUGGEST_GEN_COPY = {
    ja: { templates:[
        "{when}{action}ã—ã¦ã¿ã‚ˆã†ã€‚","{when}{action}ã‚’{duration}ã‚„ã£ã¦ã¿ã¦ã€‚","{place}ã§{action}ã—ã¦ã€{report}ã€‚",
        "{count}å›ã ã‘{action}ã—ã¦ã¿ã‚ˆã†ã€‚","{sense}ã«é›†ä¸­ã—ã¦{duration}ã€æ„Ÿã˜ãŸã“ã¨ã‚’{oneword}ã§ã€‚","{pose}ã—ã¦{duration}ã€ãã®ã¾ã¾å‘¼å¸ã‚’{breath}ã€‚",
        "ä»Šæ—¥ã®{theme}ã‚’ã²ã¨ã¤è¦‹ã¤ã‘ã¦ã€{oneword}ã§æ•™ãˆã¦ã€‚","åº§ã£ãŸã¾ã¾ã§{action}ã—ã¦ã¿ã‚ˆã†ã€‚","æ¤…å­ã«åº§ã£ãŸã¾ã¾ã€{sense}ã«é›†ä¸­ã—ã¦ã¿ã¦ã€‚",
        "æ‰‹ã ã‘å‹•ã‹ã—ã¦{action}ã‚’{count}å›ã—ã¦ã¿ã‚ˆã†ã€‚","éŸ³ã‚’ç«‹ã¦ãšã«{action}ã—ã¦ã¿ã‚ˆã†ã€‚","é™ã‹ã«ã§ãã‚‹{action}ã‚’{duration}ã‚„ã£ã¦ã¿ã¦ã€‚","åº§ã£ãŸã¾ã¾ã§ã§ãã‚‹{smallTask}ã‚’ã²ã¨ã¤ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚"
      ],
      lexicon:{ when:["ã„ã¾","ã“ã®ã‚ã¨","ã²ã¨æ¯ã¤ã„ãŸã‚‰","ä¼‘æ†©ã®å‰ã«","ç«‹ã¡ä¸ŠãŒã£ãŸã¤ã„ã§ã«"], action:["æ·±å‘¼å¸","èƒŒä¼¸ã³","ç›®ã‚’é–‰ã˜ã‚‹","æ‰‹ã®ã²ã‚‰ã‚’æ¸©ã‚ã‚‹","è‚©ã‚’å›ã™","æŒ‡ã‚’ã‚†ã£ãã‚Šé–‹ã","æ‰‹é¦–ã‚’ã¾ã‚ã™","ã‚³ãƒƒãƒ—ã®æ°´ã‚’é£²ã‚€","å°ã•ãé¦–ã‚’å›ã™","è‚©ã‚’ä¸Šã’ã¦ã‚¹ãƒˆãƒ³ã¨ä¸‹ã‚ã™","å§¿å‹¢ã‚’æ­£ã™"],
        duration:["5ç§’","10ç§’","15ç§’","30ç§’"], place:["çª“ã®è¿‘ã","æ¤…å­ã®ä¸Š","ãƒ‡ã‚¹ã‚¯ã®å‰","ã„ã¤ã‚‚ã®å¸­","ãƒ‘ã‚½ã‚³ãƒ³ã®å‰"],
        report:["ã²ã¨è¨€ã§æ•™ãˆã¦","è‰²ã§æ•™ãˆã¦","å¤©æ°—ã«ä¾‹ãˆã¦æ•™ãˆã¦","çµµæ–‡å­—ã²ã¨ã¤ã§æ•™ãˆã¦"], count:["3","5","7"], sense:["éŸ³","å…‰","æ‰‹è§¦ã‚Š","æ¸©åº¦","åŒ‚ã„"], oneword:["ã²ã¨è¨€","ä¸€èª","ä¸€æ–‡å­—"],
        pose:["å§¿å‹¢ã‚’æ­£ã—ã","è‚©ã‚’å¾Œã‚ã«å¼•ã„ã¦","é¦–ã‚’ã‚†ã£ãã‚Šå›ã—ã¦","ç›®ç·šã‚’é ãã¸"], breath:["3å›","4å›","5å›"], theme:["ã‚„ã•ã—ã„è‰²","ã¾ã‚‹ã„å½¢","å¿ƒåœ°ã‚ˆã„éŸ³","è½ã¡ç€ãã‚‚ã®","å¥½ããªé¦™ã‚Š"],
        smallTask:["æ·±å‘¼å¸","é¦–ã®ã‚¹ãƒˆãƒ¬ãƒƒãƒ","æ‰‹ã‚’çµ„ã‚“ã§ä¼¸ã°ã™","è‚©ã‚’è»½ãã¾ã‚ã™","ç›®ã‚’é–‰ã˜ã¦3ç§’ä¼‘ã‚€","ä¸¡æ‰‹ã‚’ã“ã™ã£ã¦æ¸©ã‚ã‚‹","æ‰‹ã‚’ã‚°ãƒ¼ãƒ‘ãƒ¼ã—ã¦ã¿ã‚‹","ä¸€åº¦ã ã‘ä¼¸ã³ã‚’ã™ã‚‹"] } },
    en:{ templates:["{when} try {action}.","For {duration}, {action} and then share {report}.","At {place}, {action} and describe it in {oneword}.","Do {action} {count} times.","Focus on {sense} for {duration} and summarize in {oneword}.","While sitting, try {action}.","Stay seated and focus on your {sense} for {duration}.","Move only your hands and {action} {count} times.","Quietly {action} for {duration}.","Pick one thing you can do while sitting and {smallTask}."],
      lexicon:{ when:["Now","After this","Before a break","While seated","During a short pause"], action:["take a deep breath","stretch your shoulders","close your eyes","rub your hands together","roll your wrists","drink some water","relax your neck","sit up straight"],
        duration:["5s","10s","15s","30s"], place:["by the window","at your desk","while sitting","in your chair"], report:["in one word","as a color","as weather","with one emoji"], count:["3","5","7"], sense:["sound","light","touch","temperature","smell"], oneword:["one word","a word","one letter"], smallTask:["take a deep breath","open and close your hands","roll your shoulders","rub your palms together","stretch your fingers"] } }
  };
  function buildSuggestionPool(lang, max = 240){
    const base = (I18N[lang]?.requests || I18N.ja.requests || []).slice();
    const conf = SUGGEST_GEN_COPY[lang] || SUGGEST_GEN_COPY.ja;
    const makeOne = ()=> conf.templates[Math.floor(Math.random()*conf.templates.length)]
      .replace(/\{(\w+)\}/g, (_,k)=> {
        const bag = conf.lexicon[k] || [];
        return bag.length ? bag[Math.floor(Math.random()*bag.length)] : "";
      });
    const set = new Set(base);
    while(set.size < Math.max(base.length + 60, max)){
      set.add(makeOne());
      if(set.size>2000) break;
    }
    return Array.from(set);
  }
  function poolKey(lang){ return ({ja:KEY.poolJa,en:KEY.poolEn,zh:KEY.poolZh,ko:KEY.poolKo}[lang]) || KEY.poolJa; }
  function getPool(lang){
    try{ const raw=localStorage.getItem(poolKey(lang)); if(raw) return JSON.parse(raw); }catch{}
    const pool = buildSuggestionPool(lang);
    try{ localStorage.setItem(poolKey(lang), JSON.stringify(pool)); }catch{}
    return pool;
  }
  function nextSuggestion(lang){
    const pool=getPool(lang);
    if(!pool.length) return (I18N[lang]?.requests || I18N.ja.requests)[0] || "æ·±å‘¼å¸ã—ã¦ã¿ã‚ˆã†ã€‚";
    const s=pool.shift(); pool.push(s);
    try{ localStorage.setItem(poolKey(lang), JSON.stringify(pool)); }catch{}
    return s;
  }

  // ===== DOM util
  const $=(s,root=document)=>root.querySelector(s);
  const on=(el,ev,fn,opt)=>{ if(el) el.addEventListener(ev,fn,opt||false); };
  const t = ()=> I18N[localStorage.getItem(LS_LANG)||"ja"] || I18N.ja;

  // ===== elements
  const langSelect=$('#langSelect');
  const scr={cover:$('#cover'), askname:$('#askname'), choose:$('#choose'), main:$('#main')};
  const userNameInput=$('#userNameInput'), userNameSave=$('#userNameSave'), userNameSkip=$('#userNameSkip');
  const lblAskTitle=$('#lblAskTitle'), lblAskLead=$('#lblAskLead');

  const chooseGrid=$('#charGrid'), chooseContinue=$('#chooseContinue');

  const chat=$('#chat'), input=$('#input'), btnSend=$('#send'), btnDone=$('#done'), cooldownNote=$('#cooldownNote');
  const charIcon=$('#charIcon'), heartCountEl=$('#heartCount'), charNameBox=$('#charNameBox');

  const rewardsModal=$('#rewardsModal'), closeRewards=$('#closeRewards');
  const rewardSummary=$('#rewardSummary'), stampList=$('#stampList');
  const rewardToast=$('#rewardToast');

  const nameModal=$('#nameModal'), nameInput=$('#nameInput'), nameSave=$('#nameSave'), nameSkip=$('#nameSkip'), closeName=$('#closeName');

  const hubModal=$('#hubModal'), closeHub=$('#closeHub'), hubAppearance=$('#hubAppearance'), hubRecords=$('#hubRecords'), hubContinue=$('#hubContinue');

  // æ–°è¦: ã‚¹ã‚¿ãƒ¼ãƒˆé¸æŠ
  const startModal=$('#startModal'), closeStart=$('#closeStart'), btnContinueStart=$('#btnContinueStart'), btnResetStart=$('#btnResetStart'), continueHint=$('#continueHint');
  const startTitle=$('#lblStartTitle'), startLead=$('#lblStartLead');

  // ===== state
  let hearts    = toInt(get(KEY.hearts),0);
  let log       = toArray(get(KEY.log),[]);
  let nextTimer=null, labelTimer=null, guard=false;

  // ===== helpers
  function show(id){ Object.values(scr).forEach(el=>el&&el.classList.add('hidden')); scr[id]?.classList.remove('hidden'); }
  function get(k){ try{return localStorage.getItem(k)}catch{return null} }
  function set(k,v){ try{localStorage.setItem(k,v)}catch{} }
  function del(k){ try{localStorage.removeItem(k)}catch{} }
  function toInt(v,d=0){ const n=parseInt(v,10); return Number.isFinite(n)?n:d; }
  function toArray(raw,f=[]){ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return Array.isArray(v)?v:f }catch{ return f } }
  function hasSave(){
    const char=get(KEY.char), lg=get(KEY.log);
    try{
      const arr = JSON.parse(lg||'[]');
      return !!char || (Array.isArray(arr)&&arr.length>0);
    }catch{ return !!get(KEY.char); }
  }
  function clearProgressKeepPrefs(){
    // é€²è¡Œç³»ã®ã¿æ¶ˆå»ï¼ˆè¨€èªãƒ»ææ¡ˆãƒ—ãƒ¼ãƒ«ã¯æ®‹ã™ï¼‰
    [KEY.hearts, KEY.log, KEY.next, KEY.rewards, KEY.milestones, KEY.charName, KEY.char].forEach(del);
  }

  function applyLang(){
    const T=t();
    $('#titleApp').textContent=T.app;
    $('#titleLead').textContent=T.coverLead;
    $('#lblChoose').textContent=T.choose;
    $('#lblRewardsTitle').textContent=T.rewardsTitle;
    $('#lblNameTitle').textContent=T.nameTitle;
    $('#lblNameLead').textContent=T.nameLead;
    $('#lblHubTitle').textContent=T.hubTitle;
    lblAskTitle.textContent=T.askTitle;
    lblAskLead.textContent=T.askLead;

    // start modal texts
    startTitle.textContent = T.startTitle || "ã¯ã˜ã‚ã‚‹";
    startLead.textContent  = T.startLead  || "ç¶šãã‹ã‚‰ or ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
    continueHint.textContent = "";

    chooseContinue.textContent=T.chooseContinue;
    btnDone.textContent=T.doneLabel;
    $('#send').textContent = (T===I18N.ja? "é€ä¿¡": T===I18N.en? "Send": T===I18N.zh? "å‘é€":"ë³´ë‚´ê¸°");

    // ç¶šããƒœã‚¿ãƒ³ã®æ´»æ€§æ›´æ–°
    btnContinueStart.disabled = !hasSave();
    if(!hasSave()) continueHint.textContent = T.continueDisabled || "ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
  }

  // ----- chat
  function append(sender,text){ const d=document.createElement('div'); d.className='bubble '+sender; d.textContent=text; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
  function push(sender,text){ const item={sender,text,ts:Date.now()}; log.push(item); append(sender,text); saveAll(); }
  function saveAll(){ set(KEY.hearts,String(hearts)); set(KEY.log,JSON.stringify(log)); }

  function pickRequest(){ const lang = localStorage.getItem(LS_LANG) || "ja"; return nextSuggestion(lang); }
  function formatSuggest(){
    const userName = get(KEY.user)||"";
    const charName = get(KEY.charName)||"";
    const req = pickRequest();
    return t().formatSuggest(userName, req, charName);
  }

  // ===== rewards (ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿)
  const STICKER_POOL=["â­","ğŸŒ™","ğŸŒˆ","ğŸ’","ğŸ«§","ğŸŒ¸","ğŸ€","ğŸ”¥","â„ï¸","ğŸµ","âœ¨","ğŸ","â˜•","ğŸ“š","ğŸ§¡"];
  function grantSticker(){
    const emo = STICKER_POOL[Math.floor(Math.random()*STICKER_POOL.length)];
    const r = toObj(get(KEY.rewards), {stamps:[]}); r.stamps??=[];
    r.stamps.push({emo,ts:Date.now()}); set(KEY.rewards,JSON.stringify(r));
    rewardSummary.textContent = `ãƒãƒ¼ãƒˆï¼š${hearts}ã€€ã‚¹ã‚¿ãƒ³ãƒ—ï¼š${r.stamps.length}`;
    renderStamps(r.stamps); toast(`<span class="emo">${emo}</span>Get!`);
  }
  function toObj(raw,f={}){ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return (v && typeof v==='object')?v:f }catch{ return f } }
  function renderStamps(list){ stampList.innerHTML=''; list.slice(-100).forEach(s=>{ const d=document.createElement('div'); d.className='stamp'; d.textContent=s.emo; stampList.appendChild(d); }); }
  function toast(html){ rewardToast.innerHTML=html; rewardToast.style.display='block'; setTimeout(()=> rewardToast.style.display='none', 3000); }

  // ===== cooldown è¡¨ç¤º/ç®¡ç†
  function canDoneNow(){ const due=toInt(get(KEY.next),0); return !due||due<=Date.now(); }
  function countdown(ms){
    if(ms<=0) return "";
    const s=Math.ceil(ms/1000);
    if(s<60) return `${s}ç§’`;
    const m=Math.ceil(s/60);
    if(m<60) return `${m}åˆ†`;
    const h=Math.floor(m/60), mm=m%60; return mm?`${h}æ™‚é–“${mm}åˆ†`:`${h}æ™‚é–“`;
  }
  function setNextAfterHours(h){
    const due=Date.now()+Math.round(h*3600*1000);
    set(KEY.next,String(due));
    updateDoneState();
    startNextTimer();
    startLabelTimer();
  }
  function updateCooldownNote(){
    const due=toInt(get(KEY.next),0);
    if(!due){ cooldownNote.textContent=""; return; }
    const remain = due - Date.now();
    if(remain<=0){ cooldownNote.textContent = t().noteReady; return; }
    cooldownNote.textContent = t().noteAvail( countdown(remain) );
  }
  function updateDoneState(){
    const due=toInt(get(KEY.next),0);
    const disabled=due && due>Date.now();
    btnDone.disabled=!!disabled;
    btnDone.textContent = disabled ? `${t().doneLabel}ï¼ˆã‚ã¨${countdown(due-Date.now())}ï¼‰` : t().doneLabel;
    updateCooldownNote();
  }
  function startNextTimer(){
    if(nextTimer) clearTimeout(nextTimer);
    const due=toInt(get(KEY.next),0);
    if(!due) return;
    const wait=due-Date.now();
    if(wait<=0){ push('ai', formatSuggest()); del(KEY.next); updateDoneState(); return; }
    nextTimer=setTimeout(()=>{ del(KEY.next); updateDoneState(); push('ai', formatSuggest()); }, wait);
  }
  function startLabelTimer(){
    if(labelTimer) clearInterval(labelTimer);
    labelTimer=setInterval(()=>{
      updateDoneState();
      const due=toInt(get(KEY.next),0);
      if(!due || due<=Date.now()){ clearInterval(labelTimer); labelTimer=null; }
    }, 1000*30);
  }

  // ===== character naming reward
  function maybeAskName(){ const nm=get(KEY.charName); if(!nm && hearts>=3){ nameModal.style.display='block'; setTimeout(()=> nameInput?.focus(), 10); } }
  function updateCharNameUI(){ const nm=get(KEY.charName)||""; charNameBox.textContent = nm? `ğŸ‘¤ ${nm}`:""; }

  // ===== flow
  function startMain(newSession){
    const char = get(KEY.char);
    if(!char){ show('choose'); return; }
    charIcon.src=`public/char/${char}/calm.png`; charIcon.onerror=()=>{ charIcon.src='public/char/green/calm.png'; };
    heartCountEl.textContent=hearts; updateCharNameUI();

    chat.innerHTML='';
    if(newSession || log.length===0){ log=[]; push('ai', formatSuggest()); }
    else{ log.forEach(m=>append(m.sender,m.text)); chat.scrollTop=chat.scrollHeight; }

    show('main'); setTimeout(()=> input?.focus(), 10);
    updateDoneState(); startNextTimer(); startLabelTimer();
  }

  // ===== bindings
  on($('#coverStart'),'click', ()=>{
    // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠ
    startModal.style.display='block';
    applyLang(); // ãƒœã‚¿ãƒ³æ´»æ€§ã¨æ–‡è¨€æ›´æ–°
  });

  on(langSelect,'change', ()=>{ localStorage.setItem(LS_LANG, langSelect.value); applyLang(); updateDoneState(); });

  // ãƒªã‚»ãƒƒãƒˆï¼ˆåå‰â†’ã‚­ãƒ£ãƒ©ï¼‰
  on(userNameSave,'click', ()=>{
    const v=(userNameInput.value||"").trim();
    if(v) set(KEY.user, v); // å…¥åŠ›ã‚ã‚Šãªã‚‰ä¿å­˜
    show('choose');
  });
  on(userNameSkip,'click', ()=> show('choose'));

  // ã‚­ãƒ£ãƒ©é¸æŠ
  on(chooseGrid,'click', (e)=>{
    const b=e.target.closest('.char'); if(!b) return;
    set(KEY.char, b.dataset.char);
    hearts=0; log=[];
    saveAll();
    startMain(true);
  });

  on(chooseContinue,'click', ()=>{
    if(!get(KEY.char)){ alert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
    startMain(false);
  });

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—
  on($('#send'),'click', ()=>{ const v=(input.value||"").trim(); if(!v) return; push('user', v); input.value=''; push('ai', t().aiAck); });
  on(input,'keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#send').click(); }});

  // ã‚„ã£ãŸã‚ˆ
  on(btnDone,'click', ()=>{
    if(guard) return; guard=true; setTimeout(()=>guard=false,500);
    if(!canDoneNow()){
      const rest = Math.max(0, toInt(get(KEY.next),0)-Date.now());
      alert(`ã‚‚ã†å°‘ã—ä¼‘æ†©â€¦ æ¬¡ã¯ ${countdown(rest)} å¾Œã«ã€Œ${t().doneLabel}ã€ã§ãã¾ã™ã€‚`);
      return;
    }
    push('user', t().doneLabel);
    hearts++; heartCountEl.textContent=hearts; saveAll();
    grantSticker();
    maybeAskName();

    const h=Math.round((1+Math.random()*2)*10)/10;
    push('ai', t().laterMsg(h));
    setNextAfterHours(h);
  });

  // ã”è¤’ç¾
  on($('#rewardsBtn2'),'click', ()=>{
    const r=toObj(get(KEY.rewards),{stamps:[]});
    rewardSummary.textContent=`ãƒãƒ¼ãƒˆï¼š${hearts}ã€€ã‚¹ã‚¿ãƒ³ãƒ—ï¼š${(r.stamps||[]).length}`;
    renderStamps(r.stamps||[]);
    rewardsModal.style.display='block';
  });
  on(closeRewards,'click', ()=> rewardsModal.style.display='none');
  on(rewardsModal,'click', e=>{ if(e.target===rewardsModal) rewardsModal.style.display='none'; });

  // å‘½å
  on(nameSave,'click', ()=>{ const v=(nameInput.value||"").trim(); if(!v) return; set(KEY.charName, v); updateCharNameUI(); push('ai', `ã“ã‚Œã‹ã‚‰ã¯ã€Œ${v}ã€ã£ã¦å‘¼ã¶ã­ã€‚ã‚ˆã‚ã—ãï¼`); nameModal.style.display='none'; });
  on(nameSkip,'click', ()=> nameModal.style.display='none');
  on(closeName,'click', ()=> nameModal.style.display='none');
  on(nameModal,'click', e=>{ if(e.target===nameModal) nameModal.style.display='none'); });

  // ãƒãƒ–
  on($('#toHub'),'click', ()=> $('#hubModal').style.display='block');
  on(closeHub,'click', ()=> $('#hubModal').style.display='none');
  on(hubContinue,'click', ()=> { $('#hubModal').style.display='none'; push('ai', formatSuggest()); });
  on(hubAppearance,'click', ()=> { $('#hubModal').style.display='none'; const r=toObj(get(KEY.rewards),{stamps:[]}); rewardSummary.textContent=`ãƒãƒ¼ãƒˆï¼š${hearts}ã€€ã‚¹ã‚¿ãƒ³ãƒ—ï¼š${(r.stamps||[]).length}`; renderStamps(r.stamps||[]); rewardsModal.style.display='block'; });
  on(hubRecords,'click', ()=> { $('#hubModal').style.display='none'; const text=(log||[]).map(l=>`${new Date(l.ts).toLocaleString()} [${l.sender}] ${l.text}`).join('\n')||'ï¼ˆãƒ­ã‚°ãªã—ï¼‰'; alert(text); });

  // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
  on(closeStart,'click', ()=> startModal.style.display='none');
  on(startModal,'click', e=>{ if(e.target===startModal) startModal.style.display='none'; });

  on(btnContinueStart,'click', ()=>{
    if(!hasSave()){
      alert((t().continueDisabled)||'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
      return;
    }
    startModal.style.display='none';
    // ãã®ã¾ã¾ãƒ¡ã‚¤ãƒ³ã¸
    hearts = toInt(get(KEY.hearts),0);
    log    = toArray(get(KEY.log),[]);
    startMain(false);
  });

  on(btnResetStart,'click', ()=>{
    // é€²è¡Œã‚’æ¶ˆã—ã¦ã‹ã‚‰åå‰å…¥åŠ›ã¸
    clearProgressKeepPrefs();
    hearts=0; log=[];
    startModal.style.display='none';
    show('askname');
    setTimeout(()=> userNameInput?.focus(), 10);
  });

  // åˆæœŸ
  try{
    const lang = localStorage.getItem(LS_LANG)||"ja";
    $('#langSelect').value = lang;
    applyLang();
    show('cover');
  }catch(e){
    console.error(e);
    show('cover');
  }
})();
</script>
</body>
</html>
