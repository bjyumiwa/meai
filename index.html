<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI Prototype</title>
<style>
  /* ===== 背景（宇宙） ===== */
  html, body { height:100%; }
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
    color:#fff;
  }
  .stars, .stars::after{
    position:fixed; inset:0; content:"";
    background: radial-gradient(white 1px, transparent 1px) 0 0/3px 3px;
    opacity:.22; animation: twinkle 10s linear infinite;
    pointer-events:none; z-index:0;
  }
  .stars::after{ animation-duration:14s; opacity:.16; filter:blur(.4px) brightness(1.2); }
  @keyframes twinkle{ 0%{transform:translateY(0)} 100%{transform:translateY(-40px)} }

  /* ===== 画面・カード ===== */
  .screen{ position:fixed; inset:0; display:none; z-index:1; }
  .show{ display:block; }
  .center{
    width:min(92vw,920px); margin:10vh auto 0; display:grid;
    grid-template-columns:140px 1fr; gap:20px;
    background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.2);
    border-radius:24px; padding:24px; backdrop-filter:blur(8px);
    box-shadow:0 20px 60px rgba(0,0,0,.5);
  }
  .brand{display:grid; place-items:center;}
  .brand img{ width:110px; height:110px; object-fit:contain; filter:drop-shadow(0 6px 10px rgba(0,0,0,.5));}
  h1{margin:.1em 0 .2em; font-size:40px; letter-spacing:.02em}
  .lead{opacity:.95; margin:0 0 14px; line-height:1.6}
  .btn{
    display:block; width:100%; margin:8px 0; padding:12px 16px;
    border:none; border-radius:12px; cursor:pointer; color:#fff;
    background:rgba(255,255,255,.18); transition:.2s; font-size:16px;
  }
  .btn:hover{ background:rgba(255,255,255,.28); }
  .btn.secondary{ background:rgba(255,255,255,.1); }

  /* ===== キャラ選択 ===== */
  .panel{ width:min(92vw,680px); margin:10vh auto; background:rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:22px; backdrop-filter:blur(6px); }
  .grid{ display:flex; flex-wrap:wrap; gap:14px; justify-content:center; margin-top:6px; }
  .char{
    width:92px; height:92px; border-radius:50%; border:1px solid rgba(255,255,255,.22);
    display:grid; place-items:center; background:rgba(255,255,255,.12);
    cursor:pointer; transition:.2s;
  }
  .char img{ width:70px; height:70px; object-fit:contain; }
  .char:hover{ transform:scale(1.06); box-shadow:0 0 0 3px rgba(255,255,255,.22) inset; }

  /* ===== メイン ===== */
  #header{
    position:fixed; left:50%; transform:translateX(-50%); top:10px; z-index:3;
    background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.2);
    border-radius:999px; padding:8px 12px; display:flex; gap:12px; align-items:center;
  }
  #header img{ width:30px; height:30px; }
  #heart{ font-size:18px; }
  #chat{
    width:min(92vw,900px); height:min(64vh,460px);
    margin:100px auto 10px; padding:18px; overflow-y:auto; z-index:2; position:relative;
    background:rgba(0,0,0,.42); border:1px solid rgba(255,255,白,.18); border-radius:16px;
    border-color:rgba(255,255,255,.18);
  }
  .bubble{max-width:78%; margin:10px 0; padding:12px 14px; border-radius:14px; line-height:1.6; font-size:18px}
  .ai {background:rgba(120,200,255,.24); border:1px solid rgba(120,200,255,.34); float:left; clear:both;}
  .user{background:rgba(255,255,255,.24); border:1px solid rgba(255,255,255,.34); float:right; clear:both;}
  #composer{
    width:min(92vw,900px); margin:8px auto 0; display:flex; gap:8px; z-index:3; position:relative;
  }
  #input{
    flex:1; padding:12px 14px; border:none; border-radius:12px; color:#fff; font-size:16px;
    background:rgba(255,255,255,.16); outline:none;
  }
  #send{ padding:12px 16px; }
  #done{ padding:12px 16px; background:rgba(0,200,120,.35); }
  #done:hover{ background:rgba(0,200,120,.5); }
  #footerMenu{ position:fixed; bottom:12px; left:50%; transform:translateX(-50%); z-index:3; }
  #footerMenu .btn{ display:inline-block; width:auto; padding:8px 14px; }

  /* ===== 飾りキャラ（右寄せ・ふわスピン） ===== */
  #pet{
    position:fixed;
    /* 画面の右寄り中央付近（赤丸のあたり） */
    right:12%; top:24%;
    width:160px; height:160px;
    z-index:2; pointer-events:none; /* UIを邪魔しない */
    display:none; place-items:center;
  }
  #pet img{ width:100%; height:100%; object-fit:contain; filter:drop-shadow(0 8px 14px rgba(0,0,0,.5)); }

  /* ゆらゆら＋ゆっくりスピン（3D風） */
  @keyframes floatY{ 0%,100%{ transform:translateY(-6px) } 50%{ transform:translateY(6px) } }
  @keyframes slowSpin{ 0%{ transform:rotate(0deg) } 100%{ transform:rotate(360deg) } }

  /* 2つを合成するためのラッパー */
  #pet .float{ animation: floatY 3.6s ease-in-out infinite; }
  #pet .float .spin{ animation: slowSpin 18s linear infinite; }

  /* ハート増時のポヨン */
  @keyframes pop{ 0%{transform:scale(1)} 30%{transform:scale(1.12)} 60%{transform:scale(0.96)} 100%{transform:scale(1)} }
  #pet.pop{ animation: pop .6s ease; }

  /* 低速端末/設定配慮 */
  @media (prefers-reduced-motion:reduce){
    #pet .float, #pet .float .spin{ animation:none; }
  }

  @media (max-width:560px){
    h1{font-size:30px}
    .center{ grid-template-columns:1fr; text-align:center; }
    .brand{ order:-1; }
    #pet{ right:4%; top:26%; width:120px; height:120px; }
  }
</style>
</head>
<body>
  <div class="stars"></div>

  <!-- ===== スタート ===== -->
  <section id="title" class="screen show">
    <div class="center">
      <div class="brand"><img src="public/char/green/calm.png" alt="mascot"></div>
      <div>
        <h1>MeAI</h1>
        <p class="lead">“生活に寄り添うお願い”を受け取り、<br>「はい、やったよ」で自己申告して記録するミニアプリです。<br>※監視はしません。ボタン/入力で記録するだけ。</p>
        <button id="start" class="btn">はじめから</button>
        <button id="cont" class="btn">つづきから</button>
        <button id="about" class="btn secondary">このプロトタイプについて</button>
        <p id="savestate" style="opacity:.9;margin-top:8px;"></p>
      </div>
    </div>
  </section>

  <!-- ===== キャラ選択 ===== -->
  <section id="choose" class="screen">
    <div class="panel">
      <h2 style="margin:0 0 8px;">キャラクターを選んでね</h2>
      <div class="grid">
        <div class="char" data-char="green"><img src="public/char/green/calm.png" alt="green"></div>
        <div class="char" data-char="blue"><img src="public/char/blue/calm.png" alt="blue"></div>
        <div class="char" data-char="pink"><img src="public/char/pink/calm.png" alt="pink"></div>
        <div class="char" data-char="purple"><img src="public/char/purple/calm.png" alt="purple"></div>
      </div>
      <button id="backTitle" class="btn" style="margin-top:14px; width:auto;">← タイトルへ</button>
    </div>
  </section>

  <!-- ===== メイン ===== -->
  <section id="main" class="screen">
    <div id="header">
      <img id="charIcon" src="" alt="char">
      <div id="heart">❤️ × <span id="heartCount">0</span></div>
      <div id="sessionInfo" style="opacity:.85;"></div>
    </div>

    <div id="chat" aria-live="polite"></div>

    <div id="composer">
      <input id="input" type="text" placeholder="返答を入力…（Enterで送信）" />
      <button id="send" class="btn">送信</button>
      <button id="done" class="btn">やったよ</button>
    </div>

    <div id="footerMenu">
      <button id="toTitle" class="btn secondary">メニューへ</button>
      <button id="showLog" class="btn secondary">ログを確認</button>
      <button id="reset" class="btn secondary">データ初期化</button>
    </div>

    <!-- ★ 飾りキャラ（ふわスピン）。UIの下に敷くのでここに置く -->
    <div id="pet"><div class="float"><img class="spin" id="petImg" src="" alt="pet"></div></div>
  </section>

<script>
  const $ = s => document.querySelector(s);
  const scrTitle = $('#title'), scrChoose = $('#choose'), scrMain = $('#main');

  const btnStart = $('#start'), btnCont = $('#cont'), btnAbout = $('#about'), saveState = $('#savestate');
  const btnBackTitle = $('#backTitle'), btnToTitle = $('#toTitle'), btnReset = $('#reset'), btnShowLog = $('#showLog');

  const chat = $('#chat'), input = $('#input'), btnSend = $('#send'), btnDone = $('#done');
  const heartCountEl = $('#heartCount'), charIcon = $('#charIcon'), sessionInfo = $('#sessionInfo');

  const pet = $('#pet'), petImg = $('#petImg');

  const K = { char:'meai_character', hearts:'meai_heart', log:'meai_log' };
  let character = localStorage.getItem(K.char) || null;
  let hearts = parseInt(localStorage.getItem(K.hearts) || '0', 10);
  let log = JSON.parse(localStorage.getItem(K.log) || '[]');

  function show(el){ [scrTitle,scrChoose,scrMain].forEach(s=>s.classList.remove('show')); el.classList.add('show'); }
  function refreshTitle(){
    const has = !!localStorage.getItem(K.char);
    btnCont.disabled = !has;
    saveState.textContent = has ? 'セーブデータがあります。「つづきから」で再開できます。' : 'セーブデータがありません。';
    show(scrTitle);
  }
  refreshTitle();

  btnStart.addEventListener('click', ()=> show(scrChoose));
  btnCont.addEventListener('click', ()=>{
    if(!localStorage.getItem(K.char)){ alert('セーブデータがありません。'); return; }
    startMain(false);
  });
  btnAbout.addEventListener('click', ()=> alert('この試作はAIが監視するのではなく、ユーザーの自己申告（「やったよ」）で記録するだけの設計です。'));
  btnBackTitle.addEventListener('click', refreshTitle);

  document.querySelectorAll('.char').forEach(el=>{
    el.addEventListener('click', ()=>{
      character = el.dataset.char;
      localStorage.setItem(K.char, character);
      hearts = parseInt(localStorage.getItem(K.hearts) || '0',10);
      if(!Array.isArray(log)) log=[];
      startMain(true);
    });
  });

  function startMain(newSession){
    // ヘッダ
    charIcon.src = `public/char/${character}/calm.png`;
    heartCountEl.textContent = hearts;
    sessionInfo.textContent = newSession ? '新しいセッション' : 'つづきから';

    // 飾りキャラ（joy表情）を出す
    petImg.src = `public/char/${character}/joy.png`;
    pet.style.display = 'grid';      // 表示
    pet.classList.remove('pop');     // アニメ初期
    void pet.offsetWidth;            // reflow

    // チャット描画
    chat.innerHTML='';
    if(newSession || log.length===0){
      push('ai', firstRequest(character));
      saveAll();
    }else{
      log.forEach(m=>append(m.sender,m.text));
      chat.scrollTop = chat.scrollHeight;
    }
    show(scrMain);
    setTimeout(()=>input.focus(), 10);
  }

  function append(sender, text){
    const div = document.createElement('div');
    div.className = `bubble ${sender}`;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function push(sender, text){
    log.push({sender,text,ts:Date.now()});
    append(sender, text);
  }

  function aiReplyAfter(text){
    if(/やった/.test(text)){
      hearts++;
      heartCountEl.textContent = hearts;
      push('ai','すばらしい！ハートが増えたよ💖');
      push('ai', randomRequest());

      // ★ハート増時に飾りキャラをポヨン
      pet.classList.remove('pop');
      void pet.offsetWidth; // restart animation
      pet.classList.add('pop');
    }else{
      push('ai','うん、なるほどね。');
    }
    saveAll();
  }

  function send(){
    const t = input.value.trim();
    if(!t) return;
    push('user', t);
    input.value = '';
    aiReplyAfter(t);
  }
  btnSend.addEventListener('click', send);
  input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
  btnDone.addEventListener('click', ()=>{
    push('user','やったよ');
    aiReplyAfter('やったよ');
  });

  btnToTitle.addEventListener('click', refreshTitle);
  btnReset.addEventListener('click', ()=>{
    if(confirm('セーブデータ（キャラ・ハート・ログ）を削除します。よろしいですか？')){
      localStorage.removeItem(K.char);
      localStorage.removeItem(K.hearts);
      localStorage.removeItem(K.log);
      character=null; hearts=0; log=[];
      // 飾りキャラを隠す
      pet.style.display = 'none';
      refreshTitle();
    }
  });
  btnShowLog.addEventListener('click', ()=>{
    const text = log.map(l=>`${new Date(l.ts).toLocaleString()} [${l.sender}] ${l.text}`).join('\n') || '（ログなし）';
    alert(text);
  });

  const REQUESTS=[
    "今日はだれかに『おはよう』を伝えてみよう。",
    "水をコップ一杯のもう。",
    "5分だけストレッチしてみよう。",
    "外の空気を吸いに行こう。",
    "今日の良かったことを1つメモしよう。"
  ];
  function randomRequest(){ return REQUESTS[Math.floor(Math.random()*REQUESTS.length)]; }
  function firstRequest(char){
    const tag = {green:"（やさしく）", blue:"（ていねいに）", pink:"（わくわく）", purple:"（おちついて）"}[char] || "";
    return `${tag} ${randomRequest()}`;
  }
  function saveAll(){
    localStorage.setItem(K.hearts, String(hearts));
    localStorage.setItem(K.log, JSON.stringify(log));
  }
</script>
</body>
</html>
