<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI â€“ æ„›ç€æˆé•·ãƒŸãƒ‹ç‰ˆï¼ˆ3ææ¡ˆ/æ—¥ï¼‰</title>
<link rel="icon" href="data:,">
<style>
  :root{ --fg:#fff; --bg:#000; --glass:rgba(255,255,255,.07); --glass-border:rgba(255,255,255,.16); --accent:#7dd3fc; }
  html,body{height:100%}
  body{margin:0;color:var(--fg);background:#000 url("public/space_background.png") center/cover fixed no-repeat;
       font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;}
  .wrap{ max-width:960px; margin:0 auto; padding:24px; }
  .grid{ display:grid; grid-template-columns: 280px 1fr; gap:20px; }
  .glass{ background:var(--glass); border:1px solid var(--glass-border); border-radius:16px; backdrop-filter:blur(8px); }
  .pad{ padding:16px; }
  .btn{ border:none; border-radius:999px; padding:8px 14px; cursor:pointer; color:#fff; background:rgba(255,255,255,.18); }
  .btn:hover{ background:rgba(255,255,255,.26); }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .field{ display:flex; gap:8px; align-items:center; }
  input[type="text"],select,textarea{ background:rgba(255,255,255,.08); color:#fff; border:1px solid var(--glass-border); padding:8px 10px; border-radius:10px; outline:none; min-width:0; }
  .chip{ display:inline-flex; align-items:center; gap:.4em; padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid var(--glass-border); font-size:12px; }
  .divider{ border:none; border-top:1px solid var(--glass-border); margin:14px 0; }
  #charWrap{ text-align:center; }
  #charWrap img{ width:240px; height:auto; animation:sway 5s ease-in-out infinite; transform-origin:50% 0%; }
  @keyframes sway{0%{transform:rotate(0) translateY(0)}25%{transform:rotate(1.2deg) translateY(-1px)}50%{transform:rotate(0)}75%{transform:rotate(-1.2deg) translateY(-1px)}100%{transform:rotate(0)}}
  .name-badge{ display:inline-flex; gap:.4em; align-items:center; padding:4px 10px; border-radius:999px; border:1px solid var(--glass-border); background:rgba(255,255,255,.10); font-size:12px; margin-top:6px;}
  /* Cover */
  #cover{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
          background: radial-gradient(ellipse at 50% -10%, rgba(125,211,252,.18), transparent 60%), rgba(0,0,0,.85); z-index:9999; }
  .cover-card{ width:min(680px, 92vw); padding:24px; text-align:center; box-shadow:0 8px 40px rgba(0,0,0,.45); }
  .cover-title{ font-size:28px; font-weight:800; margin:8px 0 2px; }
  /* å‘½åãƒ¢ãƒ¼ãƒ€ãƒ« */
  #nameModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10000;
              background:rgba(0,0,0,.6); }
  .modal-card{ width:min(520px,92vw); padding:18px; }
  .hidden{display:none!important;}
  @media (max-width:820px){ .grid{grid-template-columns:1fr} #charWrap img{width:200px} }
</style>
</head>
<body>

<!-- è¡¨ç´™ï¼ˆåˆå›ï¼‰ -->
<div id="cover" class="hidden">
  <div class="glass cover-card">
    <div style="font-size:12px; opacity:.9;">MeAI MINI</div>
    <div class="cover-title">å°ã•ãªâ€œã‚„ã£ã¦ã¿ã‚‹â€ã‚’ã€ã„ã£ã—ã‚‡ã«ã€‚</div>
    <p style="opacity:.9;">1æ—¥ã«3ã¤ã ã‘ã€‚ã§ããŸã‚‰ãƒãƒ¼ãƒˆãŒè²¯ã¾ã£ã¦ã€ã‚­ãƒ£ãƒ©ãŒå–œã¶ã‚ˆã€‚</p>
    <div class="row" style="justify-content:center;">
      <input id="coverName" class="cover-name" type="text" placeholder="ã‚ãªãŸã®åå‰ï¼ˆä¾‹ï¼šã¿ã‚ï¼‰" style="width:200px;">
      <select id="coverColor">
        <option value="blue">blue</option><option value="pink">pink</option>
        <option value="green">green</option><option value="purple">purple</option>
      </select>
    </div>
    <div class="row" style="justify-content:center; margin-top:10px;">
      <button id="coverStart" class="btn" style="background:rgba(125,211,252,.25); border:1px solid rgba(125,211,252,.5);">ã¯ã˜ã‚ã‚‹</button>
      <button id="coverSkip" class="btn">ã‚ã¨ã§è¨­å®š</button>
    </div>
  </div>
</div>

<!-- å‘½åãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ3å›é”æˆã§ä¸€åº¦ã ã‘ï¼‰ -->
<div id="nameModal">
  <div class="glass modal-card">
    <h3 style="margin:4px 0 8px;">ã‚­ãƒ£ãƒ©ã®åå‰ã‚’ã¤ã‘ã‚ˆã†ï¼</h3>
    <div class="row">
      <input id="charNameInput" type="text" placeholder="ä¾‹ï¼‰ãã‚‰ / ã¿ã‚‹ã" style="width:220px;">
      <button id="charNameSave" class="btn">æ±ºå®š</button>
      <button id="charNameLater" class="btn">ã‚ã¨ã§</button>
    </div>
    <div style="font-size:12px; opacity:.85; margin-top:6px;">â€»ã‚ã¨ã‹ã‚‰ã‚‚è¨­å®šã§ãã¾ã™ï¼ˆã‚­ãƒ£ãƒ©ä¸‹ã®ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰ã€‚</div>
  </div>
</div>

<div class="wrap">
  <div class="row" style="justify-content:space-between; margin-bottom:12px;">
    <h1>MeAI â€“ ä»Šæ—¥ã¯ä½•ã‚’ææ¡ˆã—ã¦ãã‚Œã‚‹ï¼Ÿ</h1>
    <div class="row">
      <a id="toCare" class="btn" href="Room.html">ãŠä¸–è©±ã‚³ãƒ¼ãƒŠãƒ¼ã¸</a>
      <button id="exportCsv" class="btn">CSVã‚’æ›¸ãå‡ºã™</button>
      <button id="resetAll" class="btn">åˆæœŸåŒ–</button>
    </div>
  </div>

  <!-- è¨­å®š -->
  <div class="glass pad" style="margin-bottom:16px;">
    <div class="row">
      <div class="field">
        <label for="userName">ã‚ãªãŸã®åå‰</label>
        <input id="userName" type="text" placeholder="ä¾‹ï¼‰ã¿ã‚" style="width:160px;">
      </div>
      <div class="field">
        <label for="charColor">ã‚­ãƒ£ãƒ©è‰²</label>
        <select id="charColor">
          <option value="blue">blue</option><option value="pink">pink</option>
          <option value="green">green</option><option value="purple">purple</option>
        </select>
      </div>
      <button id="saveProfile" class="btn">ä¿å­˜</button>
      <span id="dailyInfo" class="chip">æœ¬æ—¥ã®é”æˆ: <b id="doneCount">0</b>/3</span>
    </div>
    <div class="row" style="margin-top:6px; font-size:12px; opacity:.9;">
      ç”»åƒã¯ <code>public/char/{color}/{emotion}.png</code>ï¼ˆemotion: calm / joy / sad / sleepï¼‰
    </div>
  </div>

  <div class="grid">
    <!-- å·¦ï¼šã‚­ãƒ£ãƒ© -->
    <div class="glass pad">
      <div id="charWrap">
        <img id="charImg" alt="char" src="">
        <div id="hello" style="margin-top:8px; opacity:.95;"></div>
        <button id="charNameBadge" class="name-badge" title="ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´">
          <span>ğŸ£ ãªã¾ãˆï¼š<b id="charNameLabel">ï¼ˆæœªè¨­å®šï¼‰</b></span>
        </button>
      </div>
      <hr class="divider">
      <div id="status">
        <div>â¤ï¸ <span id="hearts">0</span>ã€€ï¼ã€€ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="stage">S0</span>ã€€ï¼ã€€é€£ç¶š: <span id="streak">0</span>æ—¥</div>
        <div>ğŸ–ï¸ ã‚¹ã‚¿ãƒ³ãƒ—: <span id="stamps">0</span></div>
        <div id="stampsRow" class="row" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- å³ï¼šææ¡ˆ & ãŠã‚„ã™ã¿ -->
    <div class="glass pad">
      <h3>ğŸ“¬ ä»Šæ—¥ã®ææ¡ˆï¼ˆ3ã¤ï¼‰</h3>
      <ul id="tasks" style="list-style:none; padding:0; display:grid; gap:10px;"></ul>
      <div style="opacity:.9; font-size:13px;">åŒã˜æ—¥ã¯åŒã˜3ä»¶ã€‚å„ã‚¿ã‚¹ã‚¯ã¯<strong>1æ—¥1å›</strong>ã€åˆè¨ˆ<strong>3å›ã¾ã§</strong>ã€‚</div>
      <hr class="divider" />
      <div id="goodCard">
        <h3>ğŸŒ™ ãŠã‚„ã™ã¿å‰ãƒã‚§ãƒƒã‚¯ï¼ˆä»Šæ—¥ã‚ã£ãŸã„ã„ã“ã¨ Ã—3ï¼‰</h3>
        <div id="goodInputArea" style="display:grid; gap:8px;">
          <input id="good1" type="text" placeholder="ã„ã„ã“ã¨â‘ ">
          <input id="good2" type="text" placeholder="ã„ã„ã“ã¨â‘¡">
          <input id="good3" type="text" placeholder="ã„ã„ã“ã¨â‘¢">
          <div class="row" style="margin-top:6px;">
            <button id="goodSave" class="btn">ä»Šæ—¥ã‚’ã—ã‚ã‚‹</button>
            <span id="goodStatus" class="chip">æœªç™»éŒ²</span>
          </div>
        </div>
        <div id="goodSavedArea" class="hidden">
          <div class="row" id="goodSavedList" style="gap:6px; flex-direction:column;"></div>
          <div style="opacity:.9; font-size:12px;">â€»ç™»éŒ²æ¸ˆã¿ï¼ˆå†ç·¨é›†ä¸å¯ï¼‰</div>
        </div>
        <div style="opacity:.9; font-size:13px; margin-top:8px;">â€»ç™»éŒ²ã—ãªã„ã¨ç¿Œæœã«â¤ï¸ãŒ<strong>2ã“æ¸›å°‘</strong>ï¼ˆè‡ªå‹•ï¼‰</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
/* ====== è¨­å®š ====== */
const LS_STATE='MEAI_STATE_V3', LS_LOG='MEAI_LOG_V3';
const LS_DAY_PREFIX='MEAI_DAILY_V3:', LS_DAY_PROGRESS_PREFIX='MEAI_DAY_PROGRESS_V3:';
const LS_USER='MEAI_USER_NAME', LS_COLOR='MEAI_CHAR_COLOR', LS_SEEN='MEAI_SEEN_COVER_V1';
const LS_GOOD_PREFIX='MEAI_GOOD_V1:', LS_PENALTY_PREFIX='MEAI_PENALTY_V1:', LS_SLEEP='MEAI_SLEEP_DATE_V1';
const LS_CNAME='MEAI_CHAR_NAME_V1';

const COLORS=['blue','pink','green','purple'];
const EMOTIONS=['calm','joy','sad','sleep'];
const TASK_POOL=[
  {id:'H1',cat:'health',text:'ãŠæ°´ã‚’ã‚³ãƒƒãƒ—1æ¯ã®ã‚‚ã†',heart:1},
  {id:'H2',cat:'health',text:'3åˆ†ã ã‘æ·±å‘¼å¸ã—ã¦ã¿ã‚ˆã†',heart:2},
  {id:'L1',cat:'life',text:'æœºã®ä¸Šã‚’1åˆ†ã ã‘ç‰‡ä»˜ã‘ã‚‹',heart:1},
  {id:'L2',cat:'life',text:'çª“ã‚’é–‹ã‘ã¦å¤–ã®ç©ºæ°—ã‚’å¸ã†',heart:1},
  {id:'S1',cat:'social',text:'èª°ã‹ã«ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’1å›ä¼ãˆã‚‹',heart:2},
  {id:'A1',cat:'art',text:'å†™çœŸã‚’1æšã¨ã£ã¦ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ',heart:2},
  {id:'A2',cat:'art',text:'1åˆ†è½æ›¸ãã—ã¦ã¿ã‚ˆã†',heart:2},
  {id:'E1',cat:'learn',text:'æ°—ã«ãªã‚‹è¨€è‘‰ã‚’1ã¤èª¿ã¹ã‚‹',heart:2},
  {id:'E2',cat:'learn',text:'ä»Šæ—¥ã‚ã£ãŸç™ºè¦‹ã‚’1è¡Œãƒ¡ãƒ¢',heart:2},
];
const CAT_WEIGHT={health:3,life:3,social:2,art:2,learn:2};
const DAILY_LIMIT=3;
const $=sel=>document.querySelector(sel);
const todayStr=()=>new Date().toISOString().slice(0,10);
const ymd=d=>d.toISOString().slice(0,10);
const goodKey=d=>LS_GOOD_PREFIX+d, penKey=d=>LS_PENALTY_PREFIX+d;

/* ====== IO ====== */
function loadState(){
  const s=localStorage.getItem(LS_STATE);
  if (s) return JSON.parse(s);
  const init={ userName:localStorage.getItem(LS_USER)||'', charColor:localStorage.getItem(LS_COLOR)||'blue',
               hearts:0, streakDays:0, stamps:0, lastActionDate:null, stage:'S0', unlocked:{skins:[],bg:[],lines:[]} };
  localStorage.setItem(LS_STATE, JSON.stringify(init));
  if (!localStorage.getItem(LS_LOG)) localStorage.setItem(LS_LOG, JSON.stringify([]));
  return init;
}
function saveState(st){ localStorage.setItem(LS_STATE, JSON.stringify(st)); }
function loadLog(){ return JSON.parse(localStorage.getItem(LS_LOG)||'[]'); }
function saveLog(l){ localStorage.setItem(LS_LOG, JSON.stringify(l)); }
function loadGood(d){ const raw=localStorage.getItem(goodKey(d)); return raw?JSON.parse(raw):null }
function saveGood(d,items){ localStorage.setItem(goodKey(d), JSON.stringify({items, savedAt:new Date().toISOString()})); }

/* ====== æ—¥æ¬¡é€²æ— ====== */
const dayKey=()=>LS_DAY_PROGRESS_PREFIX+todayStr();
function loadDayProgress(){
  const raw=localStorage.getItem(dayKey());
  if (raw) return JSON.parse(raw);
  const init={doneIds:[],count:0}; localStorage.setItem(dayKey(), JSON.stringify(init)); return init;
}
function saveDayProgress(p){ localStorage.setItem(dayKey(), JSON.stringify(p)); }

/* ====== ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š ====== */
function evalStage(st){
  const h=st.hearts, streak=st.streakDays, stamps=st.stamps;
  if (h>=40 && stamps>=10) return 'S4';
  if (h>=24 && streak>=7)  return 'S3';
  if (h>=12 && stamps>=5)  return 'S2';
  if (h>=5  && streak>=2)  return 'S1';
  return 'S0';
}

/* ====== ç”»åƒãƒ»æŒ¨æ‹¶ ====== */
function setEmotion(st, emotion='calm'){
  const color = COLORS.includes(st.charColor)? st.charColor : 'blue';
  $('#charImg').src = `public/char/${color}/${EMOTIONS.includes(emotion)?emotion:'calm'}.png`;
}
function helloLine(st){
  const uname = st.userName || 'ã‚ãªãŸ';
  const cname = localStorage.getItem(LS_CNAME) || '';
  const t=todayStr();
  const who = cname ? `${cname}ã¨` : '';
  if (!st.lastActionDate) return `ã¯ã˜ã‚ã¾ã—ã¦ã€${uname}ã•ã‚“ã€‚ä»Šæ—¥ã‹ã‚‰${who}ã‚ˆã‚ã—ãã­ã€‚`;
  if (st.lastActionDate===t) return getSleepIsToday()? `ãŠã‚„ã™ã¿ä¸­â€¦ã€‚é™ã‹ã«è¦‹å®ˆã‚‹ã­ã€‚` : `ã¾ãŸä¼šãˆãŸã­ã€${uname}ã•ã‚“ã€‚`;
  const last=new Date(st.lastActionDate+'T00:00:00'), now=new Date(t+'T00:00:00'); const diff=Math.round((now-last)/86400000);
  if (diff===1) return `ãŠã‹ãˆã‚Šã€${uname}ã•ã‚“ã€‚æ˜¨æ—¥ã®ç¶šãã€ã„ã„æ„Ÿã˜ï¼`;
  if (diff<=3)  return `ãŠã‹ãˆã‚Šã€${uname}ã•ã‚“ã€‚${diff}æ—¥ã¶ã‚Šã ã­ã€‚`;
  return `ä¼šãˆã¦ã†ã‚Œã—ã„ã‚ˆã€${uname}ã•ã‚“ã€‚`;
}

/* ====== å°±å¯ãƒ•ãƒ©ã‚° ====== */
const getSleep=()=>localStorage.getItem(LS_SLEEP);
const setSleep=d=>localStorage.setItem(LS_SLEEP,d);
const clearSleep=()=>localStorage.removeItem(LS_SLEEP);
const getSleepIsToday=()=>getSleep()===todayStr();
function refreshForNewDay(){
  const flag=getSleep();
  if (flag && flag!==todayStr()) clearSleep();
}

/* ====== ãƒ‡ã‚¤ãƒªãƒ¼ææ¡ˆ ====== */
function seededRandom(seedStr){ let h=0; for(let i=0;i<seedStr.length;i++) h=(h*31+seedStr.charCodeAt(i))>>>0;
  return ()=>{ h^=h<<13; h^=h>>>17; h^=h<<5; return (h>>>0)/0xFFFFFFFF; }; }
function weightedPick(arr,weights,n,excludeIds=new Set()){
  const out=[], pool=arr.filter(x=>!excludeIds.has(x.id));
  while(out.length<n && pool.length){
    const total=Object.values(weights).reduce((a,b)=>a+b,0), r=Math.random()*total; let acc=0, pick=null;
    for(const [k,w] of Object.entries(weights)){ acc+=w; if(r<=acc){ pick=k; break; } }
    const cand=pool.filter(x=>x.cat===pick);
    const item=(cand.length?cand:pool)[Math.floor(Math.random()* (cand.length?cand.length:pool.length))];
    if (!out.find(o=>o.id===item.id)) out.push(item);
  }
  while(out.length<n && pool.length){
    const item=pool.splice(Math.floor(Math.random()*pool.length),1)[0];
    if (!out.find(o=>o.id===item.id)) out.push(item);
  }
  return out;
}
function getTodayTasks(st){
  const key=LS_DAY_PREFIX+todayStr(); const cached=localStorage.getItem(key);
  if (cached) return JSON.parse(cached);
  const recentDone=new Set(loadLog().filter(x=>x.done).slice(-9).map(x=>x.taskId));
  const seed=seededRandom(todayStr()+(st.userName||'')+st.charColor); const bak=Math.random; Math.random=seed;
  const tasks=weightedPick(TASK_POOL, CAT_WEIGHT, 3, recentDone); Math.random=bak;
  localStorage.setItem(key, JSON.stringify(tasks)); return tasks;
}

/* ====== å®Œäº†å‡¦ç†ï¼ˆâ˜…3å›ã§å‘½åï¼‰ ====== */
function maybeOpenNameModal(){
  if (localStorage.getItem(LS_CNAME)) return; // æ—¢ã«å‘½åæ¸ˆã¿
  $('#nameModal').style.display='flex';
  $('#charNameInput').focus();
}
function completeTask(task){
  const st=loadState(), today=todayStr(), prog=loadDayProgress();
  if (prog.doneIds.includes(task.id)) { alert('ã“ã®ææ¡ˆã¯ä»Šæ—¥ã¯ã‚‚ã†é”æˆæ¸ˆã¿ã ã‚ˆï¼'); return; }
  if (prog.count>=DAILY_LIMIT) { alert('ä»Šæ—¥ã¯3ã¤é”æˆï¼ã¾ãŸæ˜æ—¥ã„ã£ã—ã‚‡ã«ã‚„ã‚ã†ã€‚'); return; }

  if (st.lastActionDate!==today){
    const y=new Date(); y.setDate(y.getDate()-1);
    st.streakDays = (st.lastActionDate===ymd(y)) ? (st.streakDays+1) : 1;
    st.stamps += 1;
  }
  st.hearts += task.heart;
  st.lastActionDate = today;
  const p=st.stage; st.stage=evalStage(st); if (p!==st.stage){ /* ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¼”å‡ºã¯çœç•¥ */ }
  saveState(st);

  const log=loadLog(); log.push({date:today, taskId:task.id, category:task.cat, done:true, deltaHeart:task.heart}); saveLog(log);

  prog.doneIds.push(task.id); prog.count += 1; saveDayProgress(prog);

  if (!getSleepIsToday()){ setEmotion(st,'joy'); setTimeout(()=>setEmotion(st,'calm'), 1200); }
  renderAll();

  // â˜… æœ¬æ—¥3å›é”æˆã—ãŸç¬é–“ã«å‘½åãƒ¢ãƒ¼ãƒ€ãƒ«
  if (prog.count===3) maybeOpenNameModal();
}

/* ====== ãŠã‚„ã™ã¿ ====== */
function renderGoodCard(){
  const t=todayStr(), saved=loadGood(t);
  const inputArea=$('#goodInputArea'), savedArea=$('#goodSavedArea'), status=$('#goodStatus');
  if (saved){
    inputArea.classList.add('hidden'); savedArea.classList.remove('hidden'); status.textContent='ç™»éŒ²æ¸ˆã¿';
    const list=$('#goodSavedList'); list.innerHTML=''; saved.items.forEach((txt,i)=>{ const div=document.createElement('div'); div.textContent=`ã„ã„ã“ã¨${i+1}ï¼š${txt}`; list.appendChild(div); });
  }else{
    inputArea.classList.remove('hidden'); savedArea.classList.add('hidden'); status.textContent='æœªç™»éŒ²';
  }
}
function saveTodayGoods(){
  const v1=$('#good1').value.trim(), v2=$('#good2').value.trim(), v3=$('#good3').value.trim();
  if (![v1,v2,v3].every(Boolean)) return alert('3ã¤ã™ã¹ã¦å…¥åŠ›ã—ã¦ã­ï¼');
  const d=todayStr(); saveGood(d,[v1,v2,v3]); setSleep(d); const st=loadState(); setEmotion(st,'sleep'); renderGoodCard(); renderStatus(st);
}
/* ç¿ŒæœãƒšãƒŠãƒ«ãƒ†ã‚£ */
function checkAndApplyPenalty(){
  const today=new Date(), y=new Date(today); y.setDate(y.getDate()-1); const yStr=ymd(y);
  if (localStorage.getItem(penKey(yStr))) return;
  if (!loadGood(yStr)){
    const st=loadState(); const before=st.hearts; st.hearts=Math.max(0, st.hearts-2); saveState(st);
    const log=loadLog(); log.push({date:todayStr(), taskId:'PENALTY_NO_GOOD', category:'penalty', done:false, deltaHeart: st.hearts-before}); saveLog(log);
    localStorage.setItem(penKey(yStr),'1');
    if (!getSleepIsToday()){ setEmotion(st,'sad'); setTimeout(()=>setEmotion(st,'calm'), 1400); }
  }
}

/* ====== UIæç”» ====== */
function renderStatus(st){
  $('#hearts').textContent=st.hearts; $('#stage').textContent=st.stage; $('#streak').textContent=st.streakDays; $('#stamps').textContent=st.stamps;
  const row=$('#stampsRow'); row.innerHTML=''; const n=Math.min(st.stamps,12); for(let i=0;i<n;i++){ const b=document.createElement('span'); b.textContent='ğŸŒŸ'; b.style.fontSize='20px'; row.appendChild(b); }
  const prog=loadDayProgress(); $('#doneCount').textContent=prog.count;
}
function renderTasks(tasks){
  const ul=$('#tasks'); ul.innerHTML=''; const prog=loadDayProgress();
  tasks.forEach(t=>{
    const disabled=prog.doneIds.includes(t.id)||prog.count>=DAILY_LIMIT; const label=prog.doneIds.includes(t.id)?'æ¸ˆ':'ã‚„ã£ãŸã‚ˆ';
    const li=document.createElement('li'); li.className='glass pad'; li.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
        <div><div style="font-weight:700;">${t.text}</div><small>ã‚«ãƒ†ã‚´ãƒª: ${t.cat} ï¼ â¤ï¸ +${t.heart}</small></div>
        <button class="btn doBtn" data-id="${t.id}" ${disabled?'disabled':''}>${label}</button>
      </div>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll('.doBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if (btn.disabled) return;
      const id=btn.getAttribute('data-id'); const task=TASK_POOL.find(x=>x.id===id); if (task) completeTask(task);
    });
  });
}
function renderChar(st){
  const cname = localStorage.getItem(LS_CNAME) || 'ï¼ˆæœªè¨­å®šï¼‰';
  $('#charNameLabel').textContent = cname;
  setEmotion(st, getSleepIsToday() ? 'sleep' : 'calm');
  $('#hello').textContent = helloLine(st);
}
function renderAll(){
  const st=loadState();
  renderStatus(st);
  renderTasks(getTodayTasks(st));
  renderChar(st);
  renderGoodCard();
}

/* ====== CSV ====== */
function exportCSV(){
  const log=loadLog(); if(!log.length) return alert('ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
  const header=['date','taskId','category','done','deltaHeart'], rows=[header.join(',')].concat(log.map(r=>[r.date,r.taskId,r.category,r.done,r.deltaHeart].join(',')));
  const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`meai_log_${todayStr()}.csv`; a.click(); URL.revokeObjectURL(a.href);
}

/* ====== è¨­å®šUI ====== */
function applyProfileFields(){ const st=loadState(); $('#userName').value=st.userName||''; $('#charColor').value=COLORS.includes(st.charColor)?st.charColor:'blue'; }
function saveProfile(){ const st=loadState(); st.userName=$('#userName').value.trim(); st.charColor=$('#charColor').value; localStorage.setItem(LS_USER,st.userName); localStorage.setItem(LS_COLOR,st.charColor); saveState(st); renderAll(); }

/* ====== åˆæœŸåŒ– ====== */
function resetAll(){
  if(!confirm('ã™ã¹ã¦ã®è¨˜éŒ²ã‚’åˆæœŸåŒ–ã—ã€ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã¸æˆ»ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  [LS_STATE,LS_LOG,LS_USER,LS_COLOR,LS_SEEN,LS_SLEEP,LS_CNAME].forEach(k=>localStorage.removeItem(k));
  Object.keys(localStorage).forEach(k=>{ if([LS_DAY_PREFIX,LS_DAY_PROGRESS_PREFIX,LS_GOOD_PREFIX,LS_PENALTY_PREFIX,'MEAI_STATE_V2','MEAI_LOG_V2'].some(p=>k.startsWith(p))) localStorage.removeItem(k); });
  location.href='index.html';
}

/* ====== èµ·å‹• ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  refreshForNewDay(); checkAndApplyPenalty();
  applyProfileFields(); renderAll();

  // ã‚«ãƒãƒ¼è¡¨ç¤º
  if (!localStorage.getItem(LS_SEEN)){
    $('#cover').classList.remove('hidden');
    $('#coverName').value = (loadState().userName || '');
    $('#coverColor').value = (loadState().charColor || 'blue');
  }
  // ã‚«ãƒãƒ¼æ“ä½œ
  $('#coverStart').addEventListener('click', ()=>{
    const name=$('#coverName').value.trim(); const color=$('#coverColor').value; const st=loadState();
    if(name){ st.userName=name; localStorage.setItem(LS_USER,name); }
    st.charColor=color; localStorage.setItem(LS_COLOR,color);
    saveState(st); localStorage.setItem(LS_SEEN,'1'); $('#cover').classList.add('hidden'); renderAll();
  });
  $('#coverSkip').addEventListener('click', ()=>{ localStorage.setItem(LS_SEEN,'1'); $('#cover').classList.add('hidden'); renderAll(); });

  // UIã‚¤ãƒ™ãƒ³ãƒˆ
  $('#saveProfile').addEventListener('click', saveProfile);
  $('#exportCsv').addEventListener('click', exportCSV);
  $('#resetAll').addEventListener('click', resetAll);
  $('#goodSave').addEventListener('click', saveTodayGoods);

  // å‘½åãƒ¢ãƒ¼ãƒ€ãƒ«
  $('#charNameBadge').addEventListener('click', ()=>{ $('#nameModal').style.display='flex'; $('#charNameInput').value=localStorage.getItem(LS_CNAME)||''; $('#charNameInput').focus(); });
  $('#charNameLater').addEventListener('click', ()=>{ $('#nameModal').style.display='none'; });
  $('#charNameSave').addEventListener('click', ()=>{
    const v=$('#charNameInput').value.trim(); if(!v) return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ã­');
    localStorage.setItem(LS_CNAME, v); $('#nameModal').style.display='none'; $('#charNameLabel').textContent=v;
    renderAll();
  });
});
</script>

<!-- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚²ãƒ¼ãƒ å´ã§ã‚‚ä½¿ç”¨ï¼‰ -->
<script src="public/js/meai-common.js"></script>
</body>
</html>
