<!-- FILE: /MeAI/index.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeAI | Welcome</title>
  <meta name="description" content="MeAI: お世話×会話AI×進化（HBD演奏）を統合した研究型アプリケーション" />
  <!-- 404対策：簡易favicon -->
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.85em' font-size='80'%3E🌙%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --card-bg: rgba(0,0,0,.38);
      --card-bd: rgba(255,255,255,.18);
      --text:#fff;
      --accent:#f7b0bf;
      --accent-ink:#222;
      --ok:#7CFFB2;
      --ng:#FF8A8A;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Noto Color Emoji","Segoe UI Emoji",sans-serif;
      color:var(--text);
      background:#000 center/cover fixed no-repeat;
      background-image:url("public/space_background.png");
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:24px;
    }
    .hero{
      width:min(92vw, 880px);
      text-align:center;
      padding:32px 20px 28px;
      background:linear-gradient(transparent,rgba(0,0,0,.25));
      border-radius:20px;
    }
    .hero img#hero-ako{
      display:block;margin:0 auto 22px;width:min(42vw,260px);height:auto;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));
    }
    h1{margin:0 0 14px;font-size:clamp(28px,5vw,44px);letter-spacing:.02em;text-shadow:0 2px 10px rgba(0,0,0,.6);}
    .lead{margin:0 auto 20px;width:min(90%, 740px);font-size:clamp(15px,2.2vw,18px);line-height:1.9;text-shadow:0 1px 6px rgba(0,0,0,.55);}
    .cta{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:4px}
    .primary,.ghost{
      padding:.9rem 1.3rem;border:0;border-radius:14px;cursor:pointer;
      font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,.35);transition:transform .06s ease;
    }
    .primary{ background:var(--accent); color:var(--accent-ink); }
    .ghost{ background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.22) }
    .primary:active,.ghost:active{ transform:translateY(1px) }
    .lang{ margin-top:14px; font-size:14px; opacity:.95; user-select:none; }
    .lang button{ background:none;border:0;color:#fff;text-decoration:underline;cursor:pointer;padding:2px 4px;margin:0 2px }
    .note{font-size:12px;opacity:.8;margin-top:10px}
    .badge{
      display:inline-flex;gap:6px;align-items:center;
      font-size:12px;border:1px solid var(--card-bd);padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);backdrop-filter:saturate(120%) blur(2px);
      margin: 8px auto 0;
    }
    .dot{width:8px;height:8px;border-radius:50%;}
    .ok{background:var(--ok);} .ng{background:var(--ng);}
  </style>
</head>
<body>
  <div class="hero" role="banner" aria-label="MeAI hero">
    <!-- ★ キャラ画像（差し替え可） -->
    <img id="hero-ako" src="public/ako.png?v=2" alt="アコーディオンを弾くキャラクター" loading="eager" />

    <h1 id="t_title">MeAIへようこそ</h1>
    <p id="t_desc" class="lead">
      “お世話”で心を育て、“会話AI”で日々を記録。ポイントが貯まると誕生日の曲が完成して進化します。
    </p>

    <!-- API ステータス -->
    <div id="api_badge" class="badge" aria-live="polite">
      <span class="dot ng" id="api_dot"></span><span id="api_text">API: Checking…</span>
    </div>

    <div class="cta">
      <!-- ★ はじめる：プロフィール未設定なら name_first.html、設定済みなら meai_home.html -->
      <button id="t_start" class="primary" onclick="startFlow()">はじめる</button>
      <!-- 続きから（進行状況があれば表示） -->
      <button id="t_continue" class="ghost" style="display:none" onclick="continueFlow()">つづきから</button>
      <!-- 研究について（about.htmlへ） -->
      <button id="t_about" class="ghost" onclick="location.href='about.html'">この研究について</button>
    </div>

    <div class="lang" aria-label="language switch">
      <button type="button" onclick="setLang('ja')">日本語</button> |
      <button type="button" onclick="setLang('en')">English</button> |
      <button type="button" onclick="setLang('zh-CN')">简体</button> |
      <button type="button" onclick="setLang('zh-TW')">繁體</button> |
      <button type="button" onclick="setLang('ko')">한국어</button>
      <div class="note" id="t_note">言語設定は次回アクセス時も保持されます。</div>
    </div>
  </div>

  <script>
    /* ====== LocalStorage Keys ====== */
    const LS = {
      LANG: 'MEAI_LANG',
      PROGRESS: 'MEAI_PROGRESS',      // 'seed' | 'care' | 'talk' | 'evolved'
      USER_NAME: 'MEAI_USER_NAME',    // あなたの名前
      CHAR_NAME: 'MEAI_CHAR_NAME',    // キャラクターの名前
      API_BASE: 'MEAI_API_BASE'       // 任意: 上書き用
    };

    /* ====== API Endpoint ======
       既存の TALK_ENDPOINT をそのまま使いたい要件に対応。
       1) localStorage.MEAI_API_BASE があれば優先
       2) なければ window.TALK_ENDPOINT を使用
       3) どちらも無ければ相対 'api/talk' を仮定
    */
    const TALK_ENDPOINT = (
      localStorage.getItem(LS.API_BASE)
      || (typeof window.TALK_ENDPOINT === 'string' ? window.TALK_ENDPOINT : '')
    ) || 'api/talk';

    /* ====== i18n ====== */
    const I18N = {
      "ja": {
        title: "MeAIへようこそ",
        desc:  "“お世話”で心を育て、“会話AI”で日々を記録。ポイントが貯まると誕生日の曲が完成して進化します。",
        start: "はじめる",
        cont:  "つづきから",
        about: "この研究について",
        note:  "言語設定は次回アクセス時も保持されます。",
        api_ok:"API: Online",
        api_ng:"API: Offline"
      },
      "en": {
        title: "Welcome to MeAI",
        desc:  "Care grows bond, chats log your days. Earn points to complete the birthday song and evolve.",
        start: "Start",
        cont:  "Continue",
        about: "About this research",
        note:  "Your language preference is saved for your next visit.",
        api_ok:"API: Online",
        api_ng:"API: Offline"
      },
      "zh-CN": {
        title: "欢迎来到 MeAI",
        desc:  "通过“照料”建立情感、用对话记录生活。积分累积后生日曲完成并进化！",
        start: "开始",
        cont:  "继续",
        about: "关于本研究",
        note:  "语言设置会在下次访问时保留。",
        api_ok:"API：在线",
        api_ng:"API：离线"
      },
      "zh-TW": {
        title: "歡迎來到 MeAI",
        desc:  "用「照顧」培養連結、以對話記錄生活。累積點數後生日曲完成並進化！",
        start: "開始",
        cont:  "從上次繼續",
        about: "關於本研究",
        note:  "語言設定會在下次造訪時保留。",
        api_ok:"API：在線",
        api_ng:"API：離線"
      },
      "ko": {
        title: "MeAI에 오신 것을 환영합니다",
        desc:  "돌봄으로 유대가 자라고, 대화로 하루를 기록해요. 포인트가 모이면 생일 노래가 완성되고 진화합니다.",
        start: "시작하기",
        cont:  "이어하기",
        about: "연구 소개",
        note:  "언어 설정은 다음 방문 시에도 유지됩니다.",
        api_ok:"API: 온라인",
        api_ng:"API: 오프라인"
      }
    };

    function applyLang(lang){
      const t = I18N[lang] || I18N.ja;
      document.documentElement.lang = lang.startsWith('zh') ? 'zh' : lang;
      document.getElementById('t_title').textContent = t.title;
      document.getElementById('t_desc').textContent  = t.desc;
      document.getElementById('t_start').textContent = t.start;
      document.getElementById('t_about').textContent = t.about;
      document.getElementById('t_note').textContent  = t.note;

      const contBtn = document.getElementById('t_continue');
      if (contBtn.style.display !== 'none') contBtn.textContent = t.cont;

      // APIバッジ文言も更新
      const apiText = document.getElementById('api_text');
      const dot = document.getElementById('api_dot');
      if (dot.classList.contains('ok')) apiText.textContent = t.api_ok;
      else apiText.textContent = t.api_ng;
    }
    function setLang(lang){ localStorage.setItem(LS.LANG, lang); applyLang(lang); }

    /* ====== ルーティング ======
      - Start: プロフィールが無ければ name_first.html、あれば meai_home.html
      - Continue: 進行状況で分岐
    */
    function startFlow(){
      const hasName = !!localStorage.getItem(LS.USER_NAME);
      const hasChar = !!localStorage.getItem(LS.CHAR_NAME);
      if (!hasName || !hasChar) {
        location.href = 'name_first.html'; // あなたの名前→キャラ名の順（要件反映）
        return;
      }
      location.href = 'meai_home.html';
    }

    function continueFlow(){
      const step = localStorage.getItem(LS.PROGRESS); // 'seed' | 'care' | 'talk' | 'evolved'
      switch(step){
        case 'seed':     location.href = 'seed_select.html'; break;
        case 'care':     location.href = 'care.html'; break;           // お世話画面（WhoAIのケア流用）
        case 'talk':     location.href = 'talk.html'; break;           // 会話画面（TALK_ENDPOINT連携）
        case 'evolved':  location.href = 'evolved.html'; break;        // HBD演奏後の進化画面
        default:         location.href = 'meai_home.html'; break;      // ホーム（提案・ご褒美・ログ等）
      }
    }

    /* ====== API起動チェック ======
       - まず HEAD を試行（CORSで落ちる場合GET）
       - 成功で Online、失敗で Offline
    */
    async function checkAPI(){
      const apiText = document.getElementById('api_text');
      const dot = document.getElementById('api_dot');
      const lang = localStorage.getItem(LS.LANG) || detectLang();
      const t = I18N[lang] || I18N.ja;

      async function tryFetch(method){
        try{
          const res = await fetch(TALK_ENDPOINT, { method, mode:'cors' });
          return res && (res.ok || (res.status >= 200 && res.status < 500));
        }catch(_e){ return false; }
      }

      let ok = await tryFetch('HEAD');
      if (!ok) ok = await tryFetch('GET');

      if (ok){
        dot.classList.remove('ng'); dot.classList.add('ok');
        apiText.textContent = t.api_ok;
      }else{
        dot.classList.remove('ok'); dot.classList.add('ng');
        apiText.textContent = t.api_ng;
      }
    }

    function detectLang(){
      const browser = (navigator.language || 'ja').toLowerCase();
      return (['ja','en','zh-cn','zh-tw','ko'].find(k => browser.startsWith(k)) || 'ja');
    }

    /* ====== 初期化 ====== */
    (function init(){
      // 言語
      const savedLang = localStorage.getItem(LS.LANG) || detectLang();
      applyLang(savedLang);

      // 進行状況がある場合のみ「つづきから」を表示
      const hasProgress = !!localStorage.getItem(LS.PROGRESS);
      if (hasProgress) document.getElementById('t_continue').style.display = '';

      // APIチェック
      checkAPI();
    })();
  </script>
</body>
</html>
