<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI Prototype</title>
<style>
  /* ===== èƒŒæ™¯ï¼ˆå®‡å®™ï¼‰ ===== */
  html, body { height:100%; }
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
    color:#fff;
  }

  /* ãã‚‰ã‚ãæ˜Ÿå±¤ï¼ˆè»½é‡ã‚¢ãƒ‹ãƒ¡ï¼‰ */
  .stars, .stars::after{
    position:fixed; inset:0; content:"";
    background: radial-gradient(white 1px, transparent 1px) 0 0/3px 3px;
    opacity:.23; animation: twinkle 8s linear infinite; pointer-events:none; z-index:1;
  }
  .stars::after{ animation-duration:12s; opacity:.16; filter:blur(.4px) brightness(1.2); }
  @keyframes twinkle{ 0%{transform:translateY(0)} 100%{transform:translateY(-40px)} }

  /* ç”»é¢ãƒ¬ã‚¤ãƒ¤ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«æœ€å‰é¢ï¼‰ */
  .screen{ position:fixed; inset:0; display:none; z-index:5; }
  .show{ display:block; }

  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ */
  .center{
    width:min(92vw, 920px); margin:10vh auto 0; display:grid;
    grid-template-columns: 140px 1fr; gap:20px;
    background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.2);
    border-radius:24px; padding:24px; backdrop-filter: blur(8px);
    box-shadow:0 20px 60px rgba(0,0,0,.5);
  }
  .brand{display:grid; place-items:center;}
  .brand img{ width:110px; height:110px; object-fit:contain; filter:drop-shadow(0 6px 10px rgba(0,0,0,.5));}
  h1{margin:.1em 0 .2em; font-size:40px}
  .lead{opacity:.95; margin:0 0 14px; line-height:1.6}

  .btn{
    display:block; width:100%; margin:8px 0; padding:12px 16px;
    border:none; border-radius:12px; cursor:pointer; color:#fff;
    background:rgba(255,255,255,.18); transition:.2s; font-size:16px;
  }
  .btn:hover{ background:rgba(255,255,255,.28); }
  .btn.secondary{ background:rgba(255,255,255,.1); }

  /* ã‚­ãƒ£ãƒ©é¸æŠ */
  .panel{ width:min(92vw, 680px); margin:10vh auto; background:rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:22px; backdrop-filter:blur(6px); }
  .grid{ display:flex; flex-wrap:wrap; gap:14px; justify-content:center; margin-top:6px; }
  .char{
    width:92px; height:92px; border-radius:50%; border:1px solid rgba(255,255,255,.22);
    display:grid; place-items:center; background:rgba(255,255,255,.12); cursor:pointer; transition:.2s;
  }
  .char img{ width:70px; height:70px; object-fit:contain; }
  .char:hover{ transform:scale(1.06); box-shadow:0 0 0 3px rgba(255,255,255,.22) inset; }

  /* ãƒ¡ã‚¤ãƒ³ */
  #header{
    position:fixed; left:50%; transform:translateX(-50%); top:10px; z-index:7;
    background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.2);
    border-radius:999px; padding:8px 12px; display:flex; gap:12px; align-items:center;
  }
  #header img{ width:30px; height:30px; }
  #heart{ font-size:18px; }

  #chat{
    width:min(92vw, 900px); height:min(64vh, 460px);
    margin:100px auto 10px; padding:18px; overflow-y:auto; z-index:6; position:relative;
    background:rgba(0,0,0,.42); border:1px solid rgba(255,255,255,.18); border-radius:16px;
  }
  .bubble{max-width:78%; margin:10px 0; padding:12px 14px; border-radius:14px; line-height:1.6; font-size:18px}
  .ai {background:rgba(120,200,255,.24); border:1px solid rgba(120,200,255,.34); float:left; clear:both;}
  .user{background:rgba(255,255,255,.24); border:1px solid rgba(255,255,255,.34); float:right; clear:both;}

  #composer{
    width:min(92vw, 900px); margin:8px auto 0; display:flex; gap:8px; z-index:7; position:relative;
  }
  #input{
    flex:1; padding:12px 14px; border:none; border-radius:12px; color:#fff; font-size:16px;
    background:rgba(255,255,255,.16); outline:none;
  }
  #send{ padding:12px 16px; }
  #done{ padding:12px 16px; background:rgba(0,200,120,.35); }
  #done:hover{ background:rgba(0,200,120,.5); }

  #footerMenu{ position:fixed; bottom:12px; left:50%; transform:translateX(-50%); z-index:7; }
  #footerMenu .btn{ display:inline-block; width:auto; padding:8px 14px; }

  /* === ç”»é¢å†…ã«å±…ç¶šã‘ã‚‹â€œæ¼‚ã†ãƒã‚¹ã‚³ãƒƒãƒˆâ€ === */
  #pet{
    position: fixed;
    left: 50vw;   /* JSã§pxã«ä¸Šæ›¸ã */
    top:  60vh;   /* JSã§pxã«ä¸Šæ›¸ã */
    width: 120px; height: 120px;
    pointer-events: none;
    z-index: 4;
    transition: left 12s ease-in-out, top 12s ease-in-out; /* transformã¯ä½¿ã‚ãªã„ */
    display: none;  /* ã‚¿ã‚¤ãƒˆãƒ«ã§ã¯éè¡¨ç¤ºã€ãƒ¡ã‚¤ãƒ³ã§è¡¨ç¤º */
  }
  #pet img{
    width:100%; height:100%; object-fit:contain;
    filter: drop-shadow(0 8px 18px rgba(0,0,0,.45));
    animation: pet-breathe 3.6s ease-in-out infinite;
  }
  @keyframes pet-breathe{
    0%,100%{ transform: translateY(0) scale(1); }
    50%    { transform: translateY(-6px) scale(1.02); }
  }
  #pet.pop img{ animation: pet-pop .6s ease; }
  @keyframes pet-pop{ 0%{transform:scale(1)} 40%{transform:scale(1.12)} 100%{transform:scale(1)} }

  @media (max-width:560px){
    h1{font-size:30px}
    .center{ grid-template-columns: 1fr; text-align:center; }
    .brand{ order:-1; }
  }
</style>
</head>
<body>
  <div class="stars"></div>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <section id="title" class="screen show">
    <div class="center">
      <div class="brand"><img src="public/char/green/calm.png" alt="mascot"></div>
      <div>
        <h1>MeAI</h1>
        <p class="lead">â€œç”Ÿæ´»ã«å¯„ã‚Šæ·»ã†ãŠé¡˜ã„â€ã‚’å—ã‘å–ã‚Šã€<br>ã€Œã¯ã„ã€ã‚„ã£ãŸã‚ˆã€ã§è‡ªå·±ç”³å‘Šã—ã¦è¨˜éŒ²ã™ã‚‹ãƒŸãƒ‹ã‚¢ãƒ—ãƒªã§ã™ã€‚<br>â€» ç›£è¦–ã¯ã—ã¾ã›ã‚“ã€‚ãƒœã‚¿ãƒ³/æ–‡å­—å…¥åŠ›ã§è¨˜éŒ²ã™ã‚‹ã ã‘ã€‚</p>
        <button id="start" class="btn" type="button">ã¯ã˜ã‚ã‹ã‚‰</button>
        <button id="cont" class="btn" type="button">ã¤ã¥ãã‹ã‚‰</button>
        <button id="about" class="btn secondary" type="button">ã“ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦</button>
        <p id="savestate" style="opacity:.9;margin-top:8px;"></p>
      </div>
    </div>
  </section>

  <!-- ã‚­ãƒ£ãƒ©é¸æŠ -->
  <section id="choose" class="screen">
    <div class="panel">
      <h2 style="margin:0 0 8px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­</h2>
      <div class="grid">
        <div class="char" data-char="green"><img src="public/char/green/calm.png" alt="green"></div>
        <div class="char" data-char="blue"><img src="public/char/blue/calm.png" alt="blue"></div>
        <div class="char" data-char="pink"><img src="public/char/pink/calm.png" alt="pink"></div>
        <div class="char" data-char="purple"><img src="public/char/purple/calm.png" alt="purple"></div>
      </div>
      <button id="backTitle" class="btn" type="button" style="margin-top:14px; width:auto;">â† ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>
  </section>

  <!-- ãƒ¡ã‚¤ãƒ³ -->
  <section id="main" class="screen">
    <div id="header">
      <img id="charIcon" src="" alt="char">
      <div id="heart">â¤ï¸ Ã— <span id="heartCount">0</span></div>
      <div id="sessionInfo" style="opacity:.85;"></div>
    </div>

    <div id="chat" aria-live="polite"></div>

    <div id="composer">
      <input id="input" type="text" placeholder="è¿”ç­”ã‚’å…¥åŠ›â€¦ï¼ˆEnterã§é€ä¿¡ï¼‰" />
      <button id="send" class="btn" type="button">é€ä¿¡</button>
      <button id="done" class="btn" type="button">ã‚„ã£ãŸã‚ˆ</button>
    </div>

    <div id="footerMenu">
      <button id="toTitle" class="btn secondary" type="button">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
      <button id="showLog" class="btn secondary" type="button">ãƒ­ã‚°ã‚’ç¢ºèª</button>
      <button id="reset" class="btn secondary" type="button">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
    </div>
  </section>

  <!-- ç”»é¢ã‚’æ¼‚ã†ãƒã‚¹ã‚³ãƒƒãƒˆï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
  <div id="pet"><img id="petImg" src="" alt="pet"></div>

<script>
  // ã™ã¹ã¦DOMæ§‹ç¯‰å¾Œã«åˆæœŸåŒ–
  window.addEventListener('DOMContentLoaded', () => {
    const $ = s => document.querySelector(s);

    const scrTitle = $('#title'), scrChoose = $('#choose'), scrMain = $('#main');
    const btnStart = $('#start'), btnCont = $('#cont'), btnAbout = $('#about'), saveState = $('#savestate');
    const btnBackTitle = $('#backTitle'), btnToTitle = $('#toTitle'), btnReset = $('#reset'), btnShowLog = $('#showLog');
    const chat = $('#chat'), input = $('#input'), btnSend = $('#send'), btnDone = $('#done');
    const heartCountEl = $('#heartCount'), charIcon = $('#charIcon'), sessionInfo = $('#sessionInfo');
    const pet = $('#pet'), petImg = $('#petImg');

    const K = { char:'meai_character', hearts:'meai_heart', log:'meai_log' };
    let character = localStorage.getItem(K.char) || null;
    let hearts = parseInt(localStorage.getItem(K.hearts) || '0', 10);
    let log = JSON.parse(localStorage.getItem(K.log) || '[]');

    function show(el){ [scrTitle,scrChoose,scrMain].forEach(s=>s.classList.remove('show')); el.classList.add('show'); }
    function refreshTitle(){
      const has = !!localStorage.getItem(K.char);
      btnCont.disabled = !has;
      saveState.textContent = has ? 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã€Œã¤ã¥ãã‹ã‚‰ã€ã§å†é–‹ã§ãã¾ã™ã€‚' : 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      show(scrTitle);
      pet.style.display = 'none'; // ã‚¿ã‚¤ãƒˆãƒ«ã§ã¯éè¡¨ç¤º
    }
    refreshTitle();

    // ã‚¿ã‚¤ãƒˆãƒ«
    btnStart.addEventListener('click', ()=> show(scrChoose));
    btnCont.addEventListener('click', ()=>{
      if(!localStorage.getItem(K.char)){ alert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
      startMain(false);
    });
    btnAbout.addEventListener('click', ()=> alert('ã“ã®è©¦ä½œã¯AIãŒç›£è¦–ã™ã‚‹ã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå·±ç”³å‘Šï¼ˆã€Œã‚„ã£ãŸã‚ˆã€ï¼‰ã§è¨˜éŒ²ã™ã‚‹ã ã‘ã®è¨­è¨ˆã§ã™ã€‚'));

    // ã‚­ãƒ£ãƒ©é¸æŠ
    document.querySelectorAll('.char').forEach(el=>{
      el.addEventListener('click', ()=>{
        character = el.dataset.char;
        localStorage.setItem(K.char, character);
        hearts = parseInt(localStorage.getItem(K.hearts) || '0',10);
        if(!Array.isArray(log)) log=[];
        startMain(true);
      });
    });
    btnBackTitle.addEventListener('click', refreshTitle);

    // ãƒ¡ã‚¤ãƒ³é–‹å§‹
    function startMain(newSession){
      charIcon.src = `public/char/${character}/calm.png`;
      heartCountEl.textContent = hearts;
      sessionInfo.textContent = newSession ? 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³' : 'ã¤ã¥ãã‹ã‚‰';

      // ãƒšãƒƒãƒˆè¡¨ç¤ºãƒ»ç§»å‹•é–‹å§‹ï¼ˆç”»é¢å†…ä¿è¨¼ï¼‰
      petImg.src = `public/char/${character}/calm.png`;
      pet.style.display = 'block';
      clearTimeout(pet._timer);
      petMoveLoop();

      chat.innerHTML='';
      if(newSession || log.length===0){
        push('ai', firstRequest(character));
        saveAll();
      }else{
        log.forEach(m=>append(m.sender,m.text));
        chat.scrollTop = chat.scrollHeight;
      }
      show(scrMain);
      setTimeout(()=>input.focus(), 10);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
    function append(sender, text){
      const div = document.createElement('div');
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function push(sender, text){
      log.push({sender, text, ts:Date.now()});
      append(sender, text);
    }
    function aiReplyAfter(text){
      if(/ã‚„ã£ãŸ/.test(text)){
        hearts++;
        heartCountEl.textContent = hearts;
        push('ai','ã™ã°ã‚‰ã—ã„ï¼ãƒãƒ¼ãƒˆãŒå¢—ãˆãŸã‚ˆğŸ’–');
        push('ai', randomRequest());
        pet.classList.add('pop'); setTimeout(()=>pet.classList.remove('pop'), 600);
      }else{
        push('ai','ã†ã‚“ã€ãªã‚‹ã»ã©ã­ã€‚');
      }
      saveAll();
    }
    function send(){
      const t = input.value.trim(); if(!t) return;
      push('user', t); input.value = ''; aiReplyAfter(t);
    }
    btnSend.addEventListener('click', send);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
    btnDone.addEventListener('click', ()=>{ push('user','ã‚„ã£ãŸã‚ˆ'); aiReplyAfter('ã‚„ã£ãŸã‚ˆ'); });

    // è£œåŠ©ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    btnToTitle.addEventListener('click', refreshTitle);
    btnReset.addEventListener('click', ()=>{
      if(confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚­ãƒ£ãƒ©ãƒ»ãƒãƒ¼ãƒˆãƒ»ãƒ­ã‚°ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){
        localStorage.removeItem(K.char); localStorage.removeItem(K.hearts); localStorage.removeItem(K.log);
        character=null; hearts=0; log=[]; refreshTitle();
      }
    });
    btnShowLog.addEventListener('click', ()=>{
      const text = log.map(l=>`${new Date(l.ts).toLocaleString()} [${l.sender}] ${l.text}`).join('\n') || 'ï¼ˆãƒ­ã‚°ãªã—ï¼‰';
      alert(text);
    });

    // æ–‡è¨€
   // æ–‡è¨€ï¼ˆ30ä»¶ï¼‰
const REQUESTS = [
  "ãŠã¯ã‚ˆã†ã£ã¦è¨€ã£ã¦ã€‚",
  "ã‚³ãƒƒãƒ—ä¸€æ¯ã®ãŠæ°´ã‚’é£²ã‚“ã§ã¿ã¦ã€‚",
  "5ç§’ã ã‘ã€é™ã‹ã«ç›®ã‚’é–‰ã˜ã¦ã¿ã‚ˆã†ã€‚",
  "ä»Šæ—¥ã®ç©ºã®è‰²ã‚’ã²ã¨ã“ã¨ã§æ•™ãˆã¦ã€‚",
  "çª“ã‚’å°‘ã—é–‹ã‘ã¦ã€ç©ºæ°—ã‚’å…¥ã‚Œæ›¿ãˆã‚ˆã†ã€‚",
  "æ·±å‘¼å¸ã‚’3å›ã—ã¦ã¿ã‚ˆã†ã€‚",
  "å¥½ããªéŸ³ã‚’5ç§’ã ã‘èã‹ã›ã¦ã€‚ï¼ˆå¿ƒã®ä¸­ã§ã‚‚OKï¼‰",
  "èŠ±ã‚„æ¤ç‰©ã‚’ã²ã¨ã¤æ€ã„æµ®ã‹ã¹ã¦ã€åå‰ã‚’æ•™ãˆã¦ã€‚",
  "ä»Šã„ã‚‹éƒ¨å±‹ã§ã€ã‚„ã•ã—ã„è‰²ã‚’æ¢ã—ã¦æ•™ãˆã¦ã€‚",
  "å§¿å‹¢ã‚’ã™ã“ã—ä¼¸ã°ã—ã¦ã€è‚©ã‚’å›ã—ã¦ã¿ã‚ˆã†ã€‚",
  "ã‚«ãƒ¼ãƒ†ãƒ³ã‚’å°‘ã—é–‹ã‘ã¦ã€æ˜ã‚‹ã•ã‚’æ„Ÿã˜ã¦ã¿ã¦ã€‚",
  "ãŠã‚„ã¤ã‹é£²ã¿ç‰©ã‚’ã²ã¨å£ã€å‘³ã‚ã£ã¦ã¿ã‚ˆã†ã€‚",
  "æœºã®ä¸Šã‚’10ç§’ã ã‘æ•´ãˆã¦ã¿ã‚ˆã†ã€‚",
  "ç›®ã®å‰ã®â€œä¸¸ã„å½¢â€ã‚’ã²ã¨ã¤è¦‹ã¤ã‘ã¦æ•™ãˆã¦ã€‚",
  "è€³ã‚’ã™ã¾ã›ã¦ã€ã„ã¡ã°ã‚“å°ã•ãªéŸ³ã‚’æ¢ã—ã¦ã¿ã‚ˆã†ã€‚",
  "æ‰‹ã‚’æ¸©ã‚ãŸã‚Šã€å†·ãŸã„ã‚‚ã®ã«è§¦ã‚ŒãŸã‚Šã—ã¦ã€æ„Ÿè§¦ã‚’æ•™ãˆã¦ã€‚",
  "ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’å¿ƒã®ä¸­ã§1å›è¨€ã£ã¦ã¿ã‚ˆã†ã€‚",
  "å¤–ã®é¢¨ã‚„ç©ºæ°—ã®æ¸©åº¦ã‚’æ„Ÿã˜ã¦ã€ã²ã¨è¨€ã§æ•™ãˆã¦ã€‚",
  "æ™‚è¨ˆã®éŸ³ã€ã‚ã‚‹ï¼Ÿãªã„ï¼Ÿ",
  "ä»Šã®æ°—åˆ†ã‚’å¤©æ°—ã§è¨€ã†ã¨ï¼Ÿï¼ˆæ™´ã‚Œ/æ›‡ã‚Š/é›¨/é›ª/é¢¨ï¼‰",
  "å¥½ããªè¨€è‘‰ã‚’ã²ã¨ã¤æ€ã„å‡ºã—ã¦ã€æ•™ãˆã¦ã€‚",
  "éƒ¨å±‹ã®ä¸­ã§â€œã‚„ã‚ã‚‰ã‹ã„ã‚‚ã®â€ã‚’è§¦ã£ã¦ã¿ã‚ˆã†ã€‚",
  "çª“ã®å¤–ã‚’10ç§’è¦‹ã¦ã€æ°—ã¥ã„ãŸã“ã¨ã‚’ã²ã¨è¨€ã€‚",
  "ã‚¹ãƒãƒ›ã‚’è£å‘ãã«ã—ã¦10ç§’ç½®ã„ã¦ã¿ã‚ˆã†ã€‚",
  "ã‚†ã£ãã‚Šé¦–ã‚’å·¦å³ã«å›ã—ã¦ã€ã“ã‚Šå…·åˆã‚’æ•™ãˆã¦ã€‚",
  "ä»Šæ—¥ã®è‰²ã‚’ã²ã¨ã¤é¸ã‚“ã§ã€æ•™ãˆã¦ã€‚",
  "ä»Šã®éŸ³é‡ï¼ˆé™ã‹/ãµã¤ã†/ã«ãã‚„ã‹ï¼‰ã‚’æ•™ãˆã¦ã€‚",
  "å¥½ããªåŒ‚ã„ã‚’ã²ã¨ã¤æ€ã„å‡ºã—ã¦ã€æ•™ãˆã¦ã€‚",
  "â€œãŠã‹ãˆã‚Šâ€ã£ã¦è¨€ã£ã¦ã¿ã¦ã€‚",
  "â€œãŠã‚„ã™ã¿â€ã£ã¦è¨€ã£ã¦ãã‚Œã‚‹ï¼Ÿ"
];

    ];
    function randomRequest(){ return REQUESTS[Math.floor(Math.random()*REQUESTS.length)]; }
    function firstRequest(char){
      const tag = {green:"ï¼ˆã‚„ã•ã—ãï¼‰", blue:"ï¼ˆã¦ã„ã­ã„ã«ï¼‰", pink:"ï¼ˆã‚ãã‚ãï¼‰", purple:"ï¼ˆãŠã¡ã¤ã„ã¦ï¼‰"}[char] || "";
      return `${tag} ${randomRequest()}`;
    }

    // ä¿å­˜
    function saveAll(){
      localStorage.setItem(K.hearts, String(hearts));
      localStorage.setItem(K.log, JSON.stringify(log));
    }

    /* ===== ç”»é¢å†…ã«å¿…ãšåã¾ã‚‹â€œæ¼‚ã„â€ãƒ­ã‚¸ãƒƒã‚¯ ===== */
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function petRandomPos(){
      const pad = 24, size = 120;
      const W = window.innerWidth;
      const H = window.innerHeight;

      let x = pad + Math.random() * (W - size - pad*2);
      let y = pad + Math.random() * (H - size - pad*2);

      const r = document.getElementById('chat')?.getBoundingClientRect();
      if (r) {
        const overlaps = (x < r.right && x+size > r.left && y < r.bottom && y+size > r.top);
        if (overlaps) {
          x = clamp(r.right + 40, pad, W - size - pad);
          y = clamp(y + 20, pad, H - size - pad);
        }
      }
      x = clamp(x, pad, W - size - pad);
      y = clamp(y, pad, H - size - pad);
      return {x,y};
    }

    function petMoveLoop(){
      const p = petRandomPos();
      pet.style.left = p.x + 'px';
      pet.style.top  = p.y + 'px';
      const next = 8000 + Math.random()*6000; // 8ã€œ14ç§’
      clearTimeout(pet._timer);
      pet._timer = setTimeout(petMoveLoop, next);
    }

    window.addEventListener('resize', ()=>{
      clearTimeout(pet._timer);
      petMoveLoop();
    });

    // å®‰å…¨ã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼ï¼ˆå¿µã®ãŸã‚ï¼‰
    setInterval(()=>{
      if (pet.style.display === 'none') return;
      const pad = 24, size = 120;
      const W = window.innerWidth, H = window.innerHeight;
      const x = parseFloat(pet.style.left) || 0;
      const y = parseFloat(pet.style.top)  || 0;
      const nx = clamp(x, pad, W - size - pad);
      const ny = clamp(y, pad, H - size - pad);
      if (nx !== x) pet.style.left = nx + 'px';
      if (ny !== y) pet.style.top  = ny + 'px';
    }, 1500);
  });
</script>
</body>
</html>
