<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI Prototype (safe start)</title>
<link rel="icon" href="data:,">
<style>
  html, body { height:100%; }
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
    color:#fff;
  }

  /* ===== å…±é€š ===== */
  .hidden{ display:none !important; }

  .glass{
    background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.16);
    border-radius:20px; backdrop-filter:blur(8px);
  }
  .btn{
    display:inline-flex; align-items:center; gap:.5em;
    border:none; border-radius:999px; padding:12px 18px; cursor:pointer; color:#fff;
    background:rgba(255,255,255,.18);
  }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }
  .btn.primary{ background:linear-gradient(180deg,#ff8bd2,#ff6db3 60%,#ff55a1); color:#231227; }

  /* ===== ç”»é¢ ===== */
  .screen{ min-height:100dvh; display:grid; place-items:center; padding:24px; }
  .container{ width:min(92vw, 960px); margin:auto; }

  /* ===== è¡¨ç´™ ===== */
  .cover-card{ text-align:center; padding:28px; border-radius:28px; }
  .cover-illust{ width:180px; height:180px; object-fit:contain; filter:drop-shadow(0 8px 22px rgba(0,0,0,.6)); }
  .cover-title{ font-size:40px; font-weight:800; margin:16px 0 8px; }
  .cover-sub{ opacity:.92; margin:0 0 18px; }

  /* ===== ã‚¿ã‚¤ãƒˆãƒ« ===== */
  .title-grid{ display:grid; grid-template-columns:140px 1fr; gap:20px; align-items:center; }
  .brand img{ width:110px; height:110px; object-fit:contain; }
  .lead{ opacity:.95; line-height:1.7; }

  /* ===== ã‚­ãƒ£ãƒ©é¸æŠ ===== */
  .grid{ display:flex; flex-wrap:wrap; gap:12px; }
  .char{ width:92px; height:92px; border-radius:50%; border:1px solid rgba(255,255,255,.22);
         display:grid; place-items:center; background:rgba(255,255,255,.10); cursor:pointer; }
  .char img{ width:70px; height:70px; object-fit:contain; }

  /* ===== ãƒ¡ã‚¤ãƒ³ ===== */
  #header{ display:flex; gap:12px; align-items:center; padding:8px 12px; border-radius:999px; margin:10px auto 12px; width:max-content; }
  #chat{ height:min(60vh,460px); overflow:auto; padding:16px; border-radius:16px; }
  .bubble{ max-width:78%; margin:10px 0; padding:12px 16px; border-radius:16px; line-height:1.7; font-size:18px; }
  .ai{ background:linear-gradient(145deg, rgba(150,220,255,.28), rgba(150,200,255,.14)); border:1px solid rgba(150,220,255,.34); float:left; clear:both; }
  .user{ background:linear-gradient(145deg, rgba(255,255,255,.26), rgba(255,255,255,.12)); border:1px solid rgba(255,255,255,.28); float:right; clear:both; }
  #composer{ display:flex; gap:8px; margin:10px 0; }
  #input{ flex:1; padding:12px 14px; border:none; border-radius:12px; color:#fff; background:rgba(255,255,255,.14); }
  #footerMenu{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:10px 0 20px; }
</style>
</head>
<body>

<!-- ===== è¡¨ç´™ ===== -->
<section id="cover" class="screen">
  <div class="container">
    <div class="glass cover-card">
      <img class="cover-illust" src="public/miwacchi_open.png" alt="MeAI cover" onerror="this.src='public/cover.png'">
      <div class="cover-title">MeAI</div>
      <p class="cover-sub">å°ã•ãªâ€œã‚„ã£ã¦ã¿ã‚‹â€ã‚’ã€ã‚„ã•ã—ãææ¡ˆã—ã¦ãã‚Œã‚‹ç›¸æ£’ã€‚</p>
      <button id="coverStart" class="btn primary" type="button">â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>
</section>

<!-- ===== ã‚¿ã‚¤ãƒˆãƒ« ===== -->
<section id="title" class="screen hidden">
  <div class="container glass" style="padding:20px;">
    <div class="title-grid">
      <div class="brand"><img src="public/char/green/calm.png" alt=""></div>
      <div>
        <h1 style="margin:.2em 0 .1em;">MeAI</h1>
        <p class="lead">â€œç”Ÿæ´»ã«å¯„ã‚Šæ·»ã†ãŠé¡˜ã„â€ã‚’å—ã‘å–ã‚Šã€<br>ã€Œã¯ã„ã€ã‚„ã£ãŸã‚ˆã€ã§è‡ªå·±ç”³å‘Šã—ã¦è¨˜éŒ²ã™ã‚‹ãƒŸãƒ‹ã‚¢ãƒ—ãƒªã§ã™ã€‚<br>â€» ç›£è¦–ã¯ã—ã¾ã›ã‚“ã€‚ãƒœã‚¿ãƒ³/æ–‡å­—å…¥åŠ›ã§è¨˜éŒ²ã™ã‚‹ã ã‘ã€‚</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="start" class="btn" type="button">ã¯ã˜ã‚ã‹ã‚‰</button>
          <button id="cont"  class="btn" type="button">ã¤ã¥ãã‹ã‚‰</button>
          <button id="about" class="btn" type="button">ã“ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦</button>
        </div>
        <p id="savestate" style="opacity:.9;margin-top:8px;"></p>
      </div>
    </div>
  </div>
</section>

<!-- ===== ã‚­ãƒ£ãƒ©é¸æŠ ===== -->
<section id="choose" class="screen hidden">
  <div class="container glass" style="padding:18px;">
    <h2 style="margin:6px 0 12px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­</h2>
    <div class="grid" id="charGrid">
      <button class="char" data-char="green" type="button" aria-label="green"><img src="public/char/green/calm.png" alt=""></button>
      <button class="char" data-char="blue"  type="button" aria-label="blue"><img  src="public/char/blue/calm.png"  alt=""></button>
      <button class="char" data-char="pink"  type="button" aria-label="pink"><img  src="public/char/pink/calm.png"  alt=""></button>
      <button class="char" data-char="purple"type="button" aria-label="purple"><img src="public/char/purple/calm.png"alt=""></button>
    </div>
    <div style="margin-top:14px;"><button id="backTitle" class="btn" type="button">â† ã‚¿ã‚¤ãƒˆãƒ«ã¸</button></div>
  </div>
</section>

<!-- ===== ãƒ¡ã‚¤ãƒ³ ===== -->
<section id="main" class="screen hidden">
  <div class="container">
    <div id="header" class="glass">
      <img id="charIcon" src="" alt="" width="30" height="30">
      <div id="heart">â¤ï¸ Ã— <span id="heartCount">0</span></div>
      <div id="sessionInfo" style="opacity:.85;"></div>
    </div>

    <div id="chat" class="glass" aria-live="polite"></div>

    <div id="composer">
      <input id="input" class="glass" type="text" placeholder="è¿”ç­”ã‚’å…¥åŠ›â€¦ï¼ˆEnterã§é€ä¿¡ï¼‰" />
      <button id="send" class="btn" type="button">é€ä¿¡</button>
      <button id="done" class="btn" type="button">ã‚„ã£ãŸã‚ˆ</button>
    </div>

    <div id="footerMenu">
      <button id="toTitle" class="btn" type="button">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
      <button id="showLog" class="btn" type="button">ãƒ­ã‚°ã‚’ç¢ºèª</button>
      <button id="reset" class="btn" type="button">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
    </div>
  </div>
</section>

<script>
(function(){
  // ===== å®‰å…¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const on = (el,ev,fn,opt)=>{ if(el) el.addEventListener(ev,fn,opt||false); };

  // ç”»é¢
  const scr = {
    cover: $('#cover'),
    title: $('#title'),
    choose: $('#choose'),
    main:  $('#main')
  };
  function show(id){
    Object.values(scr).forEach(el=>el && el.classList.add('hidden'));
    scr[id]?.classList.remove('hidden');
  }

  // DOM
  const btnCoverStart = $('#coverStart');
  const btnStart = $('#start'), btnCont = $('#cont'), btnAbout = $('#about'), saveState = $('#savestate');
  const btnBackTitle = $('#backTitle'), btnToTitle = $('#toTitle'), btnReset = $('#reset'), btnShowLog = $('#showLog');
  const chat = $('#chat'), input = $('#input'), btnSend = $('#send'), btnDone = $('#done');
  const heartCountEl = $('#heartCount'), charIcon = $('#charIcon'), sessionInfo = $('#sessionInfo');

  // ä¿å­˜ã‚­ãƒ¼
  const K = {
    char:'meai_character',
    hearts:'meai_heart',
    log:'meai_log',
    next:'meai_next_due'
  };

  // çŠ¶æ…‹
  let character = get(K.char);
  let hearts = toInt(get(K.hearts),0);
  let log = toArray(get(K.log),[]);
  let nextTimer=null, labelTimer=null;

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function get(k){ try{return localStorage.getItem(k)}catch{return null} }
  function set(k,v){ try{localStorage.setItem(k,v)}catch{} }
  function del(k){ try{localStorage.removeItem(k)}catch{} }
  function toInt(v,d=0){ const n=parseInt(v,10); return Number.isFinite(n)?n:d; }
  function toArray(raw,f=[]){ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return Array.isArray(v)?v:f }catch{ return f } }

  // ãƒãƒ£ãƒƒãƒˆ
  function append(sender,text){
    const d=document.createElement('div');
    d.className='bubble '+sender;
    d.textContent=text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }
  function push(sender,text){
    const item={sender,text,ts:Date.now()};
    log.push(item);
    append(sender,text);
  }
  function saveAll(){
    set(K.hearts,String(hearts));
    set(K.log,JSON.stringify(log));
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  const REQUESTS=[
    "ãŠã¯ã‚ˆã†ã£ã¦è¨€ã£ã¦ã€‚","ã‚³ãƒƒãƒ—ä¸€æ¯ã®ãŠæ°´ã‚’é£²ã‚“ã§ã¿ã¦ã€‚","5ç§’ã ã‘ã€é™ã‹ã«ç›®ã‚’é–‰ã˜ã¦ã¿ã‚ˆã†ã€‚",
    "ä»Šæ—¥ã®ç©ºã®è‰²ã‚’ã²ã¨ã“ã¨ã§æ•™ãˆã¦ã€‚","æ·±å‘¼å¸ã‚’3å›ã—ã¦ã¿ã‚ˆã†ã€‚"
  ];
  function pick(){ return REQUESTS[Math.floor(Math.random()*REQUESTS.length)] }
  function firstRequest(c){
    const tag={green:"ï¼ˆã‚„ã•ã—ãï¼‰",blue:"ï¼ˆã¦ã„ã­ã„ã«ï¼‰",pink:"ï¼ˆã‚ãã‚ãï¼‰",purple:"ï¼ˆãŠã¡ã¤ã„ã¦ï¼‰"}[c]||"";
    return `${tag} ${pick()}`;
  }

  // ã€Œã‚„ã£ãŸã‚ˆã€ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ 
  function canDoneNow(){
    const due = toInt(get(K.next),0);
    return !due || due<=Date.now();
  }
  function setNextAfterHours(h){
    const due = Date.now() + Math.round(h*3600*1000);
    set(K.next,String(due));
    updateDoneState();
    startNextTimer();
    startLabelTimer();
  }
  function updateDoneState(){
    const due = toInt(get(K.next),0);
    const disabled = due && due>Date.now();
    btnDone.disabled = !!disabled;
    if(disabled){
      const left = due-Date.now();
      btnDone.textContent = "ã‚ã¨" + countdown(left);
    }else{
      btnDone.textContent = "ã‚„ã£ãŸã‚ˆ";
    }
  }
  function countdown(ms){
    if(ms<=0) return "";
    const s=Math.ceil(ms/1000);
    if(s<60) return `${s}ç§’`;
    const m=Math.ceil(s/60);
    if(m<60) return `${m}åˆ†`;
    const h=Math.floor(m/60), mm=m%60;
    return mm?`${h}æ™‚é–“${mm}åˆ†`:`${h}æ™‚é–“`;
  }
  function startNextTimer(){
    if(nextTimer) clearTimeout(nextTimer);
    const due = toInt(get(K.next),0);
    if(!due) return;
    const wait = due - Date.now();
    if(wait<=0){ push('ai', pick()); del(K.next); updateDoneState(); return; }
    nextTimer = setTimeout(()=>{ del(K.next); updateDoneState(); push('ai', pick()); }, wait);
  }
  function startLabelTimer(){
    if(labelTimer) clearInterval(labelTimer);
    labelTimer = setInterval(()=>{
      updateDoneState();
      const due = toInt(get(K.next),0);
      if(!due || due<=Date.now()){ clearInterval(labelTimer); labelTimer=null; }
    }, 30000);
  }

  // ãƒ¡ã‚¤ãƒ³é–‹å§‹
  function startMain(newSession){
    character = character || get(K.char);
    if(!character){ return showTitle(); }
    const charPath=`public/char/${character}/calm.png`;
    charIcon.src = charPath;
    charIcon.onerror = ()=>{ charIcon.src='public/char/green/calm.png'; };
    heartCountEl.textContent = hearts;
    sessionInfo.textContent = newSession ? 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³' : 'ã¤ã¥ãã‹ã‚‰';

    chat.innerHTML='';
    if(newSession || log.length===0){
      log = [];
      push('ai', firstRequest(character));
      saveAll();
    }else{
      log.forEach(m=>append(m.sender,m.text));
      chat.scrollTop = chat.scrollHeight;
    }
    show('main');
    setTimeout(()=> input?.focus(), 10);
    updateDoneState();
    startNextTimer();
    startLabelTimer();
  }

  // ç”»é¢è¡¨ç¤º
  function showTitle(){
    const has = !!get(K.char);
    if(saveState){
      saveState.textContent = has ? 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã€Œã¤ã¥ãã‹ã‚‰ã€ã§å†é–‹ã§ãã¾ã™ã€‚' : 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
    }
    if(btnCont) btnCont.disabled = !has;
    show('title');
  }

  // é€ä¿¡
  function send(){
    const t=input.value.trim();
    if(!t) return;
    push('user',t);
    input.value='';
    push('ai','ã†ã‚“ã€ãªã‚‹ã»ã©ã­ã€‚');
    saveAll();
  }

  // ====== ãƒã‚¤ãƒ³ãƒ‰ï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¤ãï¼‰ ======
  on(btnCoverStart,'click',()=>{
    try{
      if(get(K.char)){
        startMain(false);
      }else{
        show('choose');
      }
    }catch(e){ console.error(e); show('title'); }
  });

  on(btnStart,'click', ()=> show('choose'));
  on(btnCont,'click', ()=>{
    if(!get(K.char)){ alert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
    startMain(false);
  });
  on(btnAbout,'click', ()=> alert('ã“ã®è©¦ä½œã¯AIãŒç›£è¦–ã™ã‚‹ã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå·±ç”³å‘Šï¼ˆã€Œã‚„ã£ãŸã‚ˆã€ï¼‰ã§è¨˜éŒ²ã™ã‚‹ã ã‘ã®è¨­è¨ˆã§ã™ã€‚'));

  // ã‚­ãƒ£ãƒ©é¸æŠã¯ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§ç¢ºå®Ÿã«æ‹¾ã†
  on($('#choose'),'click',(e)=>{
    const el = e.target.closest('.char');
    if(!el) return;
    character = el.dataset.char;
    set(K.char, character);
    hearts = toInt(get(K.hearts),0);
    log = toArray(get(K.log),[]);
    startMain(true);
  });

  on(btnBackTitle,'click', showTitle);
  on(btnToTitle,'click', showTitle);

  on(btnSend,'click', send);
  on(input,'keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

  let guard=false;
  on(btnDone,'click', ()=>{
    if(guard) return;
    guard=true; setTimeout(()=>guard=false, 500);

    if(!canDoneNow()){
      const due=toInt(get(K.next),0);
      const rest=Math.max(0,due-Date.now());
      alert(`ã‚‚ã†å°‘ã—ä¼‘æ†©â€¦ æ¬¡ã¯ ${countdown(rest)} å¾Œã«ã€Œã‚„ã£ãŸã‚ˆã€ã§ãã¾ã™ã€‚`);
      return;
    }
    btnDone.disabled=true; updateDoneState();
    const t='ã‚„ã£ãŸã‚ˆ';
    push('user',t);
    hearts++; heartCountEl.textContent=hearts;
    push('ai','ã™ã°ã‚‰ã—ã„ï¼ãƒãƒ¼ãƒˆãŒå¢—ãˆãŸã‚ˆğŸ’–');
    saveAll();
    const h = Math.round((1 + Math.random()*2)*10)/10; // 1.0ã€œ3.0h
    push('ai', `ã¾ãŸå¾Œã§ã­ã€‚ç´„${h}æ™‚é–“å¾Œã«æ¬¡ã®ææ¡ˆã‚’é€ã‚‹ã­ã€‚`);
    setNextAfterHours(h);
  });

  on(btnShowLog,'click', ()=>{
    const text=(log||[]).map(l=>`${new Date(l.ts).toLocaleString()} [${l.sender}] ${l.text}`).join('\n')||'ï¼ˆãƒ­ã‚°ãªã—ï¼‰';
    alert(text);
  });

  on(btnReset,'click', ()=>{
    if(!confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚­ãƒ£ãƒ©ãƒ»ãƒãƒ¼ãƒˆãƒ»ãƒ­ã‚°ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    [K.char,K.hearts,K.log,K.next].forEach(del);
    character=null; hearts=0; log=[];
    if(nextTimer) clearTimeout(nextTimer);
    if(labelTimer) clearInterval(labelTimer);
    show('cover');
  });

  // ===== åˆæœŸè¡¨ç¤ºï¼ˆå®‰å…¨é †åºï¼‰ =====
  try{
    // ã“ã“ã§ã¯ã‚¿ã‚¤ãƒãƒ¼èµ·å‹•ã¯ã—ãªã„ï¼ˆç”»é¢å…¥ã£ã¦ã‹ã‚‰ã«ã™ã‚‹ï¼‰
    if(get(K.char)){
      // æ—¢ã«éŠã‚“ã ã“ã¨ãŒã‚ã‚‹ â†’ è¡¨ç´™â†’ã‚¹ã‚¿ãƒ¼ãƒˆâ†’ãƒ¡ã‚¤ãƒ³ç›´è¡Œã§ã‚‚ã€ã¾ãšã¯è¡¨ç´™ã‚’è¦‹ã›ã‚‹
      show('cover');
    }else{
      show('cover');
    }
  }catch(e){
    console.error(e);
    show('title');
  }
})();
</script>
</body>
</html>
