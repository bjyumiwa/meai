<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI – 愛着成長ミニ版（3提案/日）</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --fg:#fff; --bg:#000;
    --glass: rgba(255,255,255,.07);
    --glass-border: rgba(255,255,255,.16);
  }
  html, body { height:100%; }
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
    color:var(--fg);
  }
  .wrap{ max-width:960px; margin:0 auto; padding:24px; }
  .grid{ display:grid; grid-template-columns: 280px 1fr; gap:20px; }
  .glass{ background:var(--glass); border:1px solid var(--glass-border); border-radius:16px; backdrop-filter:blur(8px); }
  .pad{ padding:16px; }
  h1{ font-size:22px; margin:0 0 10px; }
  h3{ margin:0 0 10px; font-size:18px; }
  small{ opacity:.9 }
  #charWrap{ text-align:center; }
  #charWrap img{ width:240px; height:auto; image-rendering:auto; }
  #status > div{ margin:6px 0; }
  #tasks{ list-style:none; padding:0; margin:0; display:grid; gap:10px; }
  .task{ padding:12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .btn{ border:none; border-radius:999px; padding:8px 14px; cursor:pointer; color:#fff; background:rgba(255,255,255,.18); }
  .btn:hover{ background:rgba(255,255,255,.26); }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .field{ display:flex; gap:8px; align-items:center; }
  input[type="text"], select{
    background:rgba(255,255,255,.08); color:#fff; border:1px solid var(--glass-border);
    padding:8px 10px; border-radius:10px; outline:none; min-width:0;
  }
  .note{ opacity:.9; font-size:13px; }
  @media (max-width:820px){
    .grid{ grid-template-columns: 1fr; }
    #charWrap img{ width:200px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; margin-bottom:12px;">
      <h1>MeAI – 今日は何を提案してくれる？</h1>
      <button id="exportCsv" class="btn">CSVを書き出す</button>
    </div>

    <!-- 設定（名前・色） -->
    <div class="glass pad" style="margin-bottom:16px;">
      <div class="row">
        <div class="field">
          <label for="userName">あなたの名前</label>
          <input id="userName" type="text" placeholder="例）みわ" style="width:160px;">
        </div>
        <div class="field">
          <label for="charColor">キャラ色</label>
          <select id="charColor">
            <option value="blue">blue</option>
            <option value="pink">pink</option>
            <option value="green">green</option>
            <option value="purple">purple</option>
          </select>
        </div>
        <button id="saveProfile" class="btn">保存</button>
        <button id="resetAll" class="btn">初期化</button>
      </div>
      <div class="note" style="margin-top:6px;">※画像は <code>public/char/{color}/{emotion}.png</code> を参照（emotion: calm / joy / sad / sleep）。</div>
    </div>

    <div class="grid">
      <!-- 左：キャラとステータス -->
      <div class="glass pad">
        <div id="charWrap">
          <img id="charImg" alt="char" src="public/char/blue/calm.png" onerror="this.src=''; this.alt='画像が見つかりません（public/char/... を確認）'">
          <div id="hello" style="margin-top:8px; opacity:.95;"></div>
        </div>
        <hr style="border:none;border-top:1px solid var(--glass-border); margin:14px 0;">
        <div id="status">
          <div>❤️ <span id="hearts">0</span>　／　ステージ: <span id="stage">S0</span>　／　連続: <span id="streak">0</span>日</div>
          <div>🎖️ スタンプ: <span id="stamps">0</span></div>
          <div id="stampsRow" class="row" style="margin-top:6px;"></div>
        </div>
      </div>

      <!-- 右：今日の提案 -->
      <div class="glass pad">
        <h3>📬 今日の提案（3つ）</h3>
        <ul id="tasks"></ul>
        <div class="note" style="margin-top:10px;">
          同じ日は同じ3件が表示されます（安定性のため）。完了するとハートが貯まり、表情が一瞬「joy」に変わります。
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* ================== ストレージキー ================== */
const LS_STATE = 'MEAI_STATE_V2';
const LS_LOG   = 'MEAI_LOG_V2';
const LS_DAY_PREFIX = 'MEAI_DAILY_V2:'; // 例: MEAI_DAILY_V2:2025-10-25
const LS_USER  = 'MEAI_USER_NAME';
const LS_COLOR = 'MEAI_CHAR_COLOR';

/* ================== マスタ ================== */
const COLORS = ['blue','pink','green','purple'];
const EMOTIONS = ['calm','joy','sad','sleep'];

const TASK_POOL = [
  {id:'H1', cat:'health',  text:'お水をコップ1杯のもう', heart:1},
  {id:'H2', cat:'health',  text:'3分だけ深呼吸してみよう', heart:2},
  {id:'L1', cat:'life',    text:'机の上を1分だけ片付ける', heart:1},
  {id:'L2', cat:'life',    text:'窓を開けて外の空気を吸う', heart:1},
  {id:'S1', cat:'social',  text:'誰かに「ありがとう」を1回伝える', heart:2},
  {id:'A1', cat:'art',     text:'写真を1枚とってお気に入りに追加', heart:2},
  {id:'A2', cat:'art',     text:'1分落書きしてみよう', heart:2},
  {id:'E1', cat:'learn',   text:'気になる言葉を1つ調べる', heart:2},
  {id:'E2', cat:'learn',   text:'今日あった発見を1行メモ', heart:2},
];
const CAT_WEIGHT = { health:3, life:3, social:2, art:2, learn:2 };

/* ================== ユーティリティ ================== */
const $ = sel => document.querySelector(sel);
const todayStr = () => new Date().toISOString().slice(0,10);
const ymd = (d)=> d.toISOString().slice(0,10);

/* ================== ステートIO ================== */
function loadState(){
  const s = localStorage.getItem(LS_STATE);
  if (s) return JSON.parse(s);
  const init = {
    userName: localStorage.getItem(LS_USER) || '',
    charColor: localStorage.getItem(LS_COLOR) || 'blue',
    hearts: 0, streakDays: 0, stamps: 0,
    lastActionDate: null,
    stage: 'S0',
    unlocked: {skins:[], bg:[], lines:[]}
  };
  localStorage.setItem(LS_STATE, JSON.stringify(init));
  if (!localStorage.getItem(LS_LOG)) localStorage.setItem(LS_LOG, JSON.stringify([]));
  return init;
}
function saveState(st){ localStorage.setItem(LS_STATE, JSON.stringify(st)); }
function loadLog(){ return JSON.parse(localStorage.getItem(LS_LOG) || '[]'); }
function saveLog(log){ localStorage.setItem(LS_LOG, JSON.stringify(log)); }

/* ================== ステージ判定 ================== */
function evalStage(st){
  const h = st.hearts, streak = st.streakDays, stamps = st.stamps;
  if (h>=40 && stamps>=10) return 'S4';
  if (h>=24 && streak>=7)  return 'S3';
  if (h>=12 && stamps>=5)  return 'S2';
  if (h>=5  && streak>=2)  return 'S1';
  return 'S0';
}

/* ================== 画像・挨拶 ================== */
function setEmotion(st, emotion='calm'){
  const color = COLORS.includes(st.charColor) ? st.charColor : 'blue';
  const img = $('#charImg');
  img.src = `public/char/${color}/${EMOTIONS.includes(emotion)?emotion:'calm'}.png`;
}

function helloLine(st){
  const name = st.userName || 'あなた';
  const t = todayStr();
  if (!st.lastActionDate) return `はじめまして、${name}さん。今日からよろしくね。`;
  if (st.lastActionDate === t) return `また会えたね、${name}さん。`;
  // 経過日で一言
  const last = new Date(st.lastActionDate+'T00:00:00');
  const now  = new Date(t+'T00:00:00');
  const diff = Math.round((now - last)/(1000*60*60*24));
  if (diff===1) return `おかえり、${name}さん。昨日の続き、いい感じ！`;
  if (diff<=3)  return `おかえり、${name}さん。${diff}日ぶりだね。`;
  return `会えてうれしいよ、${name}さん。`;
}

/* ================== デイリー提案 ================== */
function seededRandom(seedStr){
  let h=0; for (let i=0;i<seedStr.length;i++){ h = (h*31 + seedStr.charCodeAt(i))>>>0; }
  return ()=>{ h^=h<<13; h^=h>>>17; h^=h<<5; return (h>>>0)/0xFFFFFFFF; };
}
function weightedPick(arr, weights, n, excludeIds=new Set()){
  const out = [];
  const pool = arr.filter(x=>!excludeIds.has(x.id));
  while(out.length<n && pool.length){
    const total = Object.values(weights).reduce((a,b)=>a+b,0);
    const r = Math.random()*total;
    let acc=0, pickCat=null;
    for (const [k,w] of Object.entries(weights)){ acc+=w; if (r<=acc){ pickCat=k; break; } }
    const cand = pool.filter(x=>x.cat===pickCat);
    if (cand.length){
      const item = cand[Math.floor(Math.random()*cand.length)];
      if (!out.find(o=>o.id===item.id)) out.push(item);
    }else{
      const item = pool[Math.floor(Math.random()*pool.length)];
      if (!out.find(o=>o.id===item.id)) out.push(item);
    }
  }
  while(out.length<n && pool.length){
    const item = pool.splice(Math.floor(Math.random()*pool.length),1)[0];
    if (!out.find(o=>o.id===item.id)) out.push(item);
  }
  return out;
}
function getTodayTasks(st){
  const key = LS_DAY_PREFIX + todayStr();
  const cached = localStorage.getItem(key);
  if (cached) return JSON.parse(cached);

  const log = loadLog().slice(-50);
  const recentDone = new Set(log.filter(x=>x.done).slice(-9).map(x=>x.taskId));

  const seed = seededRandom(todayStr() + (st.userName||'') + st.charColor);
  const bak = Math.random;
  Math.random = seed;
  const tasks = weightedPick(TASK_POOL, CAT_WEIGHT, 3, recentDone);
  Math.random = bak;

  localStorage.setItem(key, JSON.stringify(tasks));
  return tasks;
}

/* ================== 完了処理 ================== */
function completeTask(task){
  const st = loadState();
  const today = todayStr();

  if (st.lastActionDate === today) {
    // 同日2回目以降はstreak加算せず
  } else {
    const yest = new Date(); yest.setDate(yest.getDate()-1);
    if (st.lastActionDate === ymd(yest)) st.streakDays += 1;
    else st.streakDays = 1;
    st.stamps += 1; // その日1回以上の実行で付与
  }

  st.hearts += task.heart;
  st.lastActionDate = today;

  const prevStage = st.stage;
  st.stage = evalStage(st);

  // ご褒美サンプル
  if (prevStage !== st.stage){
    if (st.stage==='S1') st.unlocked.lines.push('再会:短い挨拶');
    if (st.stage==='S2') st.unlocked.skins.push('scarf');
    if (st.stage==='S3') st.unlocked.bg.push('space_milky');
    if (st.stage==='S4') st.unlocked.skins.push('festival');
  }

  saveState(st);
  const log = loadLog();
  log.push({date: today, taskId: task.id, category: task.cat, done:true, deltaHeart: task.heart});
  saveLog(log);

  // 表情演出
  setEmotion(st, 'joy');
  setTimeout(()=>setEmotion(st, 'calm'), 1600);

  renderAll();
}

/* ================== UI描画 ================== */
function renderStatus(st){
  $('#hearts').textContent = st.hearts;
  $('#stage').textContent  = st.stage;
  $('#streak').textContent = st.streakDays;
  $('#stamps').textContent = st.stamps;

  const row = $('#stampsRow'); row.innerHTML='';
  const n = Math.min(st.stamps, 12);
  for (let i=0;i<n;i++){
    const b = document.createElement('span');
    b.textContent = '🌟';
    b.style.fontSize = '20px';
    row.appendChild(b);
  }
}

function renderTasks(tasks){
  const ul = $('#tasks'); ul.innerHTML='';
  tasks.forEach(t=>{
    const li = document.createElement('li');
    li.className='task glass';
    li.innerHTML = `
      <div>
        <div style="font-weight:700;">${t.text}</div>
        <small>カテゴリ: ${t.cat} ／ ❤️ +${t.heart}</small>
      </div>
      <button class="btn doBtn" data-id="${t.id}">やったよ</button>
    `;
    ul.appendChild(li);
  });
  ul.querySelectorAll('.doBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      const task = TASK_POOL.find(x=>x.id===id);
      if (task) completeTask(task);
    });
  });
}

function renderChar(st){
  setEmotion(st, 'calm');
  $('#hello').textContent = helloLine(st);
}

function renderAll(){
  const st = loadState();
  renderStatus(st);
  renderTasks( getTodayTasks(st) );
  renderChar(st);
}

/* ================== CSV出力 ================== */
function exportCSV(){
  const log = loadLog();
  if (!log.length){ alert('ログがありません'); return; }
  const header = ['date','taskId','category','done','deltaHeart'];
  const rows = [header.join(',')].concat(
    log.map(r=>[r.date,r.taskId,r.category,r.done,r.deltaHeart].join(','))
  );
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `meai_log_${todayStr()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ================== 設定UI ================== */
function applyProfileFields(){
  const st = loadState();
  $('#userName').value = st.userName || '';
  $('#charColor').value = COLORS.includes(st.charColor)? st.charColor : 'blue';
}
function saveProfile(){
  const st = loadState();
  st.userName = $('#userName').value.trim();
  st.charColor = $('#charColor').value;
  localStorage.setItem(LS_USER, st.userName);
  localStorage.setItem(LS_COLOR, st.charColor);
  saveState(st);
  // 今日の提案は固定のまま。色だけ反映
  renderAll();
}
function resetAll(){
  if (!confirm('すべての記録（ハート/スタンプ/ログ）を初期化します。よろしいですか？')) return;
  localStorage.removeItem(LS_STATE);
  localStorage.removeItem(LS_LOG);
  // 日替わりキャッシュもクリア
  Object.keys(localStorage).forEach(k=>{ if (k.startsWith(LS_DAY_PREFIX)) localStorage.removeItem(k); });
  renderAll();
}

/* ================== 起動 ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  applyProfileFields();
  renderAll();

  $('#saveProfile').addEventListener('click', saveProfile);
  $('#resetAll').addEventListener('click', resetAll);
  $('#exportCsv').addEventListener('click', exportCSV);
});
</script>
</body>
</html>
