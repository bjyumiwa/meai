<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --fg:#fff; --dim:#cfd8dc; --accent:#8e7cff; --accent2:#4db6ff;
    --glass:rgba(255,255,255,.08); --bd:rgba(255,255,255,.18);
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
  }
  .hidden{display:none!important;}
  .center{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; padding:20px; text-align:center;}
  .row{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;}
  .panel{ background:var(--glass); border:1px solid var(--bd); border-radius:18px; padding:16px 18px; max-width:980px; width:min(94vw,980px); }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5em; border:none; border-radius:999px; padding:12px 22px; cursor:pointer; color:#fff; font-weight:700; background:linear-gradient(135deg,var(--accent2),var(--accent)); }
  .btn.secondary{ background:linear-gradient(135deg,#607d8b,#90a4ae);}
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,.4);}
  .btn:disabled{ opacity:.5; cursor:not-allowed; }
  img.char{ width:min(34vw,220px); height:auto; border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,.35); background:rgba(255,255,255,.06); }
  .spacer{height:10px;}

  /* COVER */
  #cover h1{font-size:40px; margin:0;}  #cover p{color:var(--dim); margin:.2em 0 0 0;}

  /* GAME */
  #game{ display:none; text-align:left; }
  #layout{ display:grid; gap:16px; grid-template-columns:260px 1fr; }
  #charBox{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  #stats{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  .chip{ font-weight:700; padding:.35em .8em; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid var(--bd); }
  #greet{ font-size:18px; }
  #suggest{ font-size:18px; line-height:1.6; }
  #log{max-height:220px; overflow:auto; font-size:13px; opacity:.95; }
  #log li{margin:.2em 0;}
  .title{font-weight:700; opacity:.9; margin-bottom:6px;}

  /* Modal */
  .modalWrap{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:20px; background:rgba(0,0,0,.5); }
  .modal{ background:rgba(22,22,33,.9); border:1px solid var(--bd); border-radius:14px; padding:18px; width:min(92vw,520px); }
  .gridChars{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; }
  .stamp{ display:inline-block; padding:6px 10px; border:1px dashed rgba(255,255,255,.35); border-radius:10px; margin:4px; }
  input[type="text"]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #777; background:#111; color:#fff; }
  small{color:#cfd8dc}
</style>
</head>
<body>

<!-- ===== COVER ===== -->
<section id="cover" class="center" aria-label="cover">
  <div class="panel">
    <h1>MeAI</h1>
    <p>å°ã•ãªâ€œã‚„ã£ã¦ã¿ã‚‹â€ã‚’ã‚„ã•ã—ãææ¡ˆã—ã¦ãã‚Œã‚‹ç›¸æ£’ã€‚</p>
    <div class="spacer"></div>

    <!-- åå‰å…¥åŠ› -->
    <div class="panel" style="background:rgba(255,255,255,.05);">
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
        <input id="userNameInput" type="text" placeholder="ã‚ãªãŸã®åå‰" aria-label="ã‚ãªãŸã®åå‰">
        <button class="btn" id="saveNameBtn" type="button">åå‰ã‚’ä¿å­˜</button>
      </div>
      <small id="nameHint">â€»ã‚ã¨ã§å¤‰æ›´ã§ãã¾ã™</small>
    </div>

    <div class="spacer"></div>
    <img id="coverChar" class="char" src="public/char/ako2.png" alt="ã‚­ãƒ£ãƒ©">
    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="startBtn" type="button">ã¯ã˜ã‚ã‚‹</button>
    </div>
  </div>
</section>

<!-- ===== GAME ===== -->
<section id="game" class="center" aria-label="game">
  <div class="panel">
    <div id="greet">ã“ã‚“ã«ã¡ã¯ï¼</div>
    <div class="spacer"></div>

    <div id="layout">
      <!-- å·¦ï¼šã‚­ãƒ£ãƒ©ï¼†ãŠä¸–è©± -->
      <div id="charBox">
        <img id="gameChar" class="char" src="public/char/ako2.png" alt="ã‚­ãƒ£ãƒ©">
        <div id="charNameView" class="chip">ã‚­ãƒ£ãƒ©åï¼š<span id="charNick">ï¼ˆæœªè¨­å®šï¼‰</span></div>

        <div id="stats">
          <div class="chip">â™¡ ãƒãƒ¼ãƒˆ <span id="heartNum">0</span></div>
          <div class="chip">ğŸ¯ ä»Šæ—¥ã®ææ¡ˆ <span id="todayCount">0</span>/3</div>
          <div class="chip">ğŸ… ã‚¹ã‚¿ãƒ³ãƒ— <span id="stampNum">0</span></div>
        </div>

        <div class="row">
          <button class="btn" id="doneBtn" type="button">ã‚„ã£ãŸã‚ˆâ™¡</button>
          <button class="btn ghost" id="backBtn" type="button">ã‚«ãƒãƒ¼ã¸</button>
        </div>

        <div class="spacer"></div>

        <div class="panel" style="background:rgba(255,255,255,.05);">
          <div class="title">ãŠä¸–è©±ï¼ˆã„ã¤ã§ã‚‚OKï¼‰</div>
          <div class="row">
            <button class="btn secondary" id="careMeal">ã”ã¯ã‚“</button>
            <button class="btn secondary" id="careToilet">ãƒˆã‚¤ãƒ¬</button>
            <button class="btn secondary" id="carePet">ãªã§ã‚‹</button>
          </div>
        </div>
      </div>

      <!-- å³ï¼šææ¡ˆï¼†ãƒ­ã‚° -->
      <div id="rightCol">
        <div id="suggestBox" class="panel" style="background:rgba(255,255,255,.05);">
          <div class="title">ä»Šæ—¥ã®ææ¡ˆ</div>
          <div id="suggest">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã„ã¾ã®ã‚ãªãŸã«åˆã„ãã†ãªå°ã•ãªè¡Œå‹•ã‚’å‡ºã—ã¾ã™ã€‚</div>
          <div class="spacer"></div>
          <div class="row">
            <button class="btn" id="nextSuggestBtn" type="button">ææ¡ˆã‚’å‡ºã™</button>
            <button class="btn secondary" id="anotherBtn" type="button">åˆ¥ã®æ¡ˆ</button>
            <button class="btn" id="clearSuggestBtn" type="button" disabled>ã‚¯ãƒªã‚¢ï¼</button>
          </div>
          <small>â€»ææ¡ˆã¯1æ—¥ã«æœ€å¤§3å›ã¾ã§ã‚¯ãƒªã‚¢ã§ãã¾ã™</small>
        </div>

        <div class="spacer"></div>

        <div class="panel" style="background:rgba(255,255,255,.05);">
          <div class="title">ãã‚ã</div>
          <ul id="log"></ul>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚­ãƒ£ãƒ©é¸æŠ ===== -->
<div id="modalSelect" class="modalWrap" role="dialog" aria-modal="true">
  <div class="modal">
    <h3 style="margin:0 0 8px">ã‚­ãƒ£ãƒ©ã‚’ãˆã‚‰ã¼ã†ï¼</h3>
    <small>â€»åˆè¨ˆ3å›ã‚¯ãƒªã‚¢ã§è§£æ”¾</small>
    <div class="spacer"></div>
    <div id="charOptions" class="gridChars"></div>
    <div class="spacer"></div>
    <div class="row"><button class="btn ghost" id="closeSelect">ã¨ã˜ã‚‹</button></div>
  </div>
</div>

<!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚­ãƒ£ãƒ©å‘½å ===== -->
<div id="modalName" class="modalWrap" role="dialog" aria-modal="true">
  <div class="modal">
    <h3 style="margin:0 0 8px">ã‚­ãƒ£ãƒ©ã«åå‰ã‚’ã¤ã‘ã‚ˆã†ï¼</h3>
    <small>â€»åˆè¨ˆ5å›ã‚¯ãƒªã‚¢ã§è§£æ”¾</small>
    <div class="spacer"></div>
    <input id="charNameInput" type="text" placeholder="ã‚­ãƒ£ãƒ©ã®åå‰">
    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="saveCharName">ä¿å­˜</button>
      <button class="btn ghost" id="closeName">ã¨ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
/* ================== å®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ================== */
const LS = {
  NAME:'MEAI_USER_NAME',
  HEART:'MEAI_HEART',
  STAMP:'MEAI_STAMP',
  CLEAR_TOTAL:'MEAI_CLEAR_TOTAL',
  TODAY_DATE:'MEAI_TODAY_DATE',
  TODAY_COUNT:'MEAI_TODAY_COUNT',
  CHAR_SRC:'MEAI_CHAR_SRC',
  CHAR_NAME:'MEAI_CHAR_NAME'
};
const $ = (s)=>document.querySelector(s);
const on = (el,ev,fn)=>el&&el.addEventListener(ev,fn);
const nowDateStr = ()=> new Date().toISOString().slice(0,10); // YYYY-MM-DD

// ç”»åƒå€™è£œï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ã—ã¦å‡ºã™ï¼‰
const CHAR_POOL = [
  "public/char/ako1.png",
  "public/char/ako2.png",
  "public/char/ako3.png"
];

/* ================== çŠ¶æ…‹ ================== */
let hearts = Number(localStorage.getItem(LS.HEART) || 0);
let stamps = Number(localStorage.getItem(LS.STAMP) || 0);
let clearTotal = Number(localStorage.getItem(LS.CLEAR_TOTAL) || 0);
let todayDate = localStorage.getItem(LS.TODAY_DATE) || nowDateStr();
let todayCount = Number(localStorage.getItem(LS.TODAY_COUNT) || 0);
let currentSuggest = null;

// æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰æ—¥æ¬¡å›æ•°ãƒªã‚»ãƒƒãƒˆ
if (todayDate !== nowDateStr()) {
  todayDate = nowDateStr();
  todayCount = 0;
  localStorage.setItem(LS.TODAY_DATE, todayDate);
  localStorage.setItem(LS.TODAY_COUNT, todayCount);
}

/* ================== ææ¡ˆ ================== */
const SUGGESTS = [
  "æ°´ã‚’ä¸€æ¯é£²ã‚€","ç«‹ã¡ä¸ŠãŒã£ã¦30ç§’ã‚¹ãƒˆãƒ¬ãƒƒãƒ","5åˆ†ã ã‘æœºã‚’ç‰‡ã¥ã‘ã‚‹",
  "ä»Šæ—¥ã®è‰¯ã‹ã£ãŸã“ã¨ã‚’1ã¤æ›¸ã","10å›æ·±å‘¼å¸","æ­¯ç£¨ãã®ä»•ä¸Šã’30ç§’",
  "å¤–ã®ç©ºæ°—ã‚’å¸ã†","ã‚¿ã‚¤ãƒãƒ¼3åˆ†ã§é›†ä¸­","äººã«ä¸€è¨€ã‚ã‚ŠãŒã¨ã†ã‚’ä¼ãˆã‚‹",
  "ç›®ã‚’é–‰ã˜ã¦ä¼‘ã‚€30ç§’","ä½¿ã‚ãªã„ã‚¿ãƒ–ã‚’3ã¤é–‰ã˜ã‚‹","èƒŒã™ã˜ã‚’ä¼¸ã°ã™",
  "çŸ­ã„ãƒ¡ãƒ¢ã‚’1è¡Œã ã‘æ›¸ã","æ•£æ­©ã‚’1åˆ†","æ°´ã‚„ã‚Šã‚’ã™ã‚‹","ã‚´ãƒŸã‚’1ã¤æ¨ã¦ã‚‹"
];
function pickSuggest(){
  const i = Math.floor(Math.random()*SUGGESTS.length);
  currentSuggest = SUGGESTS[i];
  $('#suggest').textContent = currentSuggest;
  $('#clearSuggestBtn').disabled = false;
}
function pushLog(msg){
  const li = document.createElement('li');
  li.textContent = `${new Date().toLocaleString()}ï½œ${msg}`;
  $('#log').prepend(li);
}

/* ================== UI åˆæœŸåŒ– ================== */
function renderHUD(){
  $('#heartNum').textContent = String(hearts);
  $('#stampNum').textContent = String(stamps);
  $('#todayCount').textContent = `${todayCount}`;
  const name = localStorage.getItem(LS.NAME) || "";
  const charNick = localStorage.getItem(LS.CHAR_NAME) || "ï¼ˆæœªè¨­å®šï¼‰";
  const charCall = name ? `${name}ã•ã‚“ã€` : "";
  $('#greet').textContent = `${charCall}ã“ã‚“ã«ã¡ã¯ï¼ ä»Šæ—¥ã¯ã‚ã¨ ${Math.max(0,3-todayCount)} å›ã‚¯ãƒªã‚¢ã§ãã¾ã™ã€‚`;
  $('#charNick').textContent = charNick;
  // 3å›/5å›åˆ°é”ã§ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªå‹•æ¡ˆå†…ï¼ˆ1å›ã ã‘ï¼‰
  if (clearTotal === 3) { openSelectModal(); }
  if (clearTotal === 5 && !localStorage.getItem(LS.CHAR_NAME)) { openNameModal(); }
}

// ã‚«ãƒãƒ¼ã®ã€Œã¯ã˜ã‚ã‚‹ã€ã‚’æœ‰åŠ¹åŒ–ï¼ˆåå‰ãŒç©ºã§ã‚‚OKï¼‰
function updateStartEnabled(){
  $('#startBtn').disabled = false;
}

/* ================== ã‚­ãƒ£ãƒ©ç”»åƒãƒ­ãƒ¼ãƒ‰ ================== */
async function buildCharOptions(){
  const wrap = $('#charOptions'); wrap.innerHTML = "";
  const exists = await Promise.all(CHAR_POOL.map(src => imgExists(src)));
  exists.forEach((ok,idx)=>{
    if(!ok) return;
    const src = CHAR_POOL[idx];
    const b = document.createElement('button');
    b.className = 'btn ghost';
    b.style.flexDirection='column';
    b.innerHTML = `<img class="char" src="${src}" alt="char" style="width:140px"><div style="margin-top:6px">${src.split('/').pop()}</div>`;
    b.addEventListener('click', ()=>selectChar(src));
    wrap.appendChild(b);
  });
  if (!wrap.children.length) {
    const p=document.createElement('p');
    p.textContent="åˆ©ç”¨ã§ãã‚‹ã‚­ãƒ£ãƒ©ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚public/char/ ã«ç”»åƒã‚’ç½®ã„ã¦ãã ã•ã„ã€‚";
    wrap.appendChild(p);
  }
}
function selectChar(src){
  localStorage.setItem(LS.CHAR_SRC, src);
  $('#coverChar').src = src;
  $('#gameChar').src = src;
  pushLog(`ã‚­ãƒ£ãƒ©å¤‰æ›´ï¼š${src}`);
  closeSelectModal();
}
function imgExists(src){
  return new Promise(res=>{
    const i=new Image();
    i.onload=()=>res(true);
    i.onerror=()=>res(false);
    i.src=src;
  });
}

/* ================== ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ================== */
function openSelectModal(){ $('#modalSelect').style.display='flex'; buildCharOptions(); }
function closeSelectModal(){ $('#modalSelect').style.display='none'; }
function openNameModal(){ $('#modalName').style.display='flex'; }
function closeNameModal(){ $('#modalName').style.display='none'; }

/* ================== ã‚¤ãƒ™ãƒ³ãƒˆ ================== */
// åå‰ä¿å­˜
on($('#saveNameBtn'),'click', ()=>{
  const v = ($('#userNameInput').value || "").trim();
  localStorage.setItem(LS.NAME, v);
  pushLog(`åå‰ã‚’ä¿å­˜ï¼š${v||"(æœªè¨­å®š)"}`);
  updateStartEnabled();
});

// ã‚¹ã‚¿ãƒ¼ãƒˆ
on($('#startBtn'),'click', ()=>{
  // ç”»åƒåæ˜ 
  const savedSrc = localStorage.getItem(LS.CHAR_SRC);
  if (savedSrc) { $('#coverChar').src = savedSrc; $('#gameChar').src = savedSrc; }
  $('#cover').classList.add('hidden');
  $('#game').style.display='flex';
  renderHUD();
  pushLog("ã‚¹ã‚¿ãƒ¼ãƒˆ");
});

// ã‚«ãƒãƒ¼ã¸æˆ»ã‚‹
on($('#backBtn'),'click', ()=>{
  $('#game').style.display='none';
  $('#cover').classList.remove('hidden');
});

// ãŠä¸–è©±
on($('#careMeal'),'click', ()=>{ hearts++; saveHearts(); pushLog("ã”ã¯ã‚“ï¼šæº€è¶³ãã†ï¼â™¡+1"); renderHUD(); });
on($('#careToilet'),'click', ()=>{ pushLog("ãƒˆã‚¤ãƒ¬ï¼šã‚¹ãƒƒã‚­ãƒªï¼"); });
on($('#carePet'),'click', ()=>{ hearts++; saveHearts(); pushLog("ãªã§ãªã§ï¼šã†ã‚Œã—ã„ï¼â™¡+1"); renderHUD(); });

// ææ¡ˆ
on($('#nextSuggestBtn'),'click', ()=>{ pickSuggest(); pushLog("ææ¡ˆã‚’è¡¨ç¤º"); });
on($('#anotherBtn'),'click', ()=>{ pickSuggest(); });
on($('#clearSuggestBtn'),'click', ()=>{
  if (todayCount >= 3) { $('#clearSuggestBtn').disabled = true; return; }
  todayCount++; localStorage.setItem(LS.TODAY_COUNT, todayCount);
  localStorage.setItem(LS.TODAY_DATE, nowDateStr());
  clearTotal++; localStorage.setItem(LS.CLEAR_TOTAL, clearTotal);
  stamps++; localStorage.setItem(LS.STAMP, stamps);
  pushLog(`ææ¡ˆã‚¯ãƒªã‚¢ï¼ã€Œ${currentSuggest||"ï¼ˆä¸æ˜ï¼‰"}ã€ï½œã‚¹ã‚¿ãƒ³ãƒ—+1`);
  $('#clearSuggestBtn').disabled = true; // åŒã˜ææ¡ˆã®é€£æ‰“é˜²æ­¢
  renderHUD();
});

// ãƒãƒ¼ãƒˆä¿å­˜
function saveHearts(){ localStorage.setItem(LS.HEART, hearts); }

// ãƒ¢ãƒ¼ãƒ€ãƒ«
on($('#closeSelect'),'click', closeSelectModal);
on($('#closeName'),'click', closeNameModal);
on($('#saveCharName'),'click', ()=>{
  const v = ($('#charNameInput').value||"").trim();
  localStorage.setItem(LS.CHAR_NAME, v);
  pushLog(`ã‚­ãƒ£ãƒ©å‘½åï¼šã€Œ${v||"(æœªè¨­å®š)"}ã€`);
  closeNameModal();
  renderHUD();
});

// å³ã‚¯ãƒªãƒƒã‚¯ç­‰ã§ã„ã¤ã§ã‚‚è©¦ã›ã‚‹ã‚ˆã†ã«ï¼ˆä»»æ„ï¼‰
document.addEventListener('keydown', (e)=>{
  if (e.key==='c' && (e.ctrlKey||e.metaKey)) openSelectModal();   // Ctrl/Cmd + Cï¼šã‚­ãƒ£ãƒ©é¸æŠ
  if (e.key==='n' && (e.ctrlKey||e.metaKey)) openNameModal();     // Ctrl/Cmd + Nï¼šå‘½å
});

/* ================== åˆæœŸãƒ­ãƒ¼ãƒ‰ ================== */
(function boot(){
  // æ—¢å­˜ä¿å­˜ã®åæ˜ 
  const savedName = localStorage.getItem(LS.NAME)||"";
  $('#userNameInput').value = savedName;
  const savedSrc = localStorage.getItem(LS.CHAR_SRC) || "public/char/ako2.png";
  $('#coverChar').src = savedSrc; $('#gameChar').src = savedSrc;
  const charNick = localStorage.getItem(LS.CHAR_NAME);
  if (charNick) $('#charNick').textContent = charNick;

  updateStartEnabled();
  renderHUD();

  // ã—ãã„å€¤ã«å¿œã˜ã¦ãƒ’ãƒ³ãƒˆãƒ­ã‚°
  if (clearTotal < 3){
    pushLog("ãƒ’ãƒ³ãƒˆï¼šææ¡ˆã‚’åˆè¨ˆ3å›ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒ©é¸æŠãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚");
  } else if (clearTotal < 5){
    pushLog("ãƒ’ãƒ³ãƒˆï¼šåˆè¨ˆ5å›ã‚¯ãƒªã‚¢ã§ã€ã‚­ãƒ£ãƒ©ã«åå‰ã‚’ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚");
  }
})();
</script>
</body>
</html>
