<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI Minimal Boot (debug)</title>
<style>
  html,body{height:100%}
  body{margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:#000 url("public/space_background.png") center/cover fixed no-repeat;color:#fff}
  .hidden{display:none!important}
  .screen{min-height:100dvh;display:grid;place-items:center;padding:24px}
  .glass{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);border-radius:20px;backdrop-filter:blur(8px)}
  .btn{display:inline-flex;align-items:center;gap:.5em;border:none;border-radius:999px;padding:12px 18px;cursor:pointer;color:#fff;background:rgba(255,255,255,.18)}
  .btn.primary{background:linear-gradient(180deg,#ff8bd2,#ff6db3 60%,#ff55a1);color:#231227}
  #chat{height:min(60vh,460px);overflow:auto;padding:16px;border-radius:16px}
  .bubble{max-width:78%;margin:10px 0;padding:12px 16px;border-radius:16px;line-height:1.7;font-size:18px}
  .ai{background:linear-gradient(145deg, rgba(150,220,255,.28), rgba(150,200,255,.14));border:1px solid rgba(150,220,255,.34);float:left;clear:both}
  .user{background:linear-gradient(145deg, rgba(255,255,255,.26), rgba(255,255,255,.12));border:1px solid rgba(255,255,255,.28);float:right;clear:both}
  #errbox{position:fixed;right:12px;top:12px;z-index:9999;max-width:min(90vw,520px);background:#2b0c10;color:#fff;border:1px solid #ff8ba1;border-radius:10px;padding:10px 12px;display:none;white-space:pre-wrap;font-size:12px}
</style>
</head>
<body>
<div id="errbox" aria-live="polite"></div>

<!-- 表紙 -->
<section id="cover" class="screen">
  <div class="glass" style="padding:28px;text-align:center;border-radius:28px;">
    <img src="public/miwacchi_open.png" alt="" width="160" height="160" onerror="this.src='public/cover.png'"><br>
    <h1 style="margin:.4em 0 .2em">MeAI</h1>
    <p style="opacity:.9;margin:.2em 0 1em">小さな“やってみる”を、やさしく提案してくれる相棒。</p>
    <button id="coverStart" class="btn primary" type="button">▶︎ スタート</button>
  </div>
</section>

<!-- タイトル -->
<section id="title" class="screen hidden">
  <div class="glass" style="padding:20px;width:min(92vw,900px)">
    <h2 style="margin-top:0">メニュー</h2>
    <p id="savestate" style="opacity:.9"></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="start" class="btn" type="button">はじめから</button>
      <button id="cont" class="btn" type="button">つづきから</button>
      <button id="about" class="btn" type="button">このプロトタイプについて</button>
    </div>
  </div>
</section>

<!-- メイン -->
<section id="main" class="screen hidden">
  <div style="width:min(92vw,960px);margin:auto">
    <div class="glass" style="padding:8px 12px;border-radius:999px;margin:0 auto 12px;width:max-content">
      <img id="charIcon" src="" alt="" width="28" height="28" style="vertical-align:middle">　
      ❤️ × <span id="heartCount">0</span>　
      <span id="sessionInfo" style="opacity:.85"></span>
    </div>
    <div id="chat" class="glass" aria-live="polite"></div>
    <div style="display:flex;gap:8px;margin:10px 0">
      <input id="input" class="glass" type="text" placeholder="返答を入力…（Enterで送信）" style="flex:1;padding:12px 14px;border:none;border-radius:12px;color:#fff;background:rgba(255,255,255,.12)">
      <button id="send" class="btn" type="button">送信</button>
      <button id="done" class="btn" type="button">やったよ</button>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
      <button id="toTitle" class="btn" type="button">メニューへ</button>
      <button id="showLog" class="btn" type="button">ログを確認</button>
      <button id="reset" class="btn" type="button">データ初期化</button>
    </div>
  </div>
</section>

<script>
/* ===== 1) エラー捕捉（原因の行/列/スタックを出す） ===== */
(function setupErrorTrap(){
  const box = document.getElementById('errbox');
  const show = (msg)=>{ if(!box) return; box.style.display='block'; box.textContent = msg; };
  window.addEventListener('error', (e)=>{
    const m = [
      '[window.onerror]',
      e.message || 'Unknown error',
      e.filename ? (e.filename + ':' + e.lineno + ':' + e.colno) : '',
      e.error && e.error.stack ? e.error.stack : ''
    ].filter(Boolean).join('\n');
    console.error(m);
    show(m);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const m = '[unhandledrejection]\n' + (e.reason && e.reason.stack ? e.reason.stack : String(e.reason));
    console.error(m);
    show(m);
  });
})();

/* ===== 2) 最小ロジック（確実に遷移する） ===== */
(function(){
  const $=s=>document.querySelector(s);
  const scr={ cover:$('#cover'), title:$('#title'), main:$('#main') };
  function show(id){ Object.values(scr).forEach(el=>el.classList.add('hidden')); scr[id].classList.remove('hidden'); }

  const K = { char:'meai_character', hearts:'meai_heart', log:'meai_log', next:'meai_next_due' };
  const get=k=>{ try{return localStorage.getItem(k)}catch{return null} };
  const set=(k,v)=>{ try{localStorage.setItem(k,v)}catch{} };
  const del=k=>{ try{localStorage.removeItem(k)}catch{} };
  const toInt=(v,d=0)=>{ const n=parseInt(v,10); return Number.isFinite(n)?n:d; };
  const toArr=(raw,f=[])=>{ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return Array.isArray(v)?v:f }catch{ return f } };

  const btnCoverStart=$('#coverStart');
  const btnStart=$('#start'), btnCont=$('#cont'), btnAbout=$('#about');
  const btnToTitle=$('#toTitle'), btnReset=$('#reset'), btnShowLog=$('#showLog');
  const savestate=$('#savestate');
  const chat=$('#chat'), input=$('#input'), btnSend=$('#send'), btnDone=$('#done');
  const heartEl=$('#heartCount'), charIcon=$('#charIcon'), sessionInfo=$('#sessionInfo');

  let character=get(K.char);
  let hearts=toInt(get(K.hearts),0);
  let log=toArr(get(K.log),[]);
  let nextTimer=null, labelTimer=null;

  const REQUESTS=["おはようって言って。","コップ一杯のお水を飲んでみて。","5秒だけ、静かに目を閉じてみよう。","今日の空の色をひとことで教えて。","深呼吸を3回してみよう。"];
  const pick=()=>REQUESTS[Math.floor(Math.random()*REQUESTS.length)];
  const firstReq=(c)=>({green:"（やさしく）",blue:"（ていねいに）",pink:"（わくわく）",purple:"（おちついて）"}[c]||"")+" "+pick();

  function append(sender,text){
    const d=document.createElement('div'); d.className='bubble '+sender; d.textContent=text;
    chat.appendChild(d); chat.scrollTop=chat.scrollHeight;
  }
  function push(sender,text){ const it={sender,text,ts:Date.now()}; log.push(it); append(sender,text); }
  function save(){ set(K.hearts,String(hearts)); set(K.log,JSON.stringify(log)); }

  function canDoneNow(){ const due=toInt(get(K.next),0); return !due || due<=Date.now(); }
  function countdown(ms){ if(ms<=0) return ""; const s=Math.ceil(ms/1000); if(s<60) return s+"秒"; const m=Math.ceil(s/60); if(m<60) return m+"分"; const h=Math.floor(m/60),mm=m%60; return mm?`${h}時間${mm}分`:`${h}時間`; }
  function updDone(){ const due=toInt(get(K.next),0); const dis=due && due>Date.now(); btnDone.disabled=!!dis; btnDone.textContent=dis?("あと"+countdown(due-Date.now())):"やったよ"; }
  function setNext(h){ const due=Date.now()+Math.round(h*3600*1000); set(K.next,String(due)); updDone(); if(nextTimer) clearTimeout(nextTimer); const wait=due-Date.now(); nextTimer=setTimeout(()=>{ del(K.next); updDone(); push('ai',pick()); }, Math.max(wait,0)); if(labelTimer) clearInterval(labelTimer); labelTimer=setInterval(()=>{ updDone(); const d=toInt(get(K.next),0); if(!d || d<=Date.now()){ clearInterval(labelTimer); labelTimer=null; } },30000); }

  function startMain(newSession){
    character = character || get(K.char) || 'green';
    set(K.char, character);
    const icon=`public/char/${character}/calm.png`;
    charIcon.src=icon; charIcon.onerror=()=>{charIcon.src='public/char/green/calm.png'};
    heartEl.textContent=hearts; sessionInfo.textContent=newSession?'新しいセッション':'つづきから';
    chat.innerHTML='';
    if(newSession || log.length===0){ log=[]; push('ai', firstReq(character)); save(); } else { log.forEach(m=>append(m.sender,m.text)); chat.scrollTop=chat.scrollHeight; }
    show('main'); setTimeout(()=>input?.focus(),10); updDone();
  }

  // ボタン
  btnCoverStart?.addEventListener('click', ()=>{
    try{
      if(get(K.char)){ startMain(false); }
      else { show('title'); const has=!!get(K.char); savestate.textContent = has?'セーブデータがあります。「つづきから」で再開できます。':'セーブデータがありません。'; btnCont.disabled=!has; }
      console.log('start clicked');
    }catch(e){ console.error(e); }
  });
  btnStart?.addEventListener('click', ()=>{ character=null; set(K.char,'green'); startMain(true); });
  btnCont?.addEventListener('click', ()=>{ if(!get(K.char)) return alert('セーブデータがありません。'); startMain(false); });
  btnAbout?.addEventListener('click', ()=> alert('監視はしません。自己申告の「やったよ」で記録するだけの試作です。'));
  btnToTitle?.addEventListener('click', ()=> show('title'));
  btnShowLog?.addEventListener('click', ()=>{ const t=(log||[]).map(l=>`${new Date(l.ts).toLocaleString()} [${l.sender}] ${l.text}`).join('\n')||'（ログなし）'; alert(t); });
  btnReset?.addEventListener('click', ()=>{ if(!confirm('セーブデータを削除します。')) return; [K.char,K.hearts,K.log,K.next].forEach(del); character=null; hearts=0; log=[]; show('cover'); });

  // 入力
  function send(){ const t=input.value.trim(); if(!t) return; push('user',t); input.value=''; push('ai','うん、なるほどね。'); save(); }
  input?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
  btnSend?.addEventListener('click', send);

  let guard=false;
  btnDone?.addEventListener('click', ()=>{
    if(guard) return; guard=true; setTimeout(()=>guard=false,450);
    if(!canDoneNow()){ const due=toInt(get(K.next),0); const rest=Math.max(0, due-Date.now()); return alert('あと '+countdown(rest)+' 後に「やったよ」できます'); }
    btnDone.disabled=true; updDone();
    push('user','やったよ'); hearts++; heartEl.textContent=hearts; push('ai','すばらしい！ハートが増えたよ💖'); save();
    const h=Math.round((1+Math.random()*2)*10)/10; // 1.0〜3.0h
    push('ai',`また後でね。約${h}時間後に次の提案を送るね。`);
    setNext(h);
  });

  // 初期表示：まずは表紙
  console.log('BOOT OK');
  show('cover');
})();
</script>
</body>
</html>
