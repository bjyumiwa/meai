<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeAI Prototype</title>
  <style>
    /* ===== èƒŒæ™¯ï¼ˆå®‡å®™ï¼‰ ===== */
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: url("public/bg/space.jpg") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      overflow: hidden;
    }

    /* å…¨ç”»é¢ãƒ¬ã‚¤ãƒ¤ */
    .screen {
      position: absolute; inset: 0;
      display: none;
      justify-content: center; align-items: center; flex-direction: column;
      padding: 24px;
    }
    .show { display: flex; }

    /* ä¸­å¤®ãƒ‘ãƒãƒ« */
    .panel {
      width: min(92vw, 520px);
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      backdrop-filter: blur(6px);
      padding: 28px 24px;
      text-align: center;
    }
    h1 { margin: 0 0 6px; font-size: 38px; letter-spacing: .02em; }
    p.lead { margin: 0 0 20px; opacity:.95; }

    /* ãƒœã‚¿ãƒ³ */
    .btn {
      display:block; width:100%;
      margin:10px 0; padding:12px 16px;
      border:none; border-radius:12px;
      background: rgba(255,255,255,0.18);
      color:#fff; font-size:16px; cursor:pointer;
      transition:.2s;
    }
    .btn:hover { background: rgba(255,255,255,0.28); }
    .btn:disabled { opacity:.45; cursor:not-allowed; }

    /* ã‚­ãƒ£ãƒ©é¸æŠ */
    .char-grid { display:flex; justify-content:center; gap:14px; flex-wrap:wrap; margin-top:10px; }
    .char {
      width:86px; height:86px; border-radius:50%;
      background: rgba(255,255,255,0.12);
      display:grid; place-items:center; cursor:pointer; transition:.2s; border:1px solid rgba(255,255,255,0.18);
    }
    .char img { width:68px; height:68px; object-fit:contain; }
    .char:hover { transform: scale(1.06); box-shadow: 0 0 0 3px rgba(255,255,255,0.18) inset; }

    /* ãƒ¡ã‚¤ãƒ³ */
    #headerBar {
      position:absolute; top:14px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.2);
      border-radius:999px; padding:8px 14px; display:flex; gap:14px; align-items:center;
    }
    #headerBar img { width:32px; height:32px; }
    #heart { font-size:18px; }
    #chat {
      width:min(92vw, 700px); height:min(60vh, 420px);
      overflow-y:auto; padding:18px; margin:90px auto 10px;
      background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.2); border-radius:16px;
    }
    .bubble{max-width:78%; margin:10px 0; padding:10px 14px; border-radius:14px; display:inline-block; line-height:1.5}
    .ai{ background:rgba(120,200,255,0.25); border:1px solid rgba(120,200,255,0.35); }
    .user{ background:rgba(255,255,255,0.25); border:1px solid rgba(255,255,255,0.35); float:right; clear:both;}
    .ai{ float:left; clear:both;}

    #composer{ width:min(92vw, 700px); margin:6px auto 0; display:flex; gap:8px; }
    #input{
      flex:1; padding:12px 14px; border:none; border-radius:12px;
      background:rgba(255,255,255,0.15); color:#fff; font-size:16px;
      outline:none;
    }
    #send{ padding:12px 16px; }

    /* ç”»é¢é·ç§»ã‚¢ãƒ‹ãƒ¡å¼±ã‚ */
    .fade { animation: fade .25s ease; }
    @keyframes fade { from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none} }

    /* ãƒ¢ãƒã‚¤ãƒ«ä½™ç™½ */
    @media (max-width:480px){
      h1{font-size:30px}
      .char{width:78px;height:78px}
      .char img{width:60px;height:60px}
    }
  </style>
</head>
<body>
  <!-- ===== ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ ===== -->
  <section id="titleScreen" class="screen show">
    <div class="panel fade">
      <h1>MeAI</h1>
      <p class="lead">â€œç”Ÿæ´»ã«å¯„ã‚Šæ·»ã†ãŠé¡˜ã„â€ã‚’å—ã‘å–ã‚Šã€<br>ã€Œã¯ã„ã€ã‚„ã£ãŸã‚ˆã€ã§è¨˜éŒ²ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã€‚</p>
      <button id="btnStart" class="btn">ã¯ã˜ã‚ã‹ã‚‰</button>
      <button id="btnContinue" class="btn">ã¤ã¥ãã‹ã‚‰</button>
      <button id="btnAbout" class="btn" style="margin-top:6px;">ã“ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦</button>
      <p id="saveState" style="opacity:.85; margin-top:8px;"></p>
    </div>
  </section>

  <!-- ===== ã‚­ãƒ£ãƒ©é¸æŠ ===== -->
  <section id="charSelect" class="screen">
    <div class="panel fade">
      <h2 style="margin:0 0 8px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­</h2>
      <div class="char-grid">
        <div class="char" data-char="green"><img src="public/char/green/calm.png" alt="green"></div>
        <div class="char" data-char="blue"><img src="public/char/blue/calm.png" alt="blue"></div>
        <div class="char" data-char="pink"><img src="public/char/pink/calm.png" alt="pink"></div>
        <div class="char" data-char="purple"><img src="public/char/purple/calm.png" alt="purple"></div>
      </div>
      <button id="toTitleFromChar" class="btn" style="margin-top:16px;">â† ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
    </div>
  </section>

  <!-- ===== ãƒ¡ã‚¤ãƒ³ç”»é¢ ===== -->
  <section id="main" class="screen">
    <div id="headerBar" class="fade">
      <img id="charIcon" src="" alt="char">
      <div id="heart">â¤ï¸ Ã— <span id="heartCount">0</span></div>
      <div id="sessionInfo" style="opacity:.85;"></div>
    </div>

    <div id="chat" class="fade" aria-live="polite"></div>

    <div id="composer" class="fade">
      <input id="input" type="text" placeholder="è¿”ç­”ã‚’å…¥åŠ›â€¦ï¼ˆEnterã§é€ä¿¡ï¼‰" />
      <button id="send" class="btn">é€ä¿¡</button>
    </div>

    <div style="position:absolute; bottom:12px; left:50%; transform:translateX(-50%); opacity:.85;">
      <button id="backToTitle" class="btn" style="width:auto; display:inline-block; padding:8px 14px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
    </div>
  </section>

  <script>
    /* ====== çŠ¶æ…‹ ====== */
    const qs = (s)=>document.querySelector(s);
    const titleScreen = qs('#titleScreen');
    const charSelect  = qs('#charSelect');
    const main        = qs('#main');
    const btnStart    = qs('#btnStart');
    const btnContinue = qs('#btnContinue');
    const btnAbout    = qs('#btnAbout');
    const saveState   = qs('#saveState');
    const sendBtn     = qs('#send');
    const input       = qs('#input');
    const chat        = qs('#chat');
    const heartCountEl= qs('#heartCount');
    const charIcon    = qs('#charIcon');

    const KEYS = {
      char: 'meai_character',
      heart: 'meai_heart',
      log: 'meai_log'
    };

    let character = localStorage.getItem(KEYS.char) || null;
    let hearts    = parseInt(localStorage.getItem(KEYS.heart) || '0', 10);
    let log       = JSON.parse(localStorage.getItem(KEYS.log) || '[]');

    /* ====== åˆæœŸè¡¨ç¤ºï¼šã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’å¿…ãšè¡¨ç¤º ====== */
    function show(el){ [titleScreen,charSelect,main].forEach(s=>s.classList.remove('show')); el.classList.add('show'); }
    function refreshTitle(){
      const hasSave = !!localStorage.getItem(KEYS.char);
      btnContinue.disabled = !hasSave;
      saveState.textContent = hasSave ? 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚â€™ã¤ã¥ãã‹ã‚‰â€™ã§å†é–‹ã§ãã¾ã™ã€‚' : 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      show(titleScreen);
    }
    refreshTitle();

    /* ====== ç”»é¢é·ç§» ====== */
    btnStart.addEventListener('click', ()=> show(charSelect));
    qs('#toTitleFromChar').addEventListener('click', refreshTitle);
    btnContinue.addEventListener('click', ()=>{
      if(!localStorage.getItem(KEYS.char)) return alert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      startMain();
    });
    btnAbout.addEventListener('click', ()=>{
      alert('ã“ã®è©¦ä½œã¯ã€AIãŒç›£è¦–ã™ã‚‹ã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚„ã£ãŸã‚ˆã€ãƒœã‚¿ãƒ³/å…¥åŠ›ã§è‡ªå·±ç”³å‘Šã™ã‚‹ã ã‘ã®è¨­è¨ˆã§ã™ï¼ˆè¨˜éŒ²ç›®çš„ï¼‰ã€‚');
    });
    qs('#backToTitle').addEventListener('click', refreshTitle);

    /* ====== ã‚­ãƒ£ãƒ©é¸æŠ ====== */
    document.querySelectorAll('.char').forEach(el=>{
      el.addEventListener('click', ()=>{
        character = el.dataset.char;
        localStorage.setItem(KEYS.char, character);
        hearts = parseInt(localStorage.getItem(KEYS.heart) || '0',10);
        if(!Array.isArray(log) || log.length===0){
          log = [];
        }
        startMain(true); // æ–°è¦é–‹å§‹
      });
    });

    /* ====== ãƒ¡ã‚¤ãƒ³é–‹å§‹ ====== */
    function startMain(newSession=false){
      // ãƒ˜ãƒƒãƒ€
      charIcon.src = `public/char/${character}/calm.png`;
      heartCountEl.textContent = hearts;
      qs('#sessionInfo').textContent = newSession ? 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³' : 'ã¤ã¥ãã‹ã‚‰';

      // ãƒãƒ£ãƒƒãƒˆæç”»
      chat.innerHTML = '';
      if(newSession || log.length===0){
        const first = pickFirstRequest(character);
        pushMsg('ai', first);
        saveAll();
      } else {
        log.forEach(m => appendMsg(m.sender, m.text));
        chat.scrollTop = chat.scrollHeight;
      }
      show(main);
      input.focus();
    }

    /* ====== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† ====== */
    function appendMsg(sender, text){
      const div = document.createElement('div');
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function pushMsg(sender, text){
      log.push({ sender, text, ts: Date.now() });
      appendMsg(sender, text);
    }

    function handleUserSend(){
      const text = input.value.trim();
      if(!text) return;
      pushMsg('user', text);
      input.value = '';

      // â€œã‚„ã£ãŸâ€/â€œã‚„ã£ãŸã‚ˆâ€ã§ãƒãƒ¼ãƒˆåŠ ç®—
      if(/ã‚„ã£ãŸ/.test(text)){
        hearts++;
        heartCountEl.textContent = hearts;
        pushMsg('ai', 'ã™ã°ã‚‰ã—ã„ï¼ãƒãƒ¼ãƒˆãŒå¢—ãˆãŸã‚ˆğŸ’–');
      } else {
        pushMsg('ai', 'ã†ã‚“ã€ãªã‚‹ã»ã©ã­ã€‚');
      }
      // æ¬¡ã®ãŠé¡˜ã„ï¼ˆã‚†ã‚‹ããƒ©ãƒ³ãƒ€ãƒ ï¼‰
      if(Math.random() < 0.45){
        pushMsg('ai', randomRequest());
      }
      saveAll();
    }

    sendBtn.addEventListener('click', handleUserSend);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleUserSend(); });

    /* ====== ãƒ­ã‚°ä¿å­˜ ====== */
    function saveAll(){
      localStorage.setItem(KEYS.heart, String(hearts));
      localStorage.setItem(KEYS.log, JSON.stringify(log));
    }

    /* ====== æ–‡è¨€ ====== */
    const REQUESTS = [
      "ä»Šæ—¥ã¯ã ã‚Œã‹ã«ã€ãŠã¯ã‚ˆã†ã€ã‚’ä¼ãˆã¦ã¿ã‚ˆã†ã€‚",
      "æ°´ã‚’ã‚³ãƒƒãƒ—ä¸€æ¯ã®ã‚‚ã†ã€‚",
      "5åˆ†ã ã‘ã‚¹ãƒˆãƒ¬ãƒƒãƒã—ã¦ã¿ã‚ˆã†ã€‚",
      "å¤–ã®ç©ºæ°—ã‚’å¸ã„ã«è¡Œã“ã†ã€‚",
      "ä»Šæ—¥ã®è‰¯ã‹ã£ãŸã“ã¨ã‚’1ã¤ãƒ¡ãƒ¢ã—ã‚ˆã†ã€‚"
    ];
    function randomRequest(){ return REQUESTS[Math.floor(Math.random()*REQUESTS.length)]; }
    function pickFirstRequest(char){
      // ã¡ã‚‡ã£ã¨ã ã‘ã‚­ãƒ£ãƒ©é¢¨å‘³
      const tag = {green:"ï¼ˆã‚„ã•ã—ãï¼‰", blue:"ï¼ˆã¦ã„ã­ã„ã«ï¼‰", pink:"ï¼ˆã‚ãã‚ãï¼‰", purple:"ï¼ˆãŠã¡ã¤ã„ã¦ï¼‰"}[char] || "";
      return `${tag} ${randomRequest()}`;
    }
  </script>
</body>
</html>
