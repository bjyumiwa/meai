<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI Prototype (multilang + rewards + safe start)</title>
<link rel="icon" href="data:,">
<style>
  html, body { height:100%; }
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
    color:#fff;
  }

  /* ===== å…±é€š ===== */
  .hidden{ display:none !important; }
  .glass{
    background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.16);
    border-radius:20px; backdrop-filter:blur(8px);
  }
  .btn{
    display:inline-flex; align-items:center; gap:.5em;
    border:none; border-radius:999px; padding:12px 18px; cursor:pointer; color:#fff;
    background:rgba(255,255,255,.18);
  }
  .btn:disabled{ opacity:.45; cursor:not-allowed; filter:saturate(.5); }
  .btn.primary{ background:linear-gradient(180deg,#ff8bd2,#ff6db3 60%,#ff55a1); color:#231227; }

  /* ===== ç”»é¢ ===== */
  .screen{ min-height:100dvh; display:grid; place-items:center; padding:24px; }
  .container{ width:min(92vw, 960px); margin:auto; }

  /* ===== è¡¨ç´™ ===== */
  .cover-card{ text-align:center; padding:28px; border-radius:28px; }
  .cover-illust{ width:180px; height:180px; object-fit:contain; filter:drop-shadow(0 8px 22px rgba(0,0,0,.6)); }
  .cover-title{ font-size:40px; font-weight:800; margin:16px 0 8px; }
  .cover-sub{ opacity:.92; margin:0 0 18px; }

  /* ===== ã‚¿ã‚¤ãƒˆãƒ« ===== */
  .title-grid{ display:grid; grid-template-columns:140px 1fr; gap:20px; align-items:center; }
  .brand img{ width:110px; height:110px; object-fit:contain; }
  .lead{ opacity:.95; line-height:1.7; }

  /* ===== ã‚­ãƒ£ãƒ©é¸æŠ ===== */
  .grid{ display:flex; flex-wrap:wrap; gap:12px; }
  .char{ width:92px; height:92px; border-radius:50%; border:1px solid rgba(255,255,255,.22);
         display:grid; place-items:center; background:rgba(255,255,255,.10); cursor:pointer; }
  .char img{ width:70px; height:70px; object-fit:contain; }

  /* ===== ãƒ¡ã‚¤ãƒ³ ===== */
  #header{ display:flex; gap:12px; align-items:center; padding:8px 12px; border-radius:999px; margin:10px auto 12px; width:max-content; }
  #chat{ height:min(60vh,460px); overflow:auto; padding:16px; border-radius:16px; }
  .bubble{ max-width:78%; margin:10px 0; padding:12px 16px; border-radius:16px; line-height:1.7; font-size:18px; }
  .ai{ background:linear-gradient(145deg, rgba(150,220,255,.28), rgba(150,200,255,.14)); border:1px solid rgba(150,220,255,.34); float:left; clear:both; }
  .user{ background:linear-gradient(145deg, rgba(255,255,255,.26), rgba(255,255,255,.12)); border:1px solid rgba(255,255,255,.28); float:right; clear:both; }
  #composer{ display:flex; gap:8px; margin:10px 0; }
  #input{ flex:1; padding:12px 14px; border:none; border-radius:12px; color:#fff; background:rgba(255,255,255,.14); }
  #footerMenu{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:10px 0 20px; }

  /* ===== ã”è¤’ç¾UI ===== */
  #rewardToast{
    position:fixed; right:16px; bottom:80px; z-index:1300;
    background:rgba(30,30,40,.85); border:1px solid rgba(255,255,255,.18);
    padding:12px 14px; border-radius:14px; display:none; max-width:min(80vw,380px);
    box-shadow:0 10px 30px rgba(0,0,0,.4); backdrop-filter: blur(8px);
  }
  #rewardToast .ttl{ font-weight:800; margin-bottom:4px; }
  #rewardToast .emo{ font-size:24px; line-height:1; margin-right:6px; }

  #rewardsModal{
    position:fixed; inset:0; display:none; z-index:1500;
    background: rgba(0,0,0,.45); backdrop-filter: blur(3px);
  }
  #rewardsModal .wrap{
    width:min(92vw, 760px); max-height:80vh; overflow:auto;
    background:rgba(15,15,24,.86); border:1px solid rgba(255,255,255,.18);
    border-radius:20px; padding:18px; margin:10vh auto 0; backdrop-filter: blur(10px);
  }
  .badge{ display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.12); margin:4px; font-size:14px; border:1px solid rgba(255,255,255,.18); }
  .stamps{ display:flex; flex-wrap:wrap; gap:8px; }
  .stamp{ width:44px; height:44px; display:grid; place-items:center; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.18); border-radius:10px; font-size:22px; }
  .list-row{display:flex; gap:10px; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.1);}
  .list-row b{min-width:7em;}
  .mono{font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);}

  /* ç´™å¹é›ª */
  .confetti{ position: fixed; width:8px; height:14px; top:-20px; z-index:1400;
    opacity:.95; transform:rotate(0deg); animation: confetti-fall linear forwards; }
  @keyframes confetti-fall{ to { transform: translateY(120vh) rotate(360deg); opacity:1; } }

  /* è¨€èªã‚¹ã‚¤ãƒƒãƒ */
  .langbox{ display:flex; gap:8px; align-items:center; justify-content:center; margin-top:12px; }
  .langbox select{
    background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.25);
    border-radius:10px; padding:6px 10px; font-size:14px;
  }
</style>
</head>
<body>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div id="rewardToast" role="status" aria-live="polite"></div>

<!-- ã”è¤’ç¾ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="rewardsModal" aria-modal="true" role="dialog">
  <div class="wrap" tabindex="-1">
    <button class="btn" id="closeRewards" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">é–‰ã˜ã‚‹</button>
    <h3 id="lblRewardsTitle">ã”è¤’ç¾ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h3>
    <div id="rewardSummary" class="mono" style="margin:4px 0 10px;opacity:.9;"></div>

    <h4 id="lblMilestones">ç§°å·ï¼ˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼‰</h4>
    <div id="badgeList"></div>

    <h4 id="lblStamps" style="margin-top:12px;">ã‚¹ã‚¿ãƒ³ãƒ—</h4>
    <div class="stamps" id="stampList"></div>

    <h4 id="lblAura" style="margin-top:12px;">è¦‹ãŸç›®ï¼ˆã‚ªãƒ¼ãƒ©ï¼‰</h4>
    <div id="auraList"></div>
    <p class="mono" style="margin-top:6px;opacity:.8;" id="lblAuraNote">â€» ã‚ªãƒ¼ãƒ©ã¯æœ€æ–°ã‚’è‡ªå‹•è£…å‚™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´ã§ãã¾ã™ã€‚</p>

    <hr style="border:none; border-top:1px solid rgba(255,255,255,.12); margin:16px 0;">
    <h3 id="lblCatalog">ã”è¤’ç¾ã‚«ã‚¿ãƒ­ã‚°</h3>
    <div id="catalogStamps" class="stamps"></div>
    <div id="catalogBadges"></div>

    <hr style="border:none; border-top:1px solid rgba(255,255,255,.12); margin:16px 0;">
    <h3 id="lblHistory">ç²å¾—å±¥æ­´</h3>
    <p class="mono" style="opacity:.8;" id="lblHistoryNote">æœ€è¿‘ã®ç²å¾—ï¼ˆæœ€å¤§20ä»¶ï¼‰</p>
    <div id="rewardHistory"></div>
  </div>
</div>

<!-- ===== è¡¨ç´™ ===== -->
<section id="cover" class="screen">
  <div class="container">
    <div class="glass cover-card">
      <img class="cover-illust" src="public/miwacchi_open.png" alt="MeAI cover" onerror="this.src='public/cover.png'">
      <div class="cover-title" id="titleApp">MeAI</div>
      <p class="cover-sub" id="titleLead">å°ã•ãªâ€œã‚„ã£ã¦ã¿ã‚‹â€ã‚’ã€ã‚„ã•ã—ãææ¡ˆã—ã¦ãã‚Œã‚‹ç›¸æ£’ã€‚</p>
      <button id="coverStart" class="btn primary" type="button">â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <div class="langbox">
        <label for="langSelect">ğŸŒ</label>
        <select id="langSelect">
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="en">English</option>
          <option value="zh">ä¸­æ–‡</option>
          <option value="ko">í•œêµ­ì–´</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- ===== ã‚¿ã‚¤ãƒˆãƒ« ===== -->
<section id="title" class="screen hidden">
  <div class="container glass" style="padding:20px;">
    <div class="title-grid">
      <div class="brand"><img src="public/char/green/calm.png" alt=""></div>
      <div>
        <h1 style="margin:.2em 0 .1em;" id="lblMenuTitle">MeAI</h1>
        <p class="lead" id="lblLead">â€œç”Ÿæ´»ã«å¯„ã‚Šæ·»ã†ãŠé¡˜ã„â€ã‚’å—ã‘å–ã‚Šã€<br>ã€Œã¯ã„ã€ã‚„ã£ãŸã‚ˆã€ã§è‡ªå·±ç”³å‘Šã—ã¦è¨˜éŒ²ã™ã‚‹ãƒŸãƒ‹ã‚¢ãƒ—ãƒªã§ã™ã€‚<br>â€» ç›£è¦–ã¯ã—ã¾ã›ã‚“ã€‚ãƒœã‚¿ãƒ³/æ–‡å­—å…¥åŠ›ã§è¨˜éŒ²ã™ã‚‹ã ã‘ã€‚</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="start" class="btn" type="button">ã¯ã˜ã‚ã‹ã‚‰</button>
          <button id="cont"  class="btn" type="button">ã¤ã¥ãã‹ã‚‰</button>
          <button id="about" class="btn" type="button">ã“ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦</button>
          <button id="rewardsBtn" class="btn" type="button">ã”è¤’ç¾</button>
        </div>
        <p id="savestate" style="opacity:.9;margin-top:8px;"></p>
        <div class="langbox">
          <label for="langSelect2">ğŸŒ</label>
          <select id="langSelect2">
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="en">English</option>
            <option value="zh">ä¸­æ–‡</option>
            <option value="ko">í•œêµ­ì–´</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===== ã‚­ãƒ£ãƒ©é¸æŠ ===== -->
<section id="choose" class="screen hidden">
  <div class="container glass" style="padding:18px;">
    <h2 style="margin:6px 0 12px;" id="lblChoose">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­</h2>
    <div class="grid" id="charGrid">
      <button class="char" data-char="green" type="button" aria-label="green" id="charGreen"><img src="public/char/green/calm.png" alt=""></button>
      <button class="char" data-char="blue"  type="button" aria-label="blue"  id="charBlue"><img  src="public/char/blue/calm.png"  alt=""></button>
      <button class="char" data-char="pink"  type="button" aria-label="pink"  id="charPink"><img  src="public/char/pink/calm.png"  alt=""></button>
      <button class="char" data-char="purple"type="button" aria-label="purple" id="charPurple"><img src="public/char/purple/calm.png"alt=""></button>
    </div>
    <div style="margin-top:14px;"><button id="backTitle" class="btn" type="button">â† ã‚¿ã‚¤ãƒˆãƒ«ã¸</button></div>
  </div>
</section>

<!-- ===== ãƒ¡ã‚¤ãƒ³ ===== -->
<section id="main" class="screen hidden">
  <div class="container">
    <div id="header" class="glass">
      <img id="charIcon" src="" alt="" width="30" height="30">
      <div id="heart">â¤ï¸ Ã— <span id="heartCount">0</span></div>
      <div id="sessionInfo" style="opacity:.85;"></div>
    </div>

    <div id="chat" class="glass" aria-live="polite"></div>

    <div id="composer">
      <input id="input" class="glass" type="text" placeholder="è¿”ç­”ã‚’å…¥åŠ›â€¦ï¼ˆEnterã§é€ä¿¡ï¼‰" />
      <button id="send" class="btn" type="button">é€ä¿¡</button>
      <button id="done" class="btn" type="button">ã‚„ã£ãŸã‚ˆ</button>
    </div>

    <div id="footerMenu">
      <button id="toTitle" class="btn" type="button">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
      <button id="showLog" class="btn" type="button">ãƒ­ã‚°ã‚’ç¢ºèª</button>
      <button id="rewardsBtn2" class="btn" type="button">ã”è¤’ç¾</button>
      <button id="reset" class="btn" type="button">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
    </div>
  </div>
</section>

<script>
(function(){
  // ===== i18n =====
  const I18N = {
    ja: {
      app:"MeAI",
      lead:"â€œç”Ÿæ´»ã«å¯„ã‚Šæ·»ã†ãŠé¡˜ã„â€ã‚’å—ã‘å–ã‚Šã€<br>ã€Œã¯ã„ã€ã‚„ã£ãŸã‚ˆã€ã§è‡ªå·±ç”³å‘Šã—ã¦è¨˜éŒ²ã™ã‚‹ãƒŸãƒ‹ã‚¢ãƒ—ãƒªã§ã™ã€‚<br>â€» ç›£è¦–ã¯ã—ã¾ã›ã‚“ã€‚ãƒœã‚¿ãƒ³/æ–‡å­—å…¥åŠ›ã§è¨˜éŒ²ã™ã‚‹ã ã‘ã€‚",
      coverLead:"å°ã•ãªâ€œã‚„ã£ã¦ã¿ã‚‹â€ã‚’ã€ã‚„ã•ã—ãææ¡ˆã—ã¦ãã‚Œã‚‹ç›¸æ£’ã€‚",
      start:"ã¯ã˜ã‚ã‹ã‚‰", cont:"ã¤ã¥ãã‹ã‚‰", about:"ã“ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦", rewards:"ã”è¤’ç¾",
      choose:"ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­",
      toTitle:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸", showLog:"ãƒ­ã‚°ã‚’ç¢ºèª", reset:"ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–", send:"é€ä¿¡", done:"ã‚„ã£ãŸã‚ˆ",
      noSave:"ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", hasSave:"ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã€Œã¤ã¥ãã‹ã‚‰ã€ã§å†é–‹ã§ãã¾ã™ã€‚",
      newSession:"æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³", fromSave:"ã¤ã¥ãã‹ã‚‰",
      aboutText:"ã“ã®è©¦ä½œã¯AIãŒç›£è¦–ã™ã‚‹ã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå·±ç”³å‘Šï¼ˆã€Œã‚„ã£ãŸã‚ˆã€ï¼‰ã§è¨˜éŒ²ã™ã‚‹ã ã‘ã®è¨­è¨ˆã§ã™ã€‚",
      rewardsTitle:"ã”è¤’ç¾ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³", milestones:"ç§°å·ï¼ˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼‰", stamps:"ã‚¹ã‚¿ãƒ³ãƒ—", aura:"è¦‹ãŸç›®ï¼ˆã‚ªãƒ¼ãƒ©ï¼‰",
      auraNote:"â€» ã‚ªãƒ¼ãƒ©ã¯æœ€æ–°ã‚’è‡ªå‹•è£…å‚™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´ã§ãã¾ã™ã€‚", catalog:"ã”è¤’ç¾ã‚«ã‚¿ãƒ­ã‚°",
      history:"ç²å¾—å±¥æ­´", historyNote:"æœ€è¿‘ã®ç²å¾—ï¼ˆæœ€å¤§20ä»¶ï¼‰", noHistory:"ï¼ˆã¾ã ç²å¾—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰",
      laterMsg:(h)=>`ã¾ãŸå¾Œã§ã­ã€‚ç´„${h}æ™‚é–“å¾Œã«æ¬¡ã®ææ¡ˆã‚’é€ã‚‹ã­ã€‚`,
      aiAck:"ã†ã‚“ã€ãªã‚‹ã»ã©ã­ã€‚",
      great:"ã™ã°ã‚‰ã—ã„ï¼ãƒãƒ¼ãƒˆãŒå¢—ãˆãŸã‚ˆğŸ’–",
      requests: [
        "ãŠã¯ã‚ˆã†ã£ã¦è¨€ã£ã¦ã€‚","ã‚³ãƒƒãƒ—ä¸€æ¯ã®ãŠæ°´ã‚’é£²ã‚“ã§ã¿ã¦ã€‚","5ç§’ã ã‘ã€é™ã‹ã«ç›®ã‚’é–‰ã˜ã¦ã¿ã‚ˆã†ã€‚",
        "ä»Šæ—¥ã®ç©ºã®è‰²ã‚’ã²ã¨ã“ã¨ã§æ•™ãˆã¦ã€‚","çª“ã‚’å°‘ã—é–‹ã‘ã¦ã€ç©ºæ°—ã‚’å…¥ã‚Œæ›¿ãˆã‚ˆã†ã€‚","æ·±å‘¼å¸ã‚’3å›ã—ã¦ã¿ã‚ˆã†ã€‚",
        "å¥½ããªéŸ³ã‚’5ç§’ã ã‘èã‹ã›ã¦ã€‚ï¼ˆå¿ƒã®ä¸­ã§ã‚‚OKï¼‰","èŠ±ã‚„æ¤ç‰©ã‚’ã²ã¨ã¤æ€ã„æµ®ã‹ã¹ã¦ã€åå‰ã‚’æ•™ãˆã¦ã€‚",
        "ä»Šã„ã‚‹éƒ¨å±‹ã§ã€ã‚„ã•ã—ã„è‰²ã‚’æ¢ã—ã¦æ•™ãˆã¦ã€‚","å§¿å‹¢ã‚’ã™ã“ã—ä¼¸ã°ã—ã¦ã€è‚©ã‚’å›ã—ã¦ã¿ã‚ˆã†ã€‚",
        "ã‚«ãƒ¼ãƒ†ãƒ³ã‚’å°‘ã—é–‹ã‘ã¦ã€æ˜ã‚‹ã•ã‚’æ„Ÿã˜ã¦ã¿ã¦ã€‚","ãŠã‚„ã¤ã‹é£²ã¿ç‰©ã‚’ã²ã¨å£ã€å‘³ã‚ã£ã¦ã¿ã‚ˆã†ã€‚",
        "æœºã®ä¸Šã‚’10ç§’ã ã‘æ•´ãˆã¦ã¿ã‚ˆã†ã€‚","ç›®ã®å‰ã®â€œä¸¸ã„å½¢â€ã‚’ã²ã¨ã¤è¦‹ã¤ã‘ã¦æ•™ãˆã¦ã€‚",
        "è€³ã‚’ã™ã¾ã›ã¦ã€ã„ã¡ã°ã‚“å°ã•ãªéŸ³ã‚’æ¢ã—ã¦ã¿ã‚ˆã†ã€‚","æ‰‹ã‚’æ¸©ã‚ãŸã‚Šã€å†·ãŸã„ã‚‚ã®ã«è§¦ã‚ŒãŸã‚Šã—ã¦ã€æ„Ÿè§¦ã‚’æ•™ãˆã¦ã€‚",
        "ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’å¿ƒã®ä¸­ã§1å›è¨€ã£ã¦ã¿ã‚ˆã†ã€‚","å¤–ã®é¢¨ã‚„ç©ºæ°—ã®æ¸©åº¦ã‚’æ„Ÿã˜ã¦ã€ã²ã¨è¨€ã§æ•™ãˆã¦ã€‚",
        "æ™‚è¨ˆã®éŸ³ã€ã‚ã‚‹ï¼Ÿãªã„ï¼Ÿ","ä»Šã®æ°—åˆ†ã‚’å¤©æ°—ã§è¨€ã†ã¨ï¼Ÿï¼ˆæ™´ã‚Œ/æ›‡ã‚Š/é›¨/é›ª/é¢¨ï¼‰",
        "å¥½ããªè¨€è‘‰ã‚’ã²ã¨ã¤æ€ã„å‡ºã—ã¦ã€æ•™ãˆã¦ã€‚","éƒ¨å±‹ã®ä¸­ã§â€œã‚„ã‚ã‚‰ã‹ã„ã‚‚ã®â€ã‚’è§¦ã£ã¦ã¿ã‚ˆã†ã€‚",
        "çª“ã®å¤–ã‚’10ç§’è¦‹ã¦ã€æ°—ã¥ã„ãŸã“ã¨ã‚’ã²ã¨è¨€ã€‚","ã‚¹ãƒãƒ›ã‚’è£å‘ãã«ã—ã¦10ç§’ç½®ã„ã¦ã¿ã‚ˆã†ã€‚",
        "ã‚†ã£ãã‚Šé¦–ã‚’å·¦å³ã«å›ã—ã¦ã€ã“ã‚Šå…·åˆã‚’æ•™ãˆã¦ã€‚","ä»Šæ—¥ã®è‰²ã‚’ã²ã¨ã¤é¸ã‚“ã§ã€æ•™ãˆã¦ã€‚",
        "ä»Šã®éŸ³é‡ï¼ˆé™ã‹/ãµã¤ã†/ã«ãã‚„ã‹ï¼‰ã‚’æ•™ãˆã¦ã€‚","å¥½ããªåŒ‚ã„ã‚’ã²ã¨ã¤æ€ã„å‡ºã—ã¦ã€æ•™ãˆã¦ã€‚",
        "â€œãŠã‹ãˆã‚Šâ€ã£ã¦è¨€ã£ã¦ã¿ã¦ã€‚","â€œãŠã‚„ã™ã¿â€ã£ã¦è¨€ã£ã¦ãã‚Œã‚‹ï¼Ÿ"
      ],
      tone:{green:"ï¼ˆã‚„ã•ã—ãï¼‰",blue:"ï¼ˆã¦ã„ã­ã„ã«ï¼‰",pink:"ï¼ˆã‚ãã‚ãï¼‰",purple:"ï¼ˆãŠã¡ã¤ã„ã¦ï¼‰"}
    },
    en: {
      app:"MeAI",
      lead:'A tiny companion that suggests gentle â€œdoableâ€ actions. <br>You log them yourself with â€œDoneâ€, there is no monitoring.',
      coverLead:"A gentle buddy that nudges small try-outs.",
      start:"Start", cont:"Continue", about:"About this prototype", rewards:"Rewards",
      choose:"Pick your character",
      toTitle:"Menu", showLog:"Show Log", reset:"Reset Data", send:"Send", done:"Done",
      noSave:"No save data.", hasSave:'Save data found. Use "Continue".',
      newSession:"New session", fromSave:"From save",
      aboutText:"This prototype does not monitor activity. You self-report with the Done button or text.",
      rewardsTitle:"Rewards Collection", milestones:"Milestones", stamps:"Stamps", aura:"Auras",
      auraNote:"The latest aura auto-equips. Click to change.", catalog:"Rewards Catalog",
      history:"History", historyNote:"Recent (max 20)", noHistory:"(No history yet)",
      laterMsg:(h)=>`See you later! Iâ€™ll nudge you again in about ${h} hours.`,
      aiAck:"Got it.",
      great:"Great! You earned a heart ğŸ’–",
      requests:[
        "Say good morning to someone.","Drink a glass of water.","Close your eyes for 5 seconds.",
        "Describe todayâ€™s sky color in one word.","Open the window a little for fresh air.","Take 3 deep breaths.",
        "Listen to a favorite sound for 5 seconds (in your mind is OK).","Think of a plant and tell me its name.",
        "Find a gentle color in your room.","Stretch your posture and roll your shoulders.",
        "Open the curtain a bit and feel the light.","Sip a snack or drink mindfully.",
        "Tidy your desk for 10 seconds.","Find a round shape in front of you.",
        "Listen for the tiniest sound.","Touch something warm or cool and tell the feel.",
        "Say â€œthank youâ€ once in your mind.","Feel the outdoor air/temperature and report in a word.",
        "Is there a clock sound?","If your mood were weather, what is it?",
        "Recall a favorite word and share it.","Touch something soft in the room.",
        "Look out the window for 10 seconds and share one notice.","Put your phone face-down for 10 seconds.",
        "Gently rotate your neck; how stiff is it?","Pick todayâ€™s color and tell me.",
        "Whatâ€™s the noise level (quiet/normal/busy)?","Recall a favorite smell and share it.",
        "Say â€œwelcome back.â€","Say â€œgood night,â€ please."
      ],
      tone:{green:"(gentle)",blue:"(polite)",pink:"(excited)",purple:"(calm)"}
    },
    zh: {
      app:"MeAI",
      lead:"è¿™æ˜¯ä¸€ä¸ªæ¸©æŸ”çš„ä¼™ä¼´ï¼Œç»™å‡ºå°è€Œå¯è¡Œçš„å»ºè®®ã€‚<br>åªéœ€è‡ªå·±ç‚¹å‡»â€œå®Œæˆâ€è®°å½•ï¼Œæ²¡æœ‰ç›‘æ§ã€‚",
      coverLead:"æ¸©æŸ”çš„å°ä¼™ä¼´ï¼Œè½»è½»æ¨åŠ¨ä½ å°è¯•å°äº‹ã€‚",
      start:"å¼€å§‹", cont:"ç»§ç»­", about:"å…³äºæœ¬åŸå‹", rewards:"å¥–åŠ±",
      choose:"è¯·é€‰æ‹©è§’è‰²",
      toTitle:"èœå•", showLog:"æŸ¥çœ‹æ—¥å¿—", reset:"é‡ç½®æ•°æ®", send:"å‘é€", done:"å®Œæˆ",
      noSave:"æ²¡æœ‰å­˜æ¡£ã€‚", hasSave:"å‘ç°å­˜æ¡£ï¼Œå¯ç‚¹å‡»â€œç»§ç»­â€ã€‚",
      newSession:"æ–°ä¼šè¯", fromSave:"ç»§ç»­ä¼šè¯",
      aboutText:"æ­¤åŸå‹ä¸è¿›è¡Œç›‘æ§ï¼Œåªé ä½ è‡ªå·±ç‚¹å‡»â€œå®Œæˆâ€æˆ–è¾“å…¥æ–‡å­—æ¥è®°å½•ã€‚",
      rewardsTitle:"å¥–åŠ±æ”¶è—", milestones:"é‡Œç¨‹ç¢‘", stamps:"è´´çº¸", aura:"å…‰ç¯",
      auraNote:"æœ€æ–°å…‰ç¯ä¼šè‡ªåŠ¨è£…å¤‡ï¼Œç‚¹å‡»å¯åˆ‡æ¢ã€‚", catalog:"å¥–åŠ±ç›®å½•",
      history:"è·å–è®°å½•", historyNote:"æœ€è¿‘ï¼ˆæœ€å¤š20æ¡ï¼‰", noHistory:"ï¼ˆæš‚æ— è®°å½•ï¼‰",
      laterMsg:(h)=>`ç¨åè§ï¼å¤§çº¦ ${h} å°æ—¶åå†ç»™ä½ æ–°çš„å»ºè®®ã€‚`,
      aiAck:"æ˜ç™½äº†ã€‚",
      great:"å¤ªæ£’äº†ï¼è·å¾—äº†ä¸€é¢—çˆ±å¿ƒ ğŸ’–",
      requests:[
        "è·ŸæŸäººè¯´å£°æ—©å®‰ã€‚","å–ä¸€æ¯æ°´ã€‚","é—­çœ¼ 5 ç§’é’Ÿã€‚",
        "ç”¨ä¸€ä¸ªè¯æè¿°ä»Šå¤©çš„å¤©ç©ºé¢œè‰²ã€‚","ç¨å¾®å¼€ä¸‹çª—é€šé£ã€‚","æ·±å‘¼å¸ 3 æ¬¡ã€‚",
        "å¬ 5 ç§’å–œæ¬¢çš„å£°éŸ³ï¼ˆå¿ƒé‡Œæƒ³ä¹Ÿå¯ï¼‰ã€‚","æƒ³ä¸€ä¸ªæ¤ç‰©å¹¶å‘Šè¯‰æˆ‘åå­—ã€‚",
        "æ‰¾æ‰¾æˆ¿é—´é‡Œæ¸©æŸ”çš„é¢œè‰²ã€‚","ä¼¸å±•å§¿åŠ¿ï¼Œè½¬åŠ¨è‚©è†€ã€‚",
        "æ‹‰å¼€ä¸€ç‚¹çª—å¸˜æ„Ÿå—å…‰çº¿ã€‚","ç»†ç»†å“ä¸€å£é›¶é£Ÿæˆ–é¥®æ–™ã€‚",
        "æ•´ç†æ¡Œé¢ 10 ç§’ã€‚","æ‰¾ä¸€ä¸ªâ€œåœ†å½¢â€ã€‚",
        "ç•™å¿ƒæœ€å¾®å°çš„å£°éŸ³ã€‚","æ‘¸æ‘¸æ¸©çƒ­æˆ–å†°å‡‰çš„ä¸œè¥¿ï¼Œè¯´è¯´è§¦æ„Ÿã€‚",
        "åœ¨å¿ƒé‡Œè¯´ä¸€å¥â€œè°¢è°¢â€ã€‚","æ„Ÿå—å®¤å¤–ç©ºæ°”/æ¸©åº¦ï¼Œç”¨ä¸€å¥è¯è¯´è¯´ã€‚",
        "èƒ½å¬åˆ°é’Ÿå£°å—ï¼Ÿ","å¦‚æœå¿ƒæƒ…æ˜¯å¤©æ°”ï¼Œä¼šæ˜¯å“ªç§ï¼Ÿ",
        "æƒ³èµ·ä¸€ä¸ªå–œæ¬¢çš„è¯å¹¶åˆ†äº«ã€‚","æ‘¸æ‘¸æˆ¿é—´é‡Œâ€œæŸ”è½¯çš„ä¸œè¥¿â€ã€‚",
        "å‘çª—å¤–çœ‹ 10 ç§’ï¼Œè¯´ä¸€ä¸ªå‘ç°ã€‚","æŠŠæ‰‹æœºåæ”¾ 10 ç§’ã€‚",
        "è½»è½»è½¬åŠ¨è„–å­ï¼Œåƒµç¡¬åº¦å¦‚ä½•ï¼Ÿ","é€‰ä¸€ä¸ªä»Šå¤©çš„é¢œè‰²å¹¶å‘Šè¯‰æˆ‘ã€‚",
        "å½“å‰å™ªå£°ç­‰çº§ï¼ˆå®‰é™/æ­£å¸¸/å˜ˆæ‚ï¼‰ï¼Ÿ","å›æƒ³ä¸€ç§å–œæ¬¢çš„æ°”å‘³å¹¶åˆ†äº«ã€‚",
        "è¯´ä¸€å¥â€œæ¬¢è¿å›æ¥â€ã€‚","è¯·è¯´â€œæ™šå®‰â€ã€‚"
      ],
      tone:{green:"ï¼ˆæ¸©æŸ”ï¼‰",blue:"ï¼ˆç¤¼è²Œï¼‰",pink:"ï¼ˆå…´å¥‹ï¼‰",purple:"ï¼ˆå¹³é™ï¼‰"}
    },
    ko: {
      app:"MeAI",
      lead:"ì‘ê²Œ ì‹œë„í•´ë³¼ ì¼ì„ ë‹¤ì •í•˜ê²Œ ì œì•ˆí•´ì£¼ëŠ” ë™ë°˜ìì…ë‹ˆë‹¤.<br>â€˜ì™„ë£Œâ€™ë¡œ ì§ì ‘ ê¸°ë¡í•˜ë©°, ê°ì‹œëŠ” ì—†ìŠµë‹ˆë‹¤.",
      coverLead:"ì‘ì€ ì‹œë„ë¥¼ ì‚´ì§ ë°€ì–´ì£¼ëŠ” ë‹¤ì •í•œ ì¹œêµ¬.",
      start:"ì²˜ìŒë¶€í„°", cont:"ì´ì–´í•˜ê¸°", about:"í”„ë¡œí† íƒ€ì… ì •ë³´", rewards:"ë³´ìƒ",
      choose:"ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”",
      toTitle:"ë©”ë‰´", showLog:"ë¡œê·¸ ë³´ê¸°", reset:"ë°ì´í„° ì´ˆê¸°í™”", send:"ë³´ë‚´ê¸°", done:"í–ˆì–´ìš”",
      noSave:"ì €ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", hasSave:"ì €ì¥ ë°ì´í„°ë¥¼ ì°¾ì•˜ì–´ìš”. â€˜ì´ì–´í•˜ê¸°â€™ë¥¼ ëˆ„ë¥´ì„¸ìš”.",
      newSession:"ìƒˆ ì„¸ì…˜", fromSave:"ì´ì–´í•˜ê¸°",
      aboutText:"ì´ í”„ë¡œí† íƒ€ì…ì€ í™œë™ì„ ê°ì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ â€˜í–ˆì–´ìš”â€™ ë²„íŠ¼ì´ë‚˜ í…ìŠ¤íŠ¸ë¡œ ì§ì ‘ ê¸°ë¡í•©ë‹ˆë‹¤.",
      rewardsTitle:"ë³´ìƒ ì»¬ë ‰ì…˜", milestones:"ë§ˆì¼ìŠ¤í†¤", stamps:"ìŠ¤íƒ¬í”„", aura:"ì˜¤ë¼",
      auraNote:"ê°€ì¥ ìµœê·¼ ì˜¤ë¼ëŠ” ìë™ ì¥ì°©ë©ë‹ˆë‹¤. í´ë¦­í•´ì„œ ë³€ê²½í•˜ì„¸ìš”.", catalog:"ë³´ìƒ ì¹´íƒˆë¡œê·¸",
      history:"íšë“ ê¸°ë¡", historyNote:"ìµœê·¼ (ìµœëŒ€ 20ê°œ)", noHistory:"(ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤)",
      laterMsg:(h)=>`${h}ì‹œê°„ í›„ì— ë‹¤ì‹œ ì œì•ˆí• ê²Œìš”!`,
      aiAck:"ì•Œê² ì–´.",
      great:"ë©‹ì ¸ìš”! í•˜íŠ¸ê°€ ëŠ˜ì—ˆì–´ìš” ğŸ’–",
      requests:[
        "ëˆ„êµ°ê°€ì—ê²Œ â€˜ì¢‹ì€ ì•„ì¹¨â€™ì´ë¼ê³  ë§í•´ìš”.","ë¬¼ í•œ ì” ë§ˆì…”ìš”.","ëˆˆì„ 5ì´ˆê°„ ê°ì•„ë´ìš”.",
        "ì˜¤ëŠ˜ í•˜ëŠ˜ ìƒ‰ì„ í•œ ë‹¨ì–´ë¡œ ë§í•´ìš”.","ì°½ë¬¸ì„ ì¡°ê¸ˆ ì—´ì–´ ê³µê¸°ë¥¼ ë°”ê¿”ìš”.","ì‹¬í˜¸í¡ 3ë²ˆ.",
        "ì¢‹ì•„í•˜ëŠ” ì†Œë¦¬ë¥¼ 5ì´ˆ ë“£ê¸°(ë§ˆìŒì†ë„ OK).","ì‹ë¬¼ í•˜ë‚˜ë¥¼ ë– ì˜¬ë¦¬ê³  ì´ë¦„ì„ ë§í•´ìš”.",
        "ë°©ì—ì„œ ì€ì€í•œ ìƒ‰ì„ ì°¾ì•„ìš”.","ìì„¸ë¥¼ í´ê³  ì–´ê¹¨ë¥¼ ëŒë ¤ìš”.",
        "ì»¤íŠ¼ì„ ì¡°ê¸ˆ ì—´ê³  ë°ìŒì„ ëŠê»´ìš”.","ê°„ì‹ì´ë‚˜ ìŒë£Œë¥¼ í•œ ëª¨ê¸ˆ ìŒë¯¸í•´ìš”.",
        "ì±…ìƒì„ 10ì´ˆ ì •ë¦¬í•´ìš”.","ëˆˆì•ì˜ â€˜ë‘¥ê·¼ ëª¨ì–‘â€™ì„ ì°¾ì•„ìš”.",
        "ê°€ì¥ ì‘ì€ ì†Œë¦¬ë¥¼ ë“¤ì–´ë´ìš”.","ë”°ëœ»í•˜ê±°ë‚˜ ì°¨ê°€ìš´ ê²ƒì„ ë§Œì§€ê³  ê°ì´‰ì„ ë§í•´ìš”.",
        "ë§ˆìŒì†ìœ¼ë¡œ â€˜ê³ ë§ˆì›Œâ€™ë¼ê³  ë§í•´ìš”.","ë°–ì˜ ê³µê¸°/ì˜¨ë„ë¥¼ ëŠë¼ê³  í•œë§ˆë””ë¡œ ë§í•´ìš”.",
        "ì‹œê³„ ì†Œë¦¬ ë“¤ë ¤ìš”?","ê¸°ë¶„ì„ ë‚ ì”¨ë¡œ í‘œí˜„í•˜ë©´?",
        "ì¢‹ì•„í•˜ëŠ” ë‹¨ì–´ í•˜ë‚˜ë¥¼ ë– ì˜¬ë ¤ ë§í•´ìš”.","ë°© ì•ˆì˜ â€˜ë¶€ë“œëŸ¬ìš´ ê²ƒâ€™ì„ ë§Œì ¸ë´ìš”.",
        "ì°½ë°–ì„ 10ì´ˆ ë³´ê³  í•˜ë‚˜ë§Œ ë§í•´ìš”.","íœ´ëŒ€ë¥¼ ë’¤ì§‘ì–´ 10ì´ˆ ë‚´ë ¤ë†“ì•„ìš”.",
        "ëª©ì„ ì¢Œìš°ë¡œ ì²œì²œíˆ ëŒë¦¬ê³  ë»ê·¼í•¨ì„ ë§í•´ìš”.","ì˜¤ëŠ˜ì˜ ìƒ‰ í•˜ë‚˜ë¥¼ ì •í•´ ë§í•´ìš”.",
        "ì§€ê¸ˆ ì†ŒìŒ ìˆ˜ì¤€(ì¡°ìš©/ë³´í†µ/ë¶ì )?","ì¢‹ì•„í•˜ëŠ” ëƒ„ìƒˆë¥¼ ë– ì˜¬ë ¤ ë§í•´ìš”.",
        "â€˜ë‹¤ë…€ì™”ì–´â€™ë¼ê³  ë§í•´ìš”.","â€˜ì˜ ìâ€™ë¼ê³  ë§í•´ì¤„ë˜ìš”?"
      ],
      tone:{green:"(ë‹¤ì •í•˜ê²Œ)",blue:"(ì •ì¤‘í•˜ê²Œ)",pink:"(ì„¤ë ˆê²Œ)",purple:"(ì°¨ë¶„í•˜ê²Œ)"}
    }
  };
  const LS_LANG = "meai_lang";
  const getLang = () => localStorage.getItem(LS_LANG) || "ja";
  const setLang = (v) => { localStorage.setItem(LS_LANG, v); applyLang(v); };

  function $(s,root=document){ return root.querySelector(s); }
  function on(el,ev,fn,opt){ if(el) el.addEventListener(ev,fn,opt||false); }

  // ç”»é¢
  const scr = { cover:$('#cover'), title:$('#title'), choose:$('#choose'), main:$('#main') };
  function show(id){ Object.values(scr).forEach(el=>el && el.classList.add('hidden')); scr[id]?.classList.remove('hidden'); }

  // DOM
  const langSelect  = $('#langSelect');
  const langSelect2 = $('#langSelect2');

  const btnCoverStart = $('#coverStart');
  const btnStart = $('#start'), btnCont = $('#cont'), btnAbout = $('#about'), saveState = $('#savestate');
  const btnBackTitle = $('#backTitle'), btnToTitle = $('#toTitle'), btnReset = $('#reset'), btnShowLog = $('#showLog');
  const btnRewardsTitle = $('#rewardsBtn'), btnRewardsMain = $('#rewardsBtn2');
  const rewardsModal = $('#rewardsModal'), rewardsWrap = rewardsModal.querySelector('.wrap'), closeRewards = $('#closeRewards');
  const rewardToast = $('#rewardToast');
  const rewardSummary = $('#rewardSummary'), badgeList = $('#badgeList'), stampList = $('#stampList'), auraList = $('#auraList');
  const catalogStamps = $('#catalogStamps'), catalogBadges = $('#catalogBadges'), rewardHistory = $('#rewardHistory');

  const chat = $('#chat'), input = $('#input'), btnSend = $('#send'), btnDone = $('#done');
  const heartCountEl = $('#heartCount'), charIcon = $('#charIcon'), sessionInfo = $('#sessionInfo');

  // ãƒ©ãƒ™ãƒ«è¦ç´ 
  const titleApp = $('#titleApp'), titleLead = $('#titleLead');
  const lblMenuTitle = $('#lblMenuTitle'), lblLead = $('#lblLead');
  const lblChoose = $('#lblChoose');
  const lblRewardsTitle = $('#lblRewardsTitle'), lblMilestones = $('#lblMilestones'),
        lblStamps = $('#lblStamps'), lblAura = $('#lblAura'), lblAuraNote = $('#lblAuraNote'),
        lblCatalog = $('#lblCatalog'), lblHistory = $('#lblHistory'), lblHistoryNote = $('#lblHistoryNote');

  // ä¿å­˜ã‚­ãƒ¼
  const K = { char:'meai_character', hearts:'meai_heart', log:'meai_log', next:'meai_next_due', rewards:'meai_rewards', milestones:'meai_milestones' };

  // çŠ¶æ…‹
  let character = get(K.char);
  let hearts = toInt(get(K.hearts),0);
  let log = toArray(get(K.log),[]);
  let nextTimer=null, labelTimer=null;
  let guard=false;

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function get(k){ try{return localStorage.getItem(k)}catch{return null} }
  function set(k,v){ try{localStorage.setItem(k,v)}catch{} }
  function del(k){ try{localStorage.removeItem(k)}catch{} }
  function toInt(v,d=0){ const n=parseInt(v,10); return Number.isFinite(n)?n:d; }
  function toArray(raw,f=[]){ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return Array.isArray(v)?v:f }catch{ return f } }

  // è¨€èªé©ç”¨
  function applyLang(lang){
    const T = I18N[lang] || I18N.ja;
    document.documentElement.lang = lang;
    titleApp.textContent = T.app;
    titleLead.innerHTML = T.coverLead;
    lblMenuTitle.textContent = T.app;
    lblLead.innerHTML = T.lead;

    btnStart.textContent = T.start;
    btnCont.textContent = T.cont;
    btnAbout.textContent = T.about;
    btnRewardsTitle.textContent = T.rewards;

    lblChoose.textContent = T.choose;

    btnToTitle.textContent = T.toTitle;
    btnShowLog.textContent = T.showLog;
    btnReset.textContent   = T.reset;
    btnSend.textContent    = T.send;
    updateDoneLabel(); // doneãƒœã‚¿ãƒ³ã¯å¾Œã§çŠ¶æ…‹åˆã‚ã›

    lblRewardsTitle.textContent = T.rewardsTitle;
    lblMilestones.textContent   = T.milestones;
    lblStamps.textContent       = T.stamps;
    lblAura.textContent         = T.aura;
    lblAuraNote.textContent     = T.auraNote;
    lblCatalog.textContent      = T.catalog;
    lblHistory.textContent      = T.history;
    lblHistoryNote.textContent  = T.historyNote;

    // ã‚»ãƒ¼ãƒ–è¡¨ç¤º
    if(saveState){
      const has = !!get(K.char);
      saveState.textContent = has ? T.hasSave : T.noSave;
      btnCont.disabled = !has;
    }
  }

  // ãƒãƒ£ãƒƒãƒˆ
  function append(sender,text){
    const d=document.createElement('div');
    d.className='bubble '+sender;
    d.textContent=text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }
  function push(sender,text){
    const item={sender,text,ts:Date.now()};
    log.push(item);
    append(sender,text);
  }
  function saveAll(){
    set(K.hearts,String(hearts));
    set(K.log,JSON.stringify(log));
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆè¨€èªåˆ¥ï¼‰
  function pickRequest(){
    const lang = getLang();
    const T = I18N[lang] || I18N.ja;
    const arr = T.requests || I18N.ja.requests;
    return arr[Math.floor(Math.random()*arr.length)];
  }
  function firstRequest(c){
    const lang = getLang();
    const tone = (I18N[lang]?.tone||I18N.ja.tone)[c] || "";
    return `${tone} ${pickRequest()}`;
  }

  // ===== ã”è¤’ç¾ =====
  const STICKER_POOL = ["â­","ğŸŒ™","ğŸŒˆ","ğŸ’","ğŸ«§","ğŸŒ¸","ğŸ€","ğŸ”¥","â„ï¸","ğŸµ","âœ¨","ğŸ","â˜•","ğŸ“š","ğŸ§¡"];
  const MILESTONES = [
    {n:1,  badge:"ã¯ã˜ã‚ã®ä¸€æ­©", aura:"aura-star"},
    {n:3,  badge:"ã‚³ãƒ„ã‚³ãƒ„åäºº",  aura:null},
    {n:5,  badge:"æ˜Ÿããšé›†ã‚",    aura:"aura-moon"},
    {n:10, badge:"ç¶™ç¶šã®é”äºº",    aura:"aura-rainbow"},
    {n:15, badge:"ã‚„ã•ã—ã•ã®æ³‰",  aura:null},
    {n:20, badge:"MeAI å‹ã ã¡",   aura:"aura-star"}
  ];

  function loadRewards(){
    const r = toObj(get(K.rewards), {stamps:[], badges:[], aurasUnlocked:[], activeAura:""});
    r.stamps ??= []; r.badges ??= []; r.aurasUnlocked ??= []; r.activeAura ??= "";
    return r;
  }
  function saveRewards(r){ set(K.rewards, JSON.stringify(r)); }
  function getGrantedMilestones(){ return toArray(get(K.milestones), []); }
  function setGrantedMilestones(arr){ set(K.milestones, JSON.stringify(arr)); }
  function toObj(raw,f={}){ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return (v && typeof v==='object')?v:f }catch{ return f } }

  function showToast(html){
    rewardToast.innerHTML = html;
    rewardToast.style.display = 'block';
    setTimeout(()=> rewardToast.style.display='none', 3800);
  }
  function confettiBurst(){
    const colors = ['#ff8bd2','#7ed5ff','#ffe07a','#a1ff7a','#ffffff'];
    for(let i=0;i<36;i++){
      const e = document.createElement('div');
      e.className = 'confetti';
      e.style.left = (Math.random()*100)+'vw';
      e.style.background = colors[i%colors.length];
      e.style.animationDuration = (1.8 + Math.random()*1.8) + 's';
      e.style.transform = `rotate(${Math.random()*360}deg)`;
      document.body.appendChild(e);
      setTimeout(()=> e.remove(), 3200);
    }
  }

  function setAuraClass(aura){
    document.body.dataset.aura = aura || '';
  }
  function applyAura(aura){
    setAuraClass(aura);
    const r = loadRewards();
    r.activeAura = aura || "";
    saveRewards(r);
  }

  function grantSticker(){
    const emo = STICKER_POOL[Math.floor(Math.random()*STICKER_POOL.length)];
    const r = loadRewards();
    r.stamps.push({emo, ts: Date.now()});
    saveRewards(r);
    renderRewardsUI();
    showToast(`<span class="ttl">ğŸ</span> <span class="emo">${emo}</span>Get!`);
  }

  function grantMilestoneIfAny(newHearts){
    const granted = new Set(getGrantedMilestones());
    const r = loadRewards();
    let grantedSomething = false;

    MILESTONES.forEach(ms=>{
      if(newHearts >= ms.n && !granted.has(ms.n)){
        granted.add(ms.n);
        r.badges.push({name: ms.badge, n: ms.n, ts: Date.now(), aura: ms.aura||null});
        if(ms.aura && !r.aurasUnlocked.includes(ms.aura)){
          r.aurasUnlocked.push(ms.aura);
          saveRewards(r);
          applyAura(ms.aura);
          renderRewardsUI();
          showToast(`<span class="ttl">#${ms.n}</span> ${ms.badge} + Aura`);
        }else{
          saveRewards(r);
          renderRewardsUI();
          showToast(`<span class="ttl">#${ms.n}</span> ${ms.badge}`);
        }
        grantedSomething = true;
      }
    });

    if(grantedSomething){
      setGrantedMilestones(Array.from(granted));
      confettiBurst();
    }
  }
  function onHeartIncreased(){
    grantSticker();
    grantMilestoneIfAny(hearts);
  }

  function renderCatalog(){
    catalogStamps.innerHTML = '';
    STICKER_POOL.forEach(emo=>{
      const d = document.createElement('div');
      d.className = 'stamp'; d.textContent = emo;
      catalogStamps.appendChild(d);
    });

    catalogBadges.innerHTML = '';
    MILESTONES.forEach(ms=>{
      const row = document.createElement('div');
      row.className = 'list-row';
      const aura = ms.aura ? `<span class="pill mono">${ms.aura.replace('aura-','')}</span>` : '<span style="opacity:.8">ï¼ˆno auraï¼‰</span>';
      row.innerHTML = `<b>#${ms.n} ${ms.badge}</b><span style="opacity:.8">ãƒãƒ¼ãƒˆ${ms.n}å€‹</span> ${aura}`;
      catalogBadges.appendChild(row);
    });
  }

  function renderHistory(){
    const T = I18N[getLang()];
    const r = loadRewards();
    const events = [];
    r.stamps.forEach(s => events.push({type:'stamp', label:`ã‚¹ã‚¿ãƒ³ãƒ— ${s.emo}`, ts:s.ts}));
    r.badges.forEach(b => events.push({type:'badge', label:`ç§°å·ã€Œ${b.name}ã€`, ts:b.ts || 0}));
    events.sort((a,b)=>b.ts-a.ts);
    const latest = events.slice(0, 20);

    rewardHistory.innerHTML = latest.length ? '' : `<div style="opacity:.8">${T.noHistory}</div>`;
    latest.forEach(ev=>{
      const d = new Date(ev.ts||Date.now());
      const time = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const row = document.createElement('div');
      row.className = 'list-row';
      row.innerHTML = `<b>${ev.type==='stamp'?'ğŸ–¼ï¸ ã‚¹ã‚¿ãƒ³ãƒ—':'ğŸ… ç§°å·'}</b><span>${ev.label}</span><span class="mono" style="margin-left:auto;opacity:.8">${time}</span>`;
      rewardHistory.appendChild(row);
    });
  }

  function renderRewardsUI(){
    const r = loadRewards();
    rewardSummary.textContent = `ãƒãƒ¼ãƒˆï¼š${hearts}ã€€ã‚¹ã‚¿ãƒ³ãƒ—ï¼š${r.stamps.length}ã€€ç§°å·ï¼š${r.badges.length}`;

    badgeList.innerHTML = '';
    const fragB = document.createDocumentFragment();
    r.badges.sort((a,b)=>a.n-b.n).forEach(b=>{
      const span = document.createElement('span'); span.className='badge'; span.textContent = `#${b.n} ${b.name}`; fragB.appendChild(span);
    });
    badgeList.appendChild(fragB);

    stampList.innerHTML='';
    const fragS = document.createDocumentFragment();
    r.stamps.slice(-120).forEach(s=>{
      const div = document.createElement('div'); div.className='stamp'; div.textContent = s.emo; fragS.appendChild(div);
    });
    stampList.appendChild(fragS);

    auraList.innerHTML='';
    const auras = [
      {key:'', label:'ãªã—'},
      {key:'aura-star', label:'æ˜Ÿã‚ã‹ã‚Š'},
      {key:'aura-moon', label:'æœˆã‚ã‹ã‚Š'},
      {key:'aura-rainbow', label:'ã«ã˜'}
    ];
    const rNow = loadRewards();
    auras.forEach(a=>{
      const btn = document.createElement('button');
      btn.className='btn';
      btn.style.width='auto'; btn.style.display='inline-block'; btn.style.marginRight='8px';
      const owned = a.key === '' || rNow.aurasUnlocked.includes(a.key);
      btn.disabled = !owned;
      btn.textContent = owned ? (rNow.activeAura===a.key ? `â˜… ${a.label}` : a.label) : `ğŸ”’ ${a.label}`;
      btn.addEventListener('click', ()=>{ if(owned){ applyAura(a.key); renderRewardsUI(); }});
      auraList.appendChild(btn);
    });

    renderCatalog();
    renderHistory();
    setAuraClass(loadRewards().activeAura);
  }

  // ã€Œã‚„ã£ãŸã‚ˆã€ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ 
  function canDoneNow(){ const due = toInt(get(K.next),0); return !due || due<=Date.now(); }
  function setNextAfterHours(h){
    const due = Date.now() + Math.round(h*3600*1000);
    set(K.next,String(due));
    updateDoneState();
    startNextTimer();
    startLabelTimer();
  }
  function updateDoneLabel(){
    const lang = getLang(); const T = I18N[lang];
    if(!btnDone) return;
    if(btnDone.disabled){
      // ãƒ†ã‚­ã‚¹ãƒˆã¯ updateDoneState ã§ä¸Šæ›¸ãã•ã‚Œã‚‹
    }else{
      btnDone.textContent = T.done;
    }
  }
  function updateDoneState(){
    const lang = getLang(); const T = I18N[lang];
    const due = toInt(get(K.next),0);
    const disabled = due && due>Date.now();
    btnDone.disabled = !!disabled;
    if(disabled){
      const left = due-Date.now();
      btnDone.textContent = T.done + "ï¼ˆã‚ã¨" + countdown(left) + "ï¼‰";
    }else{
      btnDone.textContent = T.done;
    }
  }
  function countdown(ms){
    if(ms<=0) return "";
    const s=Math.ceil(ms/1000);
    if(s<60) return `${s}ç§’`;
    const m=Math.ceil(s/60);
    if(m<60) return `${m}åˆ†`;
    const h=Math.floor(m/60), mm=m%60;
    return mm?`${h}æ™‚é–“${mm}åˆ†`:`${h}æ™‚é–“`;
  }
  function startNextTimer(){
    if(nextTimer) clearTimeout(nextTimer);
    const due = toInt(get(K.next),0);
    if(!due) return;
    const wait = due - Date.now();
    if(wait<=0){ push('ai', pickRequest()); del(K.next); updateDoneState(); return; }
    nextTimer = setTimeout(()=>{ del(K.next); updateDoneState(); push('ai', pickRequest()); }, wait);
  }
  function startLabelTimer(){
    if(labelTimer) clearInterval(labelTimer);
    labelTimer = setInterval(()=>{
      updateDoneState();
      const due = toInt(get(K.next),0);
      if(!due || due<=Date.now()){ clearInterval(labelTimer); labelTimer=null; }
    }, 30000);
  }

  // ãƒ¡ã‚¤ãƒ³é–‹å§‹
  function startMain(newSession){
    const lang = getLang(); const T = I18N[lang];
    character = character || get(K.char);
    if(!character){ return showTitle(); }
    const charPath=`public/char/${character}/calm.png`;
    charIcon.src = charPath;
    charIcon.onerror = ()=>{ charIcon.src='public/char/green/calm.png'; };
    heartCountEl.textContent = hearts;
    sessionInfo.textContent = newSession ? T.newSession : T.fromSave;

    chat.innerHTML='';
    if(newSession || log.length===0){
      log = [];
      push('ai', firstRequest(character));
      saveAll();
    }else{
      log.forEach(m=>append(m.sender,m.text));
      chat.scrollTop = chat.scrollHeight;
    }
    show('main');
    setTimeout(()=> input?.focus(), 10);
    updateDoneState();
    startNextTimer();
    startLabelTimer();
    renderRewardsUI();
  }

  // ç”»é¢è¡¨ç¤º
  function showTitle(){
    const lang = getLang(); const T = I18N[lang];
    const has = !!get(K.char);
    if(saveState){
      saveState.textContent = has ? T.hasSave : T.noSave;
    }
    if(btnCont) btnCont.disabled = !has;
    show('title');
  }

  // é€ä¿¡
  function send(){
    const t=input.value.trim();
    if(!t) return;
    push('user',t);
    input.value='';
    push('ai', I18N[getLang()].aiAck);
    saveAll();
  }

  // ====== ãƒã‚¤ãƒ³ãƒ‰ ======
  on(langSelect,'change', ()=> setLang(langSelect.value));
  on(langSelect2,'change', ()=> setLang(langSelect2.value));

  on(btnCoverStart,'click',()=>{
    try{
      if(get(K.char)){ startMain(false); } else { show('choose'); }
    }catch(e){ console.error(e); showTitle(); }
  });

  on(btnStart,'click', ()=> { show('choose'); });
  on(btnCont,'click', ()=>{
    if(!get(K.char)){ alert(I18N[getLang()].noSave); return; }
    startMain(false);
  });
  on(btnAbout,'click', ()=> alert(I18N[getLang()].aboutText));

  const chooseEl = $('#charGrid');
  on(chooseEl,'click',(e)=>{
    const el = e.target.closest('.char');
    if(!el) return;
    character = el.dataset.char;
    set(K.char, character);
    hearts = toInt(get(K.hearts),0);
    log = toArray(get(K.log),[]);
    startMain(true);
  });
  ['charGreen','charBlue','charPink','charPurple'].forEach(id=>{
    const b = document.getElementById(id);
    on(b,'click', (e)=>{ e.stopPropagation(); b?.blur(); });
  });

  on(btnBackTitle,'click', showTitle);
  on(btnToTitle,'click', showTitle);

  on(btnSend,'click', send);
  on(input,'keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

  on(btnDone,'click', ()=>{
    if(guard) return; guard=true; setTimeout(()=>guard=false, 500);
    const T = I18N[getLang()];
    if(!canDoneNow()){
      const due=toInt(get(K.next),0);
      const rest=Math.max(0,due-Date.now());
      alert(`ã‚‚ã†å°‘ã—ä¼‘æ†©â€¦ æ¬¡ã¯ ${countdown(rest)} å¾Œã«ã€Œ${T.done}ã€ã§ãã¾ã™ã€‚`);
      return;
    }
    btnDone.disabled=true; updateDoneState();
    push('user', T.done);
    hearts++; heartCountEl.textContent=hearts;
    push('ai', T.great);
    saveAll();
    onHeartIncreased();
    const h = Math.round((1 + Math.random()*2)*10)/10; // 1.0ã€œ3.0h
    push('ai', T.laterMsg(h));
    setNextAfterHours(h);
  });

  on(btnShowLog,'click', ()=>{
    const text=(log||[]).map(l=>`${new Date(l.ts).toLocaleString()} [${l.sender}] ${l.text}`).join('\n')||'ï¼ˆãƒ­ã‚°ãªã—ï¼‰';
    alert(text);
  });

  function openRewards(){
    renderRewardsUI();
    rewardsModal.style.display='block';
    rewardsWrap.focus();
  }
  on(btnRewardsTitle,'click', openRewards);
  on(btnRewardsMain,'click', openRewards);
  on(closeRewards,'click', ()=>{ rewardsModal.style.display='none'; });
  on(rewardsModal,'click', e=>{ if(e.target===rewardsModal) rewardsModal.style.display='none'; });
  on(window,'keydown', e=>{ if(e.key==='Escape' && rewardsModal.style.display==='block') rewardsModal.style.display='none'; });

  // åˆæœŸ
  try{
    const lang = getLang();
    if(langSelect)  langSelect.value = lang;
    if(langSelect2) langSelect2.value = lang;
    applyLang(lang);
    show('cover');
  }catch(e){
    console.error(e);
    show('title');
  }
})();
</script>
</body>
</html>
