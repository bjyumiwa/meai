<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MeAI Prototype (name-first + personalized + name-reward)</title>
<link rel="icon" href="data:,">
<style>
  html, body { height:100%; }
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    background:#000 url("public/space_background.png") center/cover fixed no-repeat;
    color:#fff;
  }
  .hidden{display:none!important;}
  .glass{ background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.16); border-radius:20px; backdrop-filter:blur(8px); }
  .btn{ display:inline-flex; align-items:center; gap:.5em; border:none; border-radius:999px; padding:12px 18px; cursor:pointer; color:#fff; background:rgba(255,255,255,.18); }
  .btn.primary{ background:linear-gradient(180deg,#ff8bd2,#ff6db3 60%,#ff55a1); color:#231227; }
  .btn:disabled{ opacity:.45; cursor:not-allowed; filter:saturate(.5); }
  .screen{ min-height:100dvh; display:grid; place-items:center; padding:24px; }
  .container{ width:min(92vw, 960px); margin:auto; }
  .cover-card{ text-align:center; padding:28px; border-radius:28px; }
  .cover-illust{ width:180px; height:180px; object-fit:contain; filter:drop-shadow(0 8px 22px rgba(0,0,0,.6)); }
  .cover-title{ font-size:40px; font-weight:800; margin:16px 0 8px; }
  .cover-sub{ opacity:.92; margin:0 0 18px; }
  .grid{ display:flex; flex-wrap:wrap; gap:12px; }
  .char{ width:92px; height:92px; border-radius:50%; border:1px solid rgba(255,255,255,.22); display:grid; place-items:center; background:rgba(255,255,255,.10); cursor:pointer; }
  .char img{ width:70px; height:70px; object-fit:contain; }
  #header{ display:flex; gap:12px; align-items:center; padding:8px 12px; border-radius:999px; margin:10px auto 12px; width:max-content; }
  #chat{ height:min(60vh,460px); overflow:auto; padding:16px; border-radius:16px; }
  .bubble{ max-width:78%; margin:10px 0; padding:12px 16px; border-radius:16px; line-height:1.7; font-size:18px; white-space:pre-wrap; }
  .ai{ background:linear-gradient(145deg, rgba(150,220,255,.28), rgba(150,200,255,.14)); border:1px solid rgba(150,220,255,.34); float:left; clear:both; }
  .user{ background:linear-gradient(145deg, rgba(255,255,255,.26), rgba(255,255,255,.12)); border:1px solid rgba(255,255,255,.28); float:right; clear:both; }
  #composer{ display:flex; gap:8px; margin:10px 0; }
  #input{ flex:1; padding:12px 14px; border:none; border-radius:12px; color:#fff; background:rgba(255,255,255,.14); }
  #footerMenu{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:10px 0 20px; }

  /* モーダル */
  #rewardsModal, #nameModal, #hubModal{
    position:fixed; inset:0; display:none; z-index:1500;
    background: rgba(0,0,0,.45); backdrop-filter: blur(3px);
  }
  .modal-wrap{
    width:min(92vw, 760px); max-height:80vh; overflow:auto;
    background:rgba(15,15,24,.86); border:1px solid rgba(255,255,255,.18);
    border-radius:20px; padding:18px; margin:10vh auto 0; backdrop-filter: blur(10px);
  }

  /* ご褒美UI */
  #rewardToast{ position:fixed; right:16px; bottom:80px; z-index:1300; background:rgba(30,30,40,.85); border:1px solid rgba(255,255,255,.18); padding:12px 14px; border-radius:14px; display:none; max-width:min(80vw,380px); box-shadow:0 10px 30px rgba(0,0,0,.4); backdrop-filter: blur(8px); }
  #rewardToast .ttl{ font-weight:800; margin-bottom:4px; }
  #rewardToast .emo{ font-size:24px; line-height:1; margin-right:6px; }
  .badge{ display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.12); margin:4px; font-size:14px; border:1px solid rgba(255,255,255,.18); }
  .stamps{ display:flex; flex-wrap:wrap; gap:8px; }
  .stamp{ width:44px; height:44px; display:grid; place-items:center; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.18); border-radius:10px; font-size:22px; }
  .list-row{display:flex; gap:10px; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.1);}
  .mono{font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);}

  .langbox{ display:flex; gap:8px; align-items:center; justify-content:center; margin-top:12px; }
  .langbox select{ background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.25); border-radius:10px; padding:6px 10px; font-size:14px; }
</style>
</head>
<body>

<!-- ① 表紙 -->
<section id="cover" class="screen">
  <div class="container">
    <div class="glass cover-card">
      <img class="cover-illust" src="public/miwacchi_open.png" alt="MeAI cover" onerror="this.src='public/cover.png'">
      <div class="cover-title" id="titleApp">MeAI</div>
      <p class="cover-sub" id="titleLead">小さな“やってみる”を、やさしく提案してくれる相棒。</p>
      <button id="coverStart" class="btn primary" type="button">▶︎ スタート</button>
      <div class="langbox">
        <label for="langSelect">🌏</label>
        <select id="langSelect">
          <option value="ja">日本語</option><option value="en">English</option><option value="zh">中文</option><option value="ko">한국어</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- ② 名前入力 -->
<section id="askname" class="screen hidden">
  <div class="container glass" style="padding:20px; max-width:720px;">
    <h2 id="lblAskTitle">あなたのお名前を教えて</h2>
    <p id="lblAskLead" style="opacity:.9">あとで変更もできます。呼びかけに使います。</p>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <input id="userNameInput" class="glass" type="text" placeholder="おなまえ…" style="flex:1; padding:12px 14px; color:#fff;">
      <button id="userNameSave" class="btn primary" type="button">つぎへ</button>
    </div>
    <div style="margin-top:10px;">
      <button id="userNameSkip" class="btn" type="button">スキップ（あとで）</button>
    </div>
  </div>
</section>

<!-- ③ キャラ選択 -->
<section id="choose" class="screen hidden">
  <div class="container glass" style="padding:18px;">
    <h2 style="margin:6px 0 12px;" id="lblChoose">キャラクターを選んでね</h2>
    <div class="grid" id="charGrid">
      <button class="char" data-char="green" type="button"><img src="public/char/green/calm.png" alt=""></button>
      <button class="char" data-char="blue"  type="button"><img src="public/char/blue/calm.png"  alt=""></button>
      <button class="char" data-char="pink"  type="button"><img src="public/char/pink/calm.png"  alt=""></button>
      <button class="char" data-char="purple"type="button"><img src="public/char/purple/calm.png"alt=""></button>
    </div>
    <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="chooseContinue" class="btn" type="button">前のキャラでつづき</button>
    </div>
  </div>
</section>

<!-- ④ メイン -->
<section id="main" class="screen hidden">
  <div class="container">
    <div id="header" class="glass">
      <img id="charIcon" src="" alt="" width="30" height="30">
      <div id="heart">❤️ × <span id="heartCount">0</span></div>
      <div id="charNameBox" style="opacity:.95;"></div>
    </div>

    <div id="chat" class="glass" aria-live="polite"></div>

    <div id="composer">
      <input id="input" class="glass" type="text" placeholder="返答を入力…（Enterで送信）" />
      <button id="send" class="btn" type="button">送信</button>
      <button id="done" class="btn" type="button">やったよ</button>
    </div>

    <div id="footerMenu">
      <button id="toHub" class="btn" type="button">メニューへ</button>
      <button id="showLog" class="btn" type="button">ログを確認</button>
      <button id="rewardsBtn2" class="btn" type="button">ご褒美</button>
      <button id="reset" class="btn" type="button">データ初期化</button>
    </div>
  </div>
</section>

<!-- ご褒美モーダル（略） -->
<div id="rewardsModal" aria-modal="true" role="dialog">
  <div class="modal-wrap" tabindex="-1">
    <button class="btn" id="closeRewards" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">×</button>
    <h3 id="lblRewardsTitle">ご褒美コレクション</h3>
    <div id="rewardSummary" class="mono" style="margin:4px 0 10px;opacity:.9;"></div>
    <h4>スタンプ</h4><div class="stamps" id="stampList"></div>
  </div>
</div>

<!-- キャラ命名モーダル -->
<div id="nameModal" aria-modal="true" role="dialog">
  <div class="modal-wrap" tabindex="-1">
    <button class="btn" id="closeName" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">×</button>
    <h3 id="lblNameTitle">キャラクターの名前</h3>
    <p id="lblNameLead">ご褒美だよ。キャラに名前をつけてみる？（あとで変更OK）</p>
    <div style="display:flex; gap:8px; align-items:center; margin:10px 0;">
      <input id="nameInput" class="glass" type="text" placeholder="なまえ…" style="flex:1; padding:10px 12px; color:#fff;">
      <button id="nameSave" class="btn primary" type="button">保存</button>
    </div>
    <button id="nameSkip" class="btn" type="button">あとで</button>
  </div>
</div>

<!-- ハブ（容姿/記録/続き） -->
<div id="hubModal" aria-modal="true" role="dialog">
  <div class="modal-wrap" tabindex="-1" style="max-width:560px;">
    <button class="btn" id="closeHub" type="button" style="float:right;background:#fff;color:#111;border-radius:10px;">×</button>
    <h3 id="lblHubTitle">どこから再開する？</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <button id="hubAppearance" class="btn" type="button">容姿（ご褒美）</button>
      <button id="hubRecords" class="btn" type="button">記録（ログ）</button>
      <button id="hubContinue" class="btn primary" type="button">そのまま続き</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="rewardToast" role="status" aria-live="polite"></div>

<script>
(function(){
  // ===== i18n =====
  const I18N = {
    ja:{
      app:"MeAI",
      coverLead:"小さな“やってみる”を、やさしく提案してくれる相棒。",
      askTitle:"あなたのお名前を教えて",
      askLead:"あとで変更もできます。呼びかけに使います。",
      choose:"キャラクターを選んでね",
      chooseContinue:"前のキャラでつづき",
      rewardsTitle:"ご褒美コレクション",
      nameTitle:"キャラクターの名前", nameLead:"ご褒美だよ。キャラに名前をつけてみる？（あとで変更OK）",
      hubTitle:"どこから再開する？",
      // フォーマット
      formatSuggest:(userName, req, charName)=> {
        if(charName){
          return `${userName ? userName + "さん、" : ""}${req}\n— ${charName}より`;
        }else{
          return `${userName ? userName + "さん、" : ""}${req}`;
        }
      },
      aiAck:"うん、なるほどね。",
      doneLabel:"やったよ",
      laterMsg:(h)=>`また後でね。約${h}時間後に次の提案を送るね。`,
      requests:[
        "おはようって言って。","コップ一杯のお水を飲んでみて。","5秒だけ、静かに目を閉じてみよう。","今日の空の色をひとことで教えて。",
        "窓を少し開けて、空気を入れ替えよう。","深呼吸を3回してみよう。","好きな音を5秒だけ聞かせて。","花や植物をひとつ思い浮かべて、名前を教えて。",
        "今いる部屋で、やさしい色を探して教えて。","姿勢をすこし伸ばして、肩を回してみよう。","カーテンを少し開けて、明るさを感じてみて。",
        "おやつか飲み物をひと口、味わってみよう。","机の上を10秒だけ整えてみよう。","目の前の“丸い形”をひとつ見つけて教えて。"
      ]
    },
    en:{
      app:"MeAI",
      coverLead:"A gentle buddy that nudges small try-outs.",
      askTitle:"What's your name?",
      askLead:"You can change it later. Used for friendly greetings.",
      choose:"Pick your character",
      chooseContinue:"Continue with previous",
      rewardsTitle:"Rewards Collection",
      nameTitle:"Character name", nameLead:"Reward time! Give your buddy a name? (Change anytime.)",
      hubTitle:"Where to resume?",
      formatSuggest:(userName, req, charName)=> charName ? `${userName?userName+", ":""}${req}\n— from ${charName}` : `${userName?userName+", ":""}${req}`,
      aiAck:"Got it.", doneLabel:"Done",
      laterMsg:(h)=>`See you later in about ${h} hours.`,
      requests:[ "Say good morning to someone.","Drink a glass of water.","Close your eyes for 5 seconds.","Describe today’s sky color.","Open the window a little.","Take 3 deep breaths." ]
    },
    zh:{
      app:"MeAI",
      coverLead:"温柔的小伙伴，轻轻推动你尝试小事。",
      askTitle:"请告诉我你的名字",
      askLead:"之后可更改，用来友好称呼你。",
      choose:"请选择角色",
      chooseContinue:"沿用上次的角色",
      rewardsTitle:"奖励收藏",
      nameTitle:"角色名字", nameLead:"奖励时间！给伙伴起个名字吧（可随时修改）。",
      hubTitle:"从哪里继续？",
      formatSuggest:(userName, req, charName)=> charName ? `${userName?userName+"，":""}${req}\n— ${charName}` : `${userName?userName+"，":""}${req}`,
      aiAck:"明白了。", doneLabel:"完成",
      laterMsg:(h)=>`约 ${h} 小时后再提醒你。`,
      requests:["跟某人说早安。","喝一杯水。","闭眼 5 秒。","用一个词描述今天的天空颜色。","窗户开一点通风。","深呼吸 3 次。"]
    },
    ko:{
      app:"MeAI",
      coverLead:"작은 시도를 살짝 밀어주는 다정한 친구.",
      askTitle:"이름을 알려주세요",
      askLead:"나중에 바꿀 수 있어요. 호칭에 사용합니다.",
      choose:"캐릭터를 선택하세요",
      chooseContinue:"이전 캐릭터로 이어하기",
      rewardsTitle:"보상 컬렉션",
      nameTitle:"캐릭터 이름", nameLead:"보상! 파트너에게 이름을 지어볼까요? (언제든 변경 가능)",
      hubTitle:"어디서 재개할까요?",
      formatSuggest:(userName, req, charName)=> charName ? `${userName?userName+"님, ":""}${req}\n— ${charName} 드림` : `${userName?userName+"님, ":""}${req}`,
      aiAck:"알겠어.", doneLabel:"했어요",
      laterMsg:(h)=>`${h}시간 후에 다시 제안할게요.`,
      requests:["누군가에게 ‘좋은 아침’.","물 한 잔.","눈 5초 감기.","오늘 하늘색 한 단어.","창문 조금 열기.","심호흡 3번."]
    }
  };
  const LS_LANG="meai_lang";
  const K = {
    char:'meai_character',
    hearts:'meai_heart',
    log:'meai_log',
    next:'meai_next_due',
    rewards:'meai_rewards',
    milestones:'meai_milestones',
    name:'meai_char_name',      // キャラ名
    user:'meai_user_name'       // ユーザー名（★新規）
  };

  // ===== DOM util
  const $=(s,root=document)=>root.querySelector(s);
  const on=(el,ev,fn,opt)=>{ if(el) el.addEventListener(ev,fn,opt||false); };
  const t = ()=> I18N[localStorage.getItem(LS_LANG)||"ja"] || I18N.ja;

  // ===== elements
  const langSelect=$('#langSelect');
  const scr={cover:$('#cover'), askname:$('#askname'), choose:$('#choose'), main:$('#main')};
  const userNameInput=$('#userNameInput'), userNameSave=$('#userNameSave'), userNameSkip=$('#userNameSkip');
  const lblAskTitle=$('#lblAskTitle'), lblAskLead=$('#lblAskLead');

  const chooseGrid=$('#charGrid'), chooseContinue=$('#chooseContinue');

  const chat=$('#chat'), input=$('#input'), btnSend=$('#send'), btnDone=$('#done');
  const charIcon=$('#charIcon'), heartCountEl=$('#heartCount'), charNameBox=$('#charNameBox');

  const rewardsModal=$('#rewardsModal'), closeRewards=$('#closeRewards');
  const rewardSummary=$('#rewardSummary'), stampList=$('#stampList');
  const rewardToast=$('#rewardToast');

  const nameModal=$('#nameModal'), nameInput=$('#nameInput'), nameSave=$('#nameSave'), nameSkip=$('#nameSkip'), closeName=$('#closeName');

  const hubModal=$('#hubModal'), closeHub=$('#closeHub'), hubAppearance=$('#hubAppearance'), hubRecords=$('#hubRecords'), hubContinue=$('#hubContinue');

  // ===== state
  let character = get(K.char);
  let hearts    = toInt(get(K.hearts),0);
  let log       = toArray(get(K.log),[]);
  let nextTimer=null, labelTimer=null, guard=false;

  // ===== helpers
  function show(id){ Object.values(scr).forEach(el=>el&&el.classList.add('hidden')); scr[id]?.classList.remove('hidden'); }
  function get(k){ try{return localStorage.getItem(k)}catch{return null} }
  function set(k,v){ try{localStorage.setItem(k,v)}catch{} }
  function del(k){ try{localStorage.removeItem(k)}catch{} }
  function toInt(v,d=0){ const n=parseInt(v,10); return Number.isFinite(n)?n:d; }
  function toArray(raw,f=[]){ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return Array.isArray(v)?v:f }catch{ return f } }

  function applyLang(){
    const T=t();
    $('#titleApp').textContent=T.app;
    $('#titleLead').textContent=T.coverLead;
    $('#lblChoose').textContent=T.choose;
    $('#lblRewardsTitle').textContent=T.rewardsTitle;
    $('#lblNameTitle').textContent=T.nameTitle;
    $('#lblNameLead').textContent=T.nameLead;
    $('#lblHubTitle').textContent=T.hubTitle;
    lblAskTitle.textContent=T.askTitle;
    lblAskLead.textContent=T.askLead;
    chooseContinue.textContent=T.chooseContinue;
    btnDone.textContent=T.doneLabel;
    $('#send').textContent = (T===I18N.ja? "送信": T===I18N.en? "Send": T===I18N.zh? "发送":"보내기");
  }

  // ===== chat + requests with personalization
  function append(sender,text){ const d=document.createElement('div'); d.className='bubble '+sender; d.textContent=text; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
  function push(sender,text){ const item={sender,text,ts:Date.now()}; log.push(item); append(sender,text); saveAll(); }
  function saveAll(){ set(K.hearts,String(hearts)); set(K.log,JSON.stringify(log)); }
  function pickRequest(){ const arr=t().requests; return arr[Math.floor(Math.random()*arr.length)]; }
  function formatSuggest(){ // ユーザー名入り／キャラ署名入り
    const userName = get(K.user)||"";
    const charName = get(K.name)||"";
    const req = pickRequest();
    return t().formatSuggest(userName, req, charName);
  }

  // ===== rewards (最小セット：スタンプのみ表示)
  const STICKER_POOL=["⭐","🌙","🌈","💎","🫧","🌸","🍀","🔥","❄️","🎵","✨","🍎","☕","📚","🧡"];
  function grantSticker(){
    const emo = STICKER_POOL[Math.floor(Math.random()*STICKER_POOL.length)];
    const r = toObj(get(K.rewards), {stamps:[]}); r.stamps??=[];
    r.stamps.push({emo,ts:Date.now()}); set(K.rewards,JSON.stringify(r));
    rewardSummary.textContent = `ハート：${hearts}　スタンプ：${r.stamps.length}`;
    renderStamps(r.stamps); toast(`<span class="emo">${emo}</span>Get!`);
  }
  function toObj(raw,f={}){ try{ const v=typeof raw==='string'?JSON.parse(raw):raw; return (v && typeof v==='object')?v:f }catch{ return f } }
  function renderStamps(list){ stampList.innerHTML=''; list.slice(-100).forEach(s=>{ const d=document.createElement('div'); d.className='stamp'; d.textContent=s.emo; stampList.appendChild(d); }); }
  function toast(html){ rewardToast.innerHTML=html; rewardToast.style.display='block'; setTimeout(()=> rewardToast.style.display='none', 3000); }

  // ===== cooldown for Done
  function canDoneNow(){ const due=toInt(get(K.next),0); return !due||due<=Date.now(); }
  function setNextAfterHours(h){ const due=Date.now()+Math.round(h*3600*1000); set(K.next,String(due)); updateDoneState(); startNextTimer(); startLabelTimer(); }
  function countdown(ms){ if(ms<=0) return ""; const s=Math.ceil(ms/1000); if(s<60) return `${s}秒`; const m=Math.ceil(s/60); if(m<60) return `${m}分`; const h=Math.floor(m/60), mm=m%60; return mm?`${h}時間${mm}分`:`${h}時間`; }
  function updateDoneState(){ const due=toInt(get(K.next),0); const disabled=due && due>Date.now(); btnDone.disabled=!!disabled; btnDone.textContent = disabled ? `${t().doneLabel}（あと${countdown(due-Date.now())}）` : t().doneLabel; }
  function startNextTimer(){ if(nextTimer) clearTimeout(nextTimer); const due=toInt(get(K.next),0); if(!due) return; const wait=due-Date.now(); if(wait<=0){ push('ai', formatSuggest()); del(K.next); updateDoneState(); return; } nextTimer=setTimeout(()=>{ del(K.next); updateDoneState(); push('ai', formatSuggest()); }, wait); }
  function startLabelTimer(){ if(labelTimer) clearInterval(labelTimer); labelTimer=setInterval(()=>{ updateDoneState(); const due=toInt(get(K.next),0); if(!due || due<=Date.now()){ clearInterval(labelTimer); labelTimer=null; } },30000); }

  // ===== character naming reward (3回で解放)
  function maybeAskName(){ const nm=get(K.name); if(!nm && hearts>=3){ openName(); } }
  function openName(){ nameModal.style.display='block'; setTimeout(()=> nameInput?.focus(), 10); }
  function closeNameModal(){ nameModal.style.display='none'; }
  function updateCharNameUI(){ const nm=get(K.name)||""; charNameBox.textContent = nm? `👤 ${nm}`:""; }

  // ===== flow
  function startMain(newSession){
    // アイコン
    const char = get(K.char);
    if(!char){ show('choose'); return; }
    charIcon.src=`public/char/${char}/calm.png`; charIcon.onerror=()=>{ charIcon.src='public/char/green/calm.png'; };
    heartCountEl.textContent=hearts; updateCharNameUI();

    // 初回提案
    chat.innerHTML='';
    if(newSession || log.length===0){ log=[]; push('ai', formatSuggest()); }
    else{ log.forEach(m=>append(m.sender,m.text)); chat.scrollTop=chat.scrollHeight; }

    show('main'); setTimeout(()=> input?.focus(), 10);
    updateDoneState(); startNextTimer(); startLabelTimer();
  }

  // ===== bindings
  on($('#coverStart'),'click', ()=> show('askname')); // ★ まず名前入力へ
  on(langSelect,'change', ()=>{ localStorage.setItem(LS_LANG, langSelect.value); applyLang(); });

  on(userNameSave,'click', ()=>{
    const v=(userNameInput.value||"").trim();
    if(v) set(K.user, v);
    // 次へ：キャラが未選択なら選択へ、あればハブ
    if(get(K.char)) show('choose'); else show('choose');
  });
  on(userNameSkip,'click', ()=>{ if(get(K.char)) show('choose'); else show('choose'); });

  on(chooseGrid,'click', (e)=>{
    const b=e.target.closest('.char'); if(!b) return;
    set(K.char, b.dataset.char);
    startMain(true);
  });
  on(chooseContinue,'click', ()=>{
    if(!get(K.char)){ alert('セーブデータがありません。'); return; }
    startMain(false);
  });

  on(btnSend,'click', ()=>{
    const v=(input.value||"").trim(); if(!v) return;
    push('user', v); input.value='';
    push('ai', t().aiAck);
  });
  on(input,'keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); btnSend.click(); }});

  on(btnDone,'click', ()=>{
    if(guard) return; guard=true; setTimeout(()=>guard=false,500);
    if(!canDoneNow()){
      const rest = Math.max(0, toInt(get(K.next),0)-Date.now());
      alert(`もう少し休憩… 次は ${countdown(rest)} 後に「${t().doneLabel}」できます。`);
      return;
    }
    push('user', t().doneLabel);
    hearts++; heartCountEl.textContent=hearts; saveAll();
    grantSticker();
    maybeAskName();
    const h=Math.round((1+Math.random()*2)*10)/10; // 1.0〜3.0h
    push('ai', t().laterMsg(h));
    setNextAfterHours(h);
  });

  // ご褒美
  on($('#rewardsBtn2'),'click', ()=>{ const r=toObj(get(K.rewards),{stamps:[]}); rewardSummary.textContent=`ハート：${hearts}　スタンプ：${(r.stamps||[]).length}`; renderStamps(r.stamps||[]); rewardsModal.style.display='block'; });
  on(closeRewards,'click', ()=> rewardsModal.style.display='none');
  on(rewardsModal,'click', e=>{ if(e.target===rewardsModal) rewardsModal.style.display='none'; });

  // 命名モーダル
  on(nameSave,'click', ()=>{ const v=(nameInput.value||"").trim(); if(!v) return; set(K.name, v); updateCharNameUI(); push('ai', `これからは「${v}」って呼ぶね。よろしく！`); closeNameModal(); });
  on(nameSkip,'click', closeNameModal);
  on(closeName,'click', closeNameModal);
  on(nameModal,'click', e=>{ if(e.target===nameModal) closeNameModal(); });

  // ハブ（最小）
  on($('#toHub'),'click', ()=> $('#hubModal').style.display='block');
  on(closeHub,'click', ()=> $('#hubModal').style.display='none');
  on(hubContinue,'click', ()=> { $('#hubModal').style.display='none'; push('ai', formatSuggest()); });
  on(hubAppearance,'click', ()=> { $('#hubModal').style.display='none'; const r=toObj(get(K.rewards),{stamps:[]}); rewardSummary.textContent=`ハート：${hearts}　スタンプ：${(r.stamps||[]).length}`; renderStamps(r.stamps||[]); rewardsModal.style.display='block'; });
  on(hubRecords,'click', ()=> { $('#hubModal').style.display='none'; const text=(log||[]).map(l=>`${new Date(l.ts).toLocaleString()} [${l.sender}] ${l.text}`).join('\n')||'（ログなし）'; alert(text); });

  // 初期
  try{
    const lang = localStorage.getItem(LS_LANG)||"ja";
    $('#langSelect').value = lang;
    applyLang();
    show('cover');
  }catch(e){
    console.error(e);
    show('cover');
  }
})();
</script>
</body>
</html>
